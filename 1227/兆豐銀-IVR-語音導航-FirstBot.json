[
    {
        "id": "48554f44c5442a2f7260.950bc6e28b2e",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "tab",
        "label": "FirstBot",
        "in": [],
        "out": [],
        "wires": [],
        "_id": "61c99430f0429988385107fd",
        "breakpoints": [],
        "state": "running"
    },
    {
        "id": "fa6784123d79dd1f7a94.91b8ba05a654",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "chat-server",
        "name": "",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "wires": [],
        "_id": "61c99430f0429962375107fe",
        "breakpoints": []
    },
    {
        "id": "d018095653e232cc3a60.73098f2f7614",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "chat-server",
        "name": "",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "wires": [],
        "_id": "61c99430f04299790e5107ff",
        "breakpoints": []
    },
    {
        "id": "c77a7070ecec6cfcc42a.71bd4f0bf0a4",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "chat-server",
        "name": "",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "wires": [],
        "_id": "61c99430f04299a659510800",
        "breakpoints": []
    },
    {
        "id": "2fbef9b672c0b4afccd4.c2e66806ceec",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "chat-server",
        "name": "",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "wires": [],
        "_id": "61c99430f04299f93c510801",
        "breakpoints": []
    },
    {
        "id": "071d4f168e84c011ba03.6263861acf7b",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "chat-server",
        "name": "",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "wires": [],
        "_id": "61c99430f042993d33510802",
        "breakpoints": []
    },
    {
        "id": "494489c4544c5f250262.6aca946eb8e7",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "chat-server",
        "name": "",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "wires": [],
        "_id": "61c99430f04299e821510803",
        "breakpoints": []
    },
    {
        "id": "789e536345fe03ba8444.04c27994b472",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "router",
        "name": "",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 951,
        "y": 155,
        "wires": [
            [
                "a5849ab5f972673008c1.e6a85f43867b"
            ]
        ],
        "_id": "61c99430f04299e43b510804",
        "breakpoints": [],
        "sessionprop": "systalk._session_id",
        "dryrun": "_dry_run",
        "timeout": "1800"
    },
    {
        "id": "aa99c6a73bd55cf48537.d26d03d98776",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "總機決定（進入子流程）",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3940,
        "y": 1277,
        "wires": [
            []
        ],
        "func": "// 進入子流程\nmsg._to_second_bot = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299446d510805",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "5af7d1b0f9e1ce6bc05e.fa6cff667f73",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Setup for split",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1687,
        "y": 1324,
        "wires": [
            [
                "417a46476479af4694c5.25115afe69d7"
            ],
            [
                "8721a8ea0246a4db62f4.82fa39f88185"
            ]
        ],
        "func": "const ConfigCtrl = msg.systalk.utils.ConfigCtrl;\nlet payload = {};\n\nif (ConfigCtrl.getFAQApi(msg.config.names.firstFAQ)) { // FAQ\n    payload.firstFAQ = msg.payload;\n}\n\nif (msg.systalk.determinationMode !== msg.config.determinationMode.faqOnly) {\n    if (!!ConfigCtrl.getNLUApi(msg.config.names.firstNLU)) {\n        payload.firstNLU = msg.payload; // 總機\n    }\n    // if (!!ConfigCtrl.getNLUApi(msg.config.names.firstNLUSupport)) {\n    //     payload.firstNLUSupport = msg.payload; // 服務台\n    // }\n}\n\nif (typeof msg.payload !== 'string') {\n    msg.error = `payload 需為字串`;\n    return [null, msg];\n} else if (node._.isNil(payload) ||\n    (node._.isNil(payload.firstFAQ) &&\n    node._.isNil(payload.firstNLU))) {\n        \n    msg.error = `缺少設定總機 NLU 或 FAQ 的 API`;\n    return [null, msg];\n}\n\nmsg.payload = payload;\nmsg._beforeRequest = new Date();\nreturn [msg, null];\n",
        "outputs": 2,
        "noerr": 0,
        "_id": "61c99430f04299c10f510806",
        "breakpoints": []
    },
    {
        "id": "e363b140da050403aa16.cca52d18ef61",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "join",
        "name": "",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2916,
        "y": 1317,
        "wires": [
            [
                "8b544df158bfadce4e52.76f0b94d1895"
            ]
        ],
        "_id": "61c99430f0429954cb510807",
        "breakpoints": [],
        "mode": "auto",
        "build": "string",
        "property": "payload",
        "propertyType": "msg",
        "key": "topic",
        "joiner": "\\n",
        "timeout": "",
        "count": ""
    },
    {
        "id": "417a46476479af4694c5.25115afe69d7",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "split",
        "name": "",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1897,
        "y": 1317,
        "wires": [
            [
                "04f8e8512c6b349f980c.89a97bf3ef37"
            ]
        ],
        "_id": "61c99430f042993870510808",
        "breakpoints": [],
        "splt": ""
    },
    {
        "id": "87fb318a1b3b9e5240ac.c198a70c4045",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "服務台反問",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3663.3331604003906,
        "y": 1388.999855041504,
        "wires": [
            []
        ],
        "func": "const ReplyMsgFactory = msg.systalk.utils.ReplyMsgFactory;\nconst ReqChannels = msg.systalk.utils.ReqChannels;\nconst ReqMsgCtrl = msg.systalk.utils.ReqMsgCtrl;\nconst BotUtils = msg.systalk.utils.BotUtils;\nconst ConfigCtrl = msg.systalk.utils.ConfigCtrl;\n\nlet operationIntent = msg.systalk.supportNLUIntent;\n\n// 不結束對話\nmsg._end_dialogue = false;\n\n// 清除聽不懂計數器\nmsg.systalk.cannotRecognizedCounter = 0;\n\nmsg.systalk.requestNLU = true;\ndelete msg.systalk.supportNLUIntent;\n\n// 組機器人回覆牌卡\nmsg.messages = {\n    code: 0,\n    msg: \"成功\",\n    data: {\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: 'bot',\n        content: [\n            {\n                type: 1,\n                text: \"Hi！ 要讓bot協助你嗎\"\n            },\n            {\n                type: 2,\n                cards: [\n                    {\n                        width: \"segment secard horizontal\",\n                        linkList: [\n                            {   \n                                action: 1, \n                                text: \"產品推薦\", \n                                data: \"產品推薦\"\n                            },\n                            {\n                                action: 1, \n                                text: \"產品介紹\", \n                                data: \"產品介紹\"\n                            }\n                        ]\n                    }\n                ]\n            }        \n        ]\n    }\n};\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429934f5510809",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "91ad0c9b658955f9d2cf.24238358c466",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "Error",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3283,
        "y": 1350,
        "wires": [
            []
        ],
        "func": "\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299263751080a",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "db30791425e2d89b63c8.15e5bb4af38d",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "http in",
        "name": "",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 231,
        "y": 155,
        "wires": [
            [
                "3e165cfc7a7c5debdb30.848946cfd85f",
                "865154a3e3daa68167da.388871e122d1"
            ]
        ],
        "_id": "61c99430f04299a64951080b",
        "breakpoints": [],
        "url": "/",
        "method": "post",
        "swaggerDoc": ""
    },
    {
        "id": "a434e2c3c3fe137622cd.c12b78358fdd",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "http response",
        "name": "Http Out",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1341,
        "y": 155,
        "wires": [],
        "_id": "61c99430f04299a50151080c",
        "breakpoints": []
    },
    {
        "id": "303ed353898c7878f595.728dfa0c5764",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "Setup",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 192,
        "y": 443,
        "wires": [
            [
                "c5aa04c07a1bf1990454.d9711ee37624"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f042996a7a51080d",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_start_setup"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "76a97f53cef4ed01d896.c3ac5d71b317",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "Before Output",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "true",
        "x": 1350,
        "y": 110,
        "wires": [],
        "_id": "61c99430f042997ba951080e",
        "breakpoints": []
    },
    {
        "id": "eb792b5bee048cc93229.ecf49ebfaaf7",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "Know botType",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 732,
        "y": 1737,
        "wires": [
            [
                "19dca68da7d28552eebe.d3ab499a6eba"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f042998c5151080f",
        "breakpoints": [],
        "rules": [
            {
                "t": "nnull",
                "p": "botType"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#start"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#mrcpError"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#error"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#wait"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#noInputTimeout"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#disconnect"
            },
            {
                "t": "neq",
                "p": "reqMsg.message",
                "v": "#noInputTimeout"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "cdf469cfa6d68684a00a.2a91f3fd66b5",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "變更你的設定",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "設定於 `msg.config` 物件中  \n\n- `msg.config.botType` 目前流程名稱 (`'firstBot')\n- `msg.config.bots` 定義串接 Flow Api  \n  ```javascript\n  {\n    \"<NAME>\": \"<API>\", // \"<NAME>\" 須對應於組總機的服務意圖名稱\n    \"天氣\": \"http://path.to.weather.flow/\"\n  }\n  ```\n  可使用 `msg.systalk.utils.ConfigCtrl.getBotApi(name)` 方法取得 API\n\n- `msg.config.apis` 定義目前流程中使用到的 NLU, FAQ 與其他 API  \n  ```javascript\n  {\n    nlu: {\n      \"<NAME>\": \"<API>\",\n      \"總機\": \"http://path.to.firstbot.nlu\"\n    },\n    faq: {\n      \"<NAME>\": \"<API>\"\n    }\n  }\n  ```\n  NLU Api 可透過 `msg.systalk.utils.ConfigCtrl.getNLUApi(name)` 取得  \n  FAQ Api 可透過 `msg.systalk.utils.ConfigCtrl.getFAQApi(name)` 取得\n\n- `msg.config.threshold` 定義 NLU/FAQ 門檻值  \n  ```javascript\n  {\n    nlu: {\n      \"<NAME>\": <VALUE>,\n      \"總機\": 0.65\n    },\n    faq: {\n      \"<NAME>\": <VALUE>,\n      \"FAQ\": 0.7\n    }\n  }\n  ```\n  可分別透過 `msg.systalk.utils.ConfigCtrl.getNLUThreshold(name)` 與  \n  `msg.systalk.utils.ConfigCtrl.getFAQThreshold(name)` 取得\n  \n- `msg.config.secondThreshold` 定義 NLU/FAQ 次門檻值，可省略  \n  _(在 \"Determine\", \"Set analysis\" 與 \"Set Report stats\" 節點中使用到)_  \n  ```javascript\n  {\n    nlu: {\n      \"<NAME>\": <VALUE>,\n      \"總機\": 0.55\n    },\n    faq: {\n      \"<NAME>\": <VALUE>,\n      \"FAQ\": 0.6\n    }\n  }\n  ```\n  可分別透過 `msg.systalk.utils.ConfigCtrl.getNLUSecondThreshold(name)` 與  \n  `msg.systalk.utils.ConfigCtrl.getFAQSecondThreshold(name)` 取得  \n  或，使用 `getNLUMinorThreshold(name)` 與 `getFAQMinorThreshold(name)`\n\n- `msg.config.faqMaxResultSize` 定義 FAQ 答案取得數量  \n  _(未設定，預設為 `3`)_\n\n\n- `msg.config.intentsMap` 定義三維意圖表，供服務台查找  \n  ```javascript\n  {\n    \"<SERVICE>\": {\n      \"<OPERATION>\": [ \"<ITEM>\" ]\n    },\n    \"天氣\": {\n      \"查詢\": [],\n      \"其他\": []\n    }\n  }\n  ```\n  可透過 `msg.systalk.utils.ConfigCtrl.serviceHasOperationAndItem(service, operation, item)` 判斷  \n  `service` 是否有 `operation` 或 `item` (僅設定其一參數)，或有 `item` 的 `operation` (兩者皆有設定)\n",
        "in": [],
        "out": [],
        "x": 574,
        "y": 403,
        "wires": [],
        "_id": "61c99430f0429913b7510810",
        "breakpoints": []
    },
    {
        "id": "3e165cfc7a7c5debdb30.848946cfd85f",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Set from Input",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 741,
        "y": 155,
        "wires": [
            [
                "789e536345fe03ba8444.04c27994b472",
                "28ab7349204966c6227f.32debc0ada94"
            ]
        ],
        "func": "// Specified session id\nmsg.systalk._session_id = msg.payload.sessionId;\n\nmsg.systalk.chatwebId = msg.payload.chatwebId;\n\n// Request Message Object\nmsg.reqMsg = msg.payload;\n\nmsg.reqMsg.message = node._.clone(msg.payload.msg) || node._.clone(msg.payload.message);\n\nif (typeof msg.reqMsg.message === 'string') {\n    // 將文字邊界的 '\\' 代換成 ''\n    msg.reqMsg.message = msg.reqMsg.message.replace(/^\\\\b/g, '');\n}\n\n// msg.reqMsg.param = { traceTag: 'Voice' };\n// msg.reqMsg.channel = msg.payload.channel || 'ChatWeb';\n\n// 解析內線電話傳入格式, ex: \"3003%20%20%20cor%2019\"\nif (/%\\d{2}/.test(msg.reqMsg.tel)) {\n    msg.reqMsg.tel = decodeURIComponent(msg.reqMsg.tel).split(/\\s/)[0];\n}\nif (/%\\d{2}/.test(msg.reqMsg.customerId)) {\n    msg.reqMsg.customerId = decodeURIComponent(msg.reqMsg.customerId).split(/\\s/)[0];\n}\n// ---\n\nmsg.reqMsg.customerId = msg.reqMsg.tel || msg.reqMsg.customerId;\n\n// TODO: 測試用\nif (msg.reqMsg.message === '#wait') {\n    msg.reqMsg.action = '#wait';\n}\n//-----\n\n/**\n * 賽微會將語音辨識各種可能組合，合併語句\n * 若為賽微加強語音辨識模型，不切分語句\n * - #Doctormodel\n * - #IDModel\n */\nswitch (msg.reqMsg.domain) {\n    // case '#doctorName':\n    //     break;\n    case '#id':\n        break;\n    default:\n        if (typeof msg.reqMsg.message === 'string') {\n            msg.reqMsg.message = msg.reqMsg.message.split(/\\s*[,，]\\s*/).filter(x => !!x)[0];\n        }\n        break;\n}\n\n// NOTE: session log 使用 `msg` 欄位，語音輸入，使用 `message` 欄位\nmsg.reqMsg.msg = msg.reqMsg.message;\nmsg.messages = {};\nmsg._start_setup = true;\nmsg.receivedAt = node.moment().utcOffset(8, false).format('YYYYMMDDHHmmss');\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429906bc510811",
        "breakpoints": []
    },
    {
        "id": "fa8e792b7a4583a4a992.f04589abfc5d",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Determine",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3466,
        "y": 1310,
        "wires": [
            [
                "5bd5c998.46ccc8",
                "5032bcc8.440c54"
            ],
            [
                "135849a2be645af5379e.7aa51c0a3767",
                "19517a2555f9267b6874.601c016541a0"
            ],
            [
                "aa99c6a73bd55cf48537.d26d03d98776"
            ],
            [
                "59c7394b8764023a5065.d40475c6fe9b"
            ],
            [
                "bcf98b9dd7433cbd8459.34e804d74326"
            ],
            [
                "87fb318a1b3b9e5240ac.c198a70c4045"
            ],
            [
                "d77152908a968df4ce3e.2e6df260719a",
                "042f7c174f21edbab9bb.8006fa3a9c05"
            ],
            [
                "4cc98f8d4794213f5741.7a8a103af56f"
            ],
            [
                "ac95b1bb06d631edbd43.71e66204c29e"
            ],
            [
                "814d3cb2cdc64f3cc878.0774d7243b32"
            ]
        ],
        "func": "const BotUtils = msg.systalk.utils.BotUtils;\nconst QueueUtils = msg.systalk.utils.QueueUtils;\nconst ConfigCtrl = msg.systalk.utils.ConfigCtrl;\n\nconst MsgUtils = msg.systalk.utils.MsgUtils;\nconst numOfOuts = 10;\nconst nextNode = {\n    notUnderstand: 1,\n    isChangeBot: 2,\n    toSecondBot: 3,\n    endFlow: 4,\n    startFlow: 5,\n    reAsk: 6,\n    toFAQ: 7,\n    toAngent: 8,\n    suggest: 9,\n    repeat: 10\n};\n\nconst lang = msg.systalk.lang;\n\n// 取得NLU, FAQ 結果\nconst faq = msg.firstFAQ;\n// const firstNLUSupport = msg.firstNLUSupport;\nconst firstNLU = msg.firstNLU;\n\n// 取得原點值(fallbackScore),\nconst firstNLUFallbackScore = ConfigCtrl.getFallbackScore(msg.config.names.firstNLU);\n// const firstNLUSupportFallbackScore = ConfigCtrl.getFallbackScore(msg.config.names.firstNLUSupport);\n\n// 取得 threshold\nconst nluThreshold = msg.systalk.passToSecondBot ? msg.config.higherNLUThreshold :ConfigCtrl.getNLUThreshold(msg.config.names.firstNLU);\nconst nluSecondThreshold = ConfigCtrl.getNLUSecondThreshold(msg.config.names.firstNLU);\n// const supportNLUThreshold = ConfigCtrl.getNLUThreshold(msg.config.names.firstNLUSupport);\nconst faqThreshold = msg.systalk.passToSecondBot ?\n    msg.config.higherFAQThreshold :\n    ConfigCtrl.getFAQThreshold(msg.config.names.firstFAQ);\nconst faqSecondThreshold = ConfigCtrl.getFAQSecondThreshold(msg.config.names.firstFAQ);\n\nmsg.botEntities = firstNLU && Array.isArray(firstNLU.entities) ? firstNLU.entities : [];\n\nconst faqRedirectCategoryRegex = msg.config.regexes.faqRedirectCategory || /NLU(@([^@]+))(@([^@]+))?(@([^@]+))?/;\n\nlet faqReturns = null;\nlet nluReturns = null;\nlet nextFaqState = null;\nlet isNextFaqRootOrNonLevel = false;\nlet redirectToSecondBot = false;\nlet isSuggestedFAQ = false; // FAQ 選擇答案是否為建議答案(達次門檻值)\nlet isSuggestedNLU = false; // 總機NLU 是否有建議的服務意圖(達次門檻值)\n\nmsg.isSuggestedFAQ = isSuggestedFAQ;\nmsg.isSuggestedNLU = isSuggestedNLU;\n\n// FAQ 處理\nif (faq && faq.results && faq.results.length) {\n    let validResults        = faq.results.filter(item => item.score >= faqThreshold);\n    let stateOfValidResults = validResults.map(item => BotUtils.getFaqAnsState(item, msg.systalk.faqState))\n        .filter(state => state.isValidState);\n    let candidates = faq.results.filter(item => {\n        return (\n            item.score < faqThreshold &&\n            (node._.isNumber(faqSecondThreshold) &&\n            item.score >= faqSecondThreshold)\n        );\n    });\n    let stateOfCandidates   = candidates.map(item => BotUtils.getFaqAnsState(item, msg.systalk.faqState))\n        .filter(state => state.isValidState);\n        \n    if (!stateOfValidResults.length && !stateOfCandidates.length)\n        msg.systalk.faqState = null;\n    if (!stateOfValidResults.length && !!stateOfCandidates.length) {\n        isSuggestedFAQ = true;\n    }\n    \n    // 若第一個明確對應到的 FAQ 結果，表示要導向 NLU\n    // 設定導向，並要將 FAQ 回答帶過去\n    // (second bot 僅回應 FAQ 回答，並擷取 entity)\n    if (stateOfValidResults.length && isFaqRedirectToNlu(stateOfValidResults[0].originalAns)) {\n        redirectToSecondBot = setFaqRedirectNlu(stateOfValidResults[0].originalAns);\n    }\n    if (!redirectToSecondBot) {\n        let lastFaqState = msg.systalk.faqState;\n        let statesOfResults = isSuggestedFAQ ? stateOfCandidates : stateOfValidResults;\n        \n        let nonLevelState = statesOfResults.find(someState => someState.isNonLevelState);\n        let rootState = statesOfResults.find(someState => someState.isRootState);\n        let descendantState = statesOfResults.find(someState => someState.isDescendantState);\n        let siblingState = statesOfResults.find(someState => someState.isSiblingState);\n        \n        if (lastFaqState) {\n            \n            nextFaqState = descendantState || siblingState ||\n                (rootState && nonLevelState ?\n                 rootState.score >= nonLevelState.score ? rootState : nonLevelState :\n                 rootState || nonLevelState);\n            isNextFaqRootOrNonLevel = !descendantState && !siblingState;\n        }\n        else {\n            // 若同時有 rootState（group） 或 nonLevelState，比分數，再以 rootState 優先\n            nextFaqState = rootState && nonLevelState ?\n                rootState.score >= nonLevelState.score ? rootState : nonLevelState :\n                rootState || nonLevelState;\n            isNextFaqRootOrNonLevel = true;\n        }\n        if (nextFaqState) {\n            msg.FAQ = node._.cloneDeep(nextFaqState.originalAns);\n            if (isSuggestedFAQ) {\n                msg.isSuggestedFAQ = true;\n                // 取得推薦 FAQ 問法\n                const rootOrNonLevels = statesOfResults.filter(someState => {\n                    return (someState.states.some(item => item.index === 1) ||\n                        (!someState.states || !someState.states.length));\n                });\n                msg.suggestedFAQQuestions = [].concat(rootOrNonLevels.map(x => x.originalAns.orig_question));\n            }\n            else {\n              faqReturns = MsgUtils.output(msg, nextNode.toFAQ, numOfOuts);  \n            }\n        }\n    }\n}\n\nconst faqDecided = faqReturns; // && !msg.systalk.requestNLU;\n\n// 總機有辨識到 \"重聽\" entity\nif (!redirectToSecondBot &&\n    !faqDecided &&\n    firstNLU &&\n    Array.isArray(firstNLU.entities) &&\n    firstNLU.entities.some(x => x.entity === msg.config.entities.resend)) {\n    \n    nluReturns = MsgUtils.output(msg, nextNode.repeat, numOfOuts);\n} else {\n    msg.systalk.resendCounter = 0;\n}\n\n// 總機可辨識業務\nif (!redirectToSecondBot &&\n    !faqDecided &&\n    firstNLU && firstNLU.intents && firstNLU.intents.length &&\n    firstNLU.intents[0].score !== firstNLUFallbackScore &&\n    !nluReturns) {\n\n    if (firstNLU.intents[0].score >= nluThreshold) {\n        // Quit\n        if (firstNLU.intents[0].intent === msg.config.intents.quit) {\n            \n            if (msg.botType === msg.config.botType) {\n                nluReturns = nluReturns || MsgUtils.output(msg, nextNode.endFlow, numOfOuts);\n            }\n            \n            msg.reqQuit = true;\n            node.log(`=== To Quit (${msg.botType}) ===`);\n            nluReturns = nluReturns || MsgUtils.output(msg, nextNode.toSecondBot, numOfOuts);\n        } else if (firstNLU.intents[0].intent === msg.config.intents.end) {\n            QueueUtils.clear(msg.systalk.pendingBotQueue);\n            nluReturns = nluReturns || MsgUtils.output(msg, nextNode.endFlow, numOfOuts);\n        } else if (msg.config.intents.toAgent.find(text => firstNLU.intents[0].intent.includes(text))) {\n            nluReturns = nluReturns || MsgUtils.output(msg, nextNode.toAngent, numOfOuts);\n        } else {\n            // 決定 second bot\n            const gotBotType = msg.firstNLU.intents[0].intent;\n            const gotBot = ConfigCtrl.getBotApi(gotBotType);\n            msg.botType = gotBotType;\n            \n            QueueUtils.push(msg.systalk.pendingBotQueue, gotBotType);\n            nluReturns = nluReturns || MsgUtils.output(msg, nextNode.isChangeBot, numOfOuts);\n        }\n    } else if (node._.isNumber(nluSecondThreshold) && firstNLU.intents.some(x => x.score >= nluSecondThreshold)) {\n        isSuggestedNLU = true;\n        msg.isSuggestedNLU = true;\n        msg.suggestedNLUIntents = firstNLU.intents.filter(x => x.score >= nluSecondThreshold).map(x => x.intent);\n    }\n}\n\n// 總機不知道，服務台辨識出的操作（與項目），目前所在流程沒有，要反問\n// if (!redirectToSecondBot &&\n//     !faqDecided &&\n//     !nluReturns) {\n//     if (firstNLUSupport && firstNLUSupport.intents && firstNLUSupport.intents.length &&\n//         firstNLUSupport.intents[0].score !== firstNLUSupportFallbackScore) {\n            \n//         if (firstNLUSupport.intents[0].score >= supportNLUThreshold) {\n//             let supportNLUIntent = firstNLUSupport.intents[0].intent;\n//             let operationAndItem = supportNLUIntent.split('-');\n//             let operation = operationAndItem[0];\n//             let item = operationAndItem[1];\n            \n//             let validForLastService = ConfigCtrl.serviceHasOperationAndItem(QueueUtils.last(msg.systalk.pendingBotQueue), operation, item);\n//             let validForLastBeforeService = ConfigCtrl.serviceHasOperationAndItem(QueueUtils.getFromLast(msg.systalk.pendingBotQueue, 1), operation, item);\n            \n//             // 帶出服務台辨識的操作（與項目）意圖\n//             let pendingIntent = { operation: operationAndItem[0], item: operationAndItem[1] ? operationAndItem[1] : null };\n//             msg.systalk.supportNLUIntent = supportNLUIntent;\n//             msg.systalk.pendingIntent = node._.cloneDeep(pendingIntent);\n            \n//             // 若上次與上上次的流程，沒有此操作，反問\n//             if (!validForLastService && !validForLastBeforeService) {\n//                 nluReturns = nluReturns || MsgUtils.output(msg, nextNode.reAsk, numOfOuts);\n//             }\n//             else if (validForLastService) { // 繼續進入上次的流程\n//                 msg.systalk.pendingIntent = node._.cloneDeep(pendingIntent);\n//                 nluReturns = nluReturns || MsgUtils.output(msg, nextNode.toSecondBot, numOfOuts);\n//             }\n//             else if (validForLastBeforeService) { // 要切換到上上次的流程\n//                 msg.botType = QueueUtils.getFromLast(msg.systalk.pendingBotQueue, 1);\n//                 msg.systalk.pendingIntent = node._.cloneDeep(pendingIntent);\n//                 QueueUtils.push(msg.systalk.pendingBotQueue, msg.botType);\n//             }\n//         }\n//     }\n// }\n\n// 若總機聽不懂，服務台聽不懂，但有建議 FAQ 或建議的 NLU 意圖\nif (!faqDecided && !nluReturns && ((msg.isSuggestedFAQ && !!msg.FAQ) || (msg.isSuggestedNLU && !!msg.suggestedNLUIntent))) {\n    return MsgUtils.output(msg, nextNode.suggest, numOfOuts);\n}\n\n// 總機不知道，但流程上記錄著上次未結束的 bot\nif (!faqDecided && !nluReturns) {\n    if (msg.botType !== msg.config.botType) {\n        nluReturns = nluReturns || MsgUtils.output(msg, nextNode.toSecondBot, numOfOuts);\n    }\n}\n\n// 即使 NLU 都不知道，需要 requestNLU != true，才能採用 FAQ\nif (faqDecided) {\n    msg.systalk.faqState = nextFaqState;\n    msg.systalk.requestNLU = null;\n    delete msg.systalk.requestNLU;\n    return faqReturns;\n}\n\nif (nluReturns) {\n    msg.systalk.requestNLU = null;\n    msg.systalk.faqState = null;\n    delete msg.systalk.requestNLU;\n    delete msg.systalk.faqState;\n    return nluReturns;\n}\n\n// 都不知道, Fallback\nif (msg.botType === msg.config.botType)\n    return MsgUtils.output(msg, nextNode.notUnderstand, numOfOuts);\nelse\n    return MsgUtils.output(msg, nextNode.toSecondBot, numOfOuts);\n\n/**\n * 該 FAQ 答案是否為指定導向到 NLU\n * @param result FAQ 單項結果\n */\nfunction isFaqRedirectToNlu(result) {\n    if (Array.isArray(result.categories) && result.categories.length) {\n        let found = result.categories.some(item => faqRedirectCategoryRegex.test(item));\n        return found;\n    }\n    return false;\n}\n\n/**\n * 設定 FAQ 需導向 NLU 情形\n * @param ans FAQ 結果\n */\nfunction setFaqRedirectNlu(result) {\n\n    let category = result.categories.find(item => faqRedirectCategoryRegex.test(item));\n    if (!category) {\n        return false;\n    }\n    \n    let ans = result.answer;\n    let prependingMsgs = BotUtils.faqAnsToMessages(ans);\n    if (Array.isArray(prependingMsgs) && prependingMsgs.length) {\n        msg.systalk.prependingMessages = [].concat(prependingMsgs);\n    }\n    \n    let nluIntentTokens = faqRedirectCategoryRegex.exec(category);\n    const serviceIntent = nluIntentTokens[2];\n    const operationIntent = nluIntentTokens[4] || undefined;\n    const itemIntent = nluIntentTokens[6] || undefined;\n    // node.log(operationIntent);\n    // service\n    let gotBot = ConfigCtrl.getBotApi(serviceIntent);\n    msg.botType = serviceIntent;\n    QueueUtils.push(msg.systalk.pendingBotQueue, serviceIntent);\n    // operation & item\n    if (operationIntent) {\n        msg.botIntent = {\n            operation: operationIntent\n        };\n        if (itemIntent) {\n            msg.botIntent.item = itemIntent;\n        }\n    }\n    return true;\n}\n",
        "outputs": 10,
        "noerr": 0,
        "_id": "61c99430f0429994d5510812",
        "breakpoints": []
    },
    {
        "id": "19dca68da7d28552eebe.d3ab499a6eba",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Message Type",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 972,
        "y": 1737,
        "wires": [
            [
                "945801ff09e3ee5fd6bc.f7fc70f91e68"
            ],
            [
                "df28fa613ebbd3210902.807fbf7830dc"
            ],
            [
                "8b3169eeedf5b453fc37.20c17471fee6"
            ],
            [
                "8e23490f15234dcad6ad.93099c727817"
            ]
        ],
        "func": "const ReqMsgCtrl = msg.systalk.utils.ReqMsgCtrl;\nconst MsgUtils = msg.systalk.utils.MsgUtils;\nconst numOfOuts = 4;\n\n// TODO: 測試後刪除\nmsg.systalk.testMusic = undefined;\n\n// 只要使用者有輸入，則設定 text 讓後續可以寫入 DB 裡\nmsg.text = 'empty input';\n\n// 判斷 chatweb request type\nswitch (msg.reqMsg.type) {\n    // 一般使用者文字訊息\n    case 'customerMsg':\n        // 若意圖轉真人\n        // if (msg.config.intents.toAgent.find(text => msg.reqMsg.msg.includes(text))) {\n        //     return MsgUtils.output(msg, 3, numOfOuts);\n        // }\n        \n        // 若尚未進到服務流程\n        // if (!msg.systalk.service) {\n        //     // 若已有轉真人計次兩次\n        //     if (msg.systalk.toAngentCounter === 2) {\n        //         // 若比對到使用者隨回答隨意\n        //         if (msg.config.casualWords.includes(msg.reqMsg.msg)) {\n        //             return MsgUtils.output(msg, 5, numOfOuts);\n        //         }\n        //     }\n        //     if (msg.reqMsg.msg.includes('ENGLISH')) {\n        //         return MsgUtils.output(msg, 3, numOfOuts);\n        //     } else if (msg.reqMsg.msg.includes('信用卡')) {\n        //         return MsgUtils.output(msg, 5, numOfOuts);\n        //     } else if (msg.reqMsg.msg.includes('銀行')) {\n        //         return MsgUtils.output(msg, 4, numOfOuts);\n        //     } else {\n        //     // 進入聽不懂流程\n        //         return MsgUtils.output(msg, 7, numOfOuts);\n        //     }\n        // }\n        \n        // \n        let content = msg.reqMsg.msg;\n        if (content && Object.values(msg.config.tags).includes(content.trim().toLowerCase())) {\n            return MsgUtils.output(msg, 2, numOfOuts);\n        }\n        \n        return MsgUtils.output(msg, 1, numOfOuts);\n    // 非一般使用者文字訊息\n    default:\n        return MsgUtils.output(msg, 4, numOfOuts);\n}\n",
        "outputs": 4,
        "noerr": 0,
        "_id": "61c99430f04299fd70510813",
        "breakpoints": []
    },
    {
        "id": "44aa4bc2e377c638ce29.dcbf8b382127",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "非文字訊息",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "非文字訓訊息，不應進入 NLU。",
        "in": [],
        "out": [],
        "x": 1202.6666412353516,
        "y": 1783.0000076293945,
        "wires": [],
        "_id": "61c99430f042993e32510814",
        "breakpoints": []
    },
    {
        "id": "a5849ab5f972673008c1.e6a85f43867b",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Response",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1151,
        "y": 155,
        "wires": [
            [
                "76a97f53cef4ed01d896.c3ac5d71b317",
                "a434e2c3c3fe137622cd.c12b78358fdd"
            ]
        ],
        "func": "\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429944c7510815",
        "breakpoints": []
    },
    {
        "id": "ebd3ae52e157023e17b5.1758d41801c8",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "文字（語音轉文字）",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "對於文字訊息，才需要透過 NLU 判斷。",
        "in": [],
        "out": [],
        "x": 1487.3333129882812,
        "y": 1284.0000534057617,
        "wires": [],
        "_id": "61c99430f04299d755510816",
        "breakpoints": []
    },
    {
        "id": "59c7394b8764023a5065.d40475c6fe9b",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "進入結束",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3663.666736602783,
        "y": 1305.3332233428955,
        "wires": [
            []
        ],
        "func": "// 進入到結束流程\nmsg._from_end = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042994e97510817",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "bcf98b9dd7433cbd8459.34e804d74326",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "進入招呼",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3663.000068664551,
        "y": 1347.0000667572021,
        "wires": [
            []
        ],
        "func": "// 進入招呼語流程\nmsg._from_start = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042999949510818",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "2e51cd541c219af16275.68d5bc8951ea",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Setup Data",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1808,
        "y": 436,
        "wires": [
            [
                "6acf70591486671c2b25.25c3cb53f8d1",
                "71426342f7448fccef3c.664d6d4c5c98"
            ]
        ],
        "func": "const BotUtils = msg.systalk.utils.BotUtils;\nconst QueueUtils = msg.systalk.utils.QueueUtils;\nconst ReqMsgCtrl = msg.systalk.utils.ReqMsgCtrl;\nconst LangCtrl = msg.systalk.utils.LangCtrl;\nconst ReqChannels = msg.systalk.utils.ReqChannels;\nconst ConfigCtrl = msg.systalk.utils.ConfigCtrl;\n\n// normalize request message\n// ReqMsgCtrl.normalize(msg.reqMsg);\n\nif (ReqMsgCtrl.isInitSession(msg.reqMsg)) {\n    BotUtils.resetSessionStats();\n}\n\n// 進線 channel\nmsg.systalk.channel = node._.clone(msg.reqMsg.channel || ReqChannels.text);\n// 使用者語系\nmsg.systalk.lang = LangCtrl.normalize(msg.reqMsg.lang || msg.systalk.lang || 'zh-tw');\n\n// 傳入 second bot，second bot 判斷與先前若不相同，表示新對話，需重設其已紀錄的資訊\nmsg.systalk.sessionSalt = msg.systalk.sessionSalt || BotUtils.generateSalt();\nmsg.systalk.fromBot = msg.config.botType;\n\nmsg.systalk.pendingBotQueue = Array.isArray(msg.systalk.pendingBotQueue) && msg.systalk.pendingBotQueue.length\n    ? msg.systalk.pendingBotQueue\n    : [ msg.config.botType ];\n\n// define calling second bot's type\nmsg.botType = msg.reqMsg.botType || QueueUtils.last(msg.systalk.pendingBotQueue) || null; \nmsg.botIntent = msg.reqMsg.intent || msg.systalk.pendingIntent || null;\nmsg.botEntities = msg.reqMsg.entities || msg.systalk.pendingEntities || null;\n\nmsg.systalk.faqState = msg.systalk.faqState || null;\nmsg.systalk.resendCounter = msg.systalk.resendCounter || 0;\n\n// 設定計算聽不懂次數\nmsg.systalk.cannotRecognizedCounter = msg.systalk.cannotRecognizedCounter || 0;\n\n// 設定命中轉真人意圖次數\nmsg.systalk.toAngentCounter = msg.systalk.toAngentCounter || 0;\n\nmsg.systalk.stored = msg.systalk.stored || {\n    userData: {\n        tel: msg.reqMsg.tel || null,\n        idNumber: null,\n        birth: null,\n        isValidId: null,\n        customerId: msg.reqMsg.tel || 'webTest',\n        // traceTag: msg.reqMsg.param.traceTag\n    }\n};\n\n// 暫存轉真人的實體\nif (!msg.systalk.toAgentEntities) {\n    msg.systalk.toAgentEntities = [];\n}\n\n// 暫存的身份資訊\nmsg.systalk.identity = msg.systalk.identity || null;\nif (msg.systalk.waitForAuth && msg.reqMsg.message.identity) {\n    msg.systalk.identity = msg.reqMsg.message.identity;\n    msg.systalk.waitForAuth = null;\n}\n\n// 暫存的定位資訊\nmsg.systalk.location = msg.systalk.location || null;\nif (msg.systalk.waitForLocated && msg.reqMsg.message.location) {\n    msg.systalk.location = msg.reqMsg.message.location;\n    msg.systalk.waitForLocated = null;\n}\n\n// 設定值\nmsg.systalk.defaultConfig = msg.systalk.defaultConfig || {\n    faqApi: ConfigCtrl.getFAQApi(msg.config.names.firstFAQ),\n    botName: msg.config.defaultConfig.botName\n};\n\nmsg.systalk.config = msg.systalk.config || node._.cloneDeep(msg.systalk.defaultConfig);\nmsg.systalk.config.faqApi = msg.systalk.config.faqApi || msg.systalk.defaultConfig.faqApi;\nmsg.systalk.config.botName = msg.systalk.config.botName || msg.systalk.defaultConfig.botName;\n\n// 用於 report，計數 session 訊息數\nmsg.systalk.sessionMsgCounter = msg.systalk.sessionMsgCounter ?\n(msg.systalk.sessionMsgCounter + 1) : 1;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299deaa510819",
        "breakpoints": []
    },
    {
        "id": "d77152908a968df4ce3e.2e6df260719a",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "FAQ",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3664.0001525878906,
        "y": 1430.3334293365479,
        "wires": [
            [
                "28b2055b18cd54668821.9447facdff81"
            ],
            [
                "938efa36.ee78c8"
            ]
        ],
        "func": "const BotUtils = msg.systalk.utils.BotUtils;\n\nconst channel = msg.config.channel;\nconst multichannel_answers = msg.systalk.faqState.originalAns.multichannel_answers;\n\n// msg.keywords = msg.systalk.faqState.originalAns.keywords[0];\nmsg.faqId = msg.systalk.faqState.originalAns.id;\n\nlet faqAns = multichannel_answers[0];//預設值\n\nif(multichannel_answers.some(answer => answer.tab.toLowerCase() == channel.toLowerCase())){//抓對應channel的結果\n    faqAns = multichannel_answers.find(answer => answer.tab.toLowerCase() == channel.toLowerCase())\n}\n\nnode.log(faqAns);\n\n// 清除聽不懂計數器\nmsg.systalk.cannotRecognizedCounter = 0;\n\nmsg.headers = msg.config.headers;\nmsg.url = msg.config.apis.gateWay.faqAnswer;\nmsg.method = \"POST\";\n\nmsg.payload = {\n    channel: msg.config.channel,\n    source: msg.config.source,\n    role: msg.config.role,\n    intent: msg.reqMsg.intent\n};\n\nconst ans = faqAns.answer;\nif (typeof ans === 'string' &&\n    ans.trim().startsWith(\"[\") &&\n    ans.trim().endsWith(\"]\")){//json array 格式\n\n    msg.payload.faqAnswer = JSON.parse(ans.replace(/\\n/g, \"\"));\n} else {//文字格式\n    msg.faqAns = BotUtils.faqAnsToMessages(ans);\n    msg.faqAns.forEach(item => {\n        item.text = item.text.replace(/\\n/g, \"<br\\/>\");\n    });\n\n    return [null,msg];\n}\n\nreturn msg;\n",
        "outputs": 2,
        "noerr": 0,
        "_id": "61c99430f0429981b851081a",
        "breakpoints": []
    },
    {
        "id": "fa7544e80ac0a7380147.ad7b1cb733cd",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Bot Utils",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1420,
        "y": 436,
        "wires": [
            [
                "8e1284c0de3cd0ab9f68.8a51ec8a0b33"
            ]
        ],
        "func": "const LocalesUtils = msg.systalk.utils.LocalesUtils;\nconst ReqChannels = msg.systalk.utils.ReqChannels;\nconst ReqMsgTypes = msg.systalk.utils.ReqMsgTypes;\nconst ReplyMsgFactory = msg.systalk.utils.ReplyMsgFactory;\nconst ReplyMsgCtrl = msg.systalk.utils.ReplyMsgCtrl;\n\nclass BotUtils {\n    \n    getFaqAnsStateTags(ans) {\n        const groupTagReg = msg.config.regexes.faqGroupTag || /^\\s*[^(@|＠)]+(@|＠)\\d+\\s*$/;\n        \n        if (!ans || !ans.categories.length)\n            return [];\n        return ans.categories.filter(tag => {\n            return groupTagReg.test(tag);\n        });\n    }\n    \n    getFaqAnsStateFromTag(tag) {\n        const info = tag.split(/(@|＠)/i);\n        if (info.length < 2)\n            return null;\n        return {\n            state: info[0],\n            index: parseInt(info[info.length - 1])\n        };\n    }\n    \n    /**\n     * 轉換 FAQ 結果為 state 物件\n     * \n     * @params ans 單一答案\n     * @params lastFaqState 上一次紀錄的 state\n     */\n    getFaqAnsState(ans, lastFaqState) {\n        let tags = this.getFaqAnsStateTags(ans) || [];\n        let states = tags.map(tag => this.getFaqAnsStateFromTag(tag)).filter(item => !!item);\n        \n        let isNonLevelState = !states.length;\n        let isRootState = states.some(item => item.index === 1);\n        let isDescendantState = lastFaqState && states.some(item => {\n            return lastFaqState.states.some(ascend => ascend.index === item.index - 1 && ascend.state === item.state);\n        });\n        let isSiblingState = lastFaqState && states.some(item => {\n            return lastFaqState.states.some(sibling => sibling.index === item.index && sibling.state === item.state);\n        });\n\n        return {\n            states: states,\n            answer: ans.answer,\n            score: ans.score,\n            originalAns: node._.cloneDeep(ans),\n            isNonLevelState: isNonLevelState,\n            isRootState: isRootState,\n            isDescendantState: isDescendantState,\n            isSiblingState: isSiblingState,\n            isLevelState: isRootState || isDescendantState || isSiblingState,\n            isValidState: isNonLevelState || isRootState || isDescendantState || isSiblingState,\n        };\n    }\n    \n    generateSalt() {\n        return Date.now().toString();\n    }\n    \n    markResetAllSessions() {\n        msg.systalk.sessionSalt = null;\n    }\n    \n    /**\n     * 清空紀錄狀態\n     */\n    resetSessionStats() {\n        msg.systalk.sessionSalt = this.generateSalt();\n        msg.systalk.pendingBot = null;\n        msg.systalk.pendingIntent = null;\n        msg.systalk.pendingEntities = null;\n        msg.systalk.faqState = null;\n        msg.systalk.cannotRecognizedCounter = null;\n        msg.systalk.identity = null;\n        msg.systalk.location = null;\n        msg.systalk.config = Object.assign({}, msg.systalk.defaultConfig);\n    }\n    \n    replaceTextByParams(text, params) {\n        if (params) {\n            Object.keys(params).forEach(key => {\n                if (params[key]) {\n                    const regex = new RegExp('{{\\\\s*' + key + '\\\\s*}}', 'gm');\n                    text.replace(regex, params[key]);\n                }\n            });\n        }\n        return text;\n    }\n    \n    /**\n     * 訊息格式的 `text` 或 `title` 屬性帶有可替換屬性格式時替換\n     */\n    replaceMsgTextByParams(message, params) {\n        let _msg = message;\n        if (ReplyMsgCtrl.isValid(_msg) && !!params) {\n            if (!!_msg.text) {\n                _msg.text = this.replaceTextByParams(_msg.text, params);\n            }\n            if (!!_msg.title) {\n                _msg.title = this.replaceTextByParams(_msg.title, params);\n            }\n        }\n        return _msg;\n    }\n    \n    /**\n     * 將 FAQ 答案轉換成訊息物件 array\n     * - 可使用標準 JSON 格式（未另外處理）\n     * - 可使用 \"\" 表示回應一個語句\n     * @param replacementParams 語句中可替換參數\n     * @param msgCreator callback function 以建立訊息物件，傳入一個參數 `text`，回傳回應訊息物件`\n     */\n    faqAnsToMessages(ans, replacementParams, msgCreator) {\n        const _creatorCallback = msgCreator || ReplyMsgFactory.createText;\n        let faqAns = ans;\n        let messages = [];\n        // 若為標準 JSON 格式\n        try {\n            let parsedAns = JSON.parse(faqAns);\n            faqAns = parsedAns;\n        } catch (err) {\n            faqAns = faqAns;\n        }\n        // 若為字串。比對自定義格式\n        if (typeof faqAns === 'string') {\n            // 以雙引號區分訊息語句\n            const doubleQuoteSeparatedRegex = msg.config.regexes.faqDoubleQuotedAns || /^\\s*(([\"]((\\\\\"|[^\"])+)[^\\\\]?[\"])?([^\\\\]?[\"]((\\\\\"|[^\"])+)[^\\\\]?[\"])*\\s*([^\\\\]?[\"]((\\\\\"|[^\"])+)[\"])?)$/;\n            if (doubleQuoteSeparatedRegex.test(ans)) {\n                const customRegex = msg.config.regexes.faqDoubleQuotedAnsSplit || /[\"]((\\\\\"|[^\"])+)[\"]/gm;\n                let matched = null;\n                while ( !!(matched = customRegex.exec(ans)) ) {\n                    if (node._.isFunction(_creatorCallback)) {\n                        messages = messages.concat(_creatorCallback(matched[1], replacementParams));\n                    }\n                }\n            }\n            else {\n                if (node._.isFunction(_creatorCallback)) {\n                    messages = messages.concat(_creatorCallback(faqAns, replacementParams));\n                }\n            }\n        }\n        // 若使用定義之通用格式\n        if (Array.isArray(faqAns) && faqAns.every(ans => ReplyMsgCtrl.isValid(ans))) {\n            messages = messages.concat(faqAns.map(x => {\n                return this.replaceMsgTextByParams(x, replacementParams);\n            }));\n        }\n        else if (typeof faqAns === 'object' && ReplyMsgCtrl.isValid(faqAns)) {\n            messages.push(this.replaceMsgTextByParams(faqAns, replacementParams));\n        }\n        return messages;\n    }\n    \n    /**\n     * 將要字串比對的項目，加入至 `msg.textComparsion`\n     */\n    addTextComparsion(_msg, name, values, threshold) {\n        const comparsion = {};\n        if (typeof name === 'string' && Array.isArray(values)) {\n            comparsion[name] = {\n                values: values,\n                threshold: node._.isNil(threshold) ? msg.config.defauleTextComparsionThreshold : threshold\n            };\n            if (_msg) {\n                _msg.textComparsion = node._.assign(_msg.textComparsion || {}, comparsion);\n            }\n            return comparsion;\n        }\n    }\n    /**\n     * 現在時間是否介於 08:30~16:00\n     */\n    isInOfficeHours() {\n        const currentDate = new Date();\n        const currentMoment = node.moment(currentDate).tz(\"Asia/Taipei\");\n        const currentHour = currentMoment.hour();\n        \n        let endMoment = node.moment(currentDate).tz(\"Asia/Taipei\");\n        endMoment.set('hour', 16);\n        endMoment.set('minute', 0);\n        endMoment.set('second', 0);\n        \n        let startMoment = node.moment(currentDate).tz(\"Asia/Taipei\");\n        startMoment.set('hour', 8);\n        startMoment.set('minute', 30);\n        startMoment.set('second', 0);\n        return currentMoment.diff(startMoment) >= 0 && currentMoment.diff(endMoment) <= 0;\n    }\n    \n    concatTransferAction(transferNumber, wavName) {\n        let ttsAction;\n        // 尚未指定分機\n        if (node._.isNil(transferNumber)) {\n            ttsAction = `${msg.config.ttsActions.transfer}#${(new Map(msg.config.extensionNumberMap)).get(msg.systalk.stored.userData.hospitalId)}`;\n        }\n        // 指定分機\n        else {\n            ttsAction = `${msg.config.ttsActions.transfer}#${transferNumber}`;\n        }\n        if (wavName) {\n            ttsAction += `#${wavName}`;\n        }\n        return ttsAction\n    }\n}\n\nmsg.systalk.utils.BotUtils = new BotUtils();\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299ef8f51081b",
        "breakpoints": []
    },
    {
        "id": "778bbe1abc3a8c10af0f.663966397981",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": " URL & Query string",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2327,
        "y": 1298,
        "wires": [
            [
                "e82c4dd8974e8d3909a6.1ee30f4531da"
            ]
        ],
        "func": "const ConfigCtrl = msg.systalk.utils.ConfigCtrl;\n\nmsg.method = 'GET';\nmsg.url = ConfigCtrl.getNLUApi(msg.config.names.firstNLU) + encodeURI(msg.payload);\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299a4a651081c",
        "breakpoints": []
    },
    {
        "id": "934d59e8feea58660d2f.b914e2ffb506",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": " URL & Query string",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2327,
        "y": 1338,
        "wires": [
            [
                "ae06cf5aff7435f2ef0b.8825b43e5d5f"
            ]
        ],
        "func": "const ConfigCtrl = msg.systalk.utils.ConfigCtrl;\n\nmsg.method = 'POST';\nmsg.url = ConfigCtrl.getFAQApi(msg.config.names.firstFAQ) + encodeURI(msg.payload) + `&result_size=${msg.config.faqMaxResultSize}`;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429950d651081d",
        "breakpoints": []
    },
    {
        "id": "7735eacc74d6111f892f.82ce49195062",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "參數化 request NLU, FAQ",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "透過 `msg.config.nluApis` 與 `msg.config.faqApis`設定，\n可參數化調整要使用的 NLU / FAQ。\n",
        "in": [],
        "out": [],
        "x": 2443.666923522949,
        "y": 1254.6666564941406,
        "wires": [],
        "_id": "61c99430f04299378c51081e",
        "breakpoints": []
    },
    {
        "id": "8e23490f15234dcad6ad.93099c727817",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "其他訊息處理",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1213.0000534057617,
        "y": 1845.6667175292969,
        "wires": [
            [
                "b8754113520b8880b314.237288ef1428"
            ],
            [
                "40474c0ca03710e95541.94d14f7c0956"
            ],
            [
                "6f99b9768de0e0875117.5508a4441441"
            ],
            [
                "8cce897d4f5472518a36.ba65fc6de506"
            ],
            [
                "f0f31c03fa51384ba9b9.e693e1cdca66"
            ]
        ],
        "func": "// const ReqMsgCtrl = msg.systalk.utils.ReqMsgCtrl;\n// const ReplyMsgFactory = msg.systalk.utils.ReplyMsgFactory;\nconst BotUtils = msg.systalk.utils.BotUtils;\nconst MsgUtils = msg.systalk.utils.MsgUtils;\n\nconst numOuts = 5;\n\n// 初始對話\nif (msg.reqMsg.msg === '詢問其他服務') {\n    BotUtils.resetSessionStats();\n    return MsgUtils.output(msg, 1, numOuts);\n}\n\n// 判斷 chatweb request type\nswitch (msg.reqMsg.type) {\n    // 初始對話\n    case 'initSession':\n        BotUtils.resetSessionStats();\n        return MsgUtils.output(msg, 1, numOuts);\n    // 結束全部流程對話\n    case 'closeSession':\n        BotUtils.markResetAllSessions();\n        return MsgUtils.output(msg, 2, numOuts);\n    // 滿意度\n    case 'rank':\n        return MsgUtils.output(msg, 3, numOuts);\n    // 使用者閒置\n    case 'userIdle':\n        return MsgUtils.output(msg, 5, numOuts);\n    // 預設 (進入到子流程)\n    default:\n        return MsgUtils.output(msg, 4, numOuts);\n}\n",
        "outputs": 5,
        "noerr": 0,
        "_id": "61c99430f042994cb451081f",
        "breakpoints": []
    },
    {
        "id": "6f99b9768de0e0875117.5508a4441441",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "滿意度回覆",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1460.3334350585938,
        "y": 1845.333321094513,
        "wires": [
            []
        ],
        "func": "// 進入結束流程\nmsg._to_end = true;\n\nif(msg.reqMsg.param.personSatisfaction){\n    //客服滿意度分數\n    msg.systalk.report_stats_session.agentUserScore = parseInt(msg.reqMsg.param.personSatisfaction);\n\n    //客服滿意度留言\n    msg.systalk.report_stats_session.agentUserMessage = msg.reqMsg.param.commend;\n} else{\n    //聊天機器人滿意度分數\n    msg.systalk.report_stats_session.botUserScore = msg.reqMsg.param.rankScore.bot ? msg.reqMsg.param.rankScore.bot : null;\n    \n    //聊天機器人滿意度留言\n    msg.systalk.report_stats_session.botUserMessage = msg.reqMsg.param.rankScore.bot ? msg.reqMsg.param.rankScore.comment : null;\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042998ec7510820",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "f0f31c03fa51384ba9b9.e693e1cdca66",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "使用者閒置",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1461.0000534057617,
        "y": 1925.3332891464233,
        "wires": [
            []
        ],
        "func": "// 不結束對話\nmsg._end_dialogue = false;\n\n// 進入呼叫gateway api流程\nmsg._gateWay = true;\n\n// 設定api url\nmsg.url = msg.config.apis.gateWay.text;\n\n// 設定request body\nmsg.reqBody = {\n    chatwebId: msg.reqMsg.chatwebId,\n    channel: msg.reqMsg.channel,\n    source: msg.config.source,\n    role: msg.config.role,\n    intent: msg.reqMsg.intent,\n    content: []\n};\n\n// 若使用者閒置過久\nif (!node._.isNil(msg.systalk.idleTimeoutCounter) && msg.systalk.idleTimeoutCounter === 1) {\n    msg.systalk.idleTimeoutCounter = undefined;\n    msg.ttsAction = msg.config.ttsActions.end;\n    msg._end_dialogue = true;\n    msg.reqBody.content.push({textCode: \"ST009\"});\n} else {\n    msg.systalk.idleTimeoutCounter = 1;\n    msg.reqBody.content.push({textCode: \"ST008\"});\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429950d7510821",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "4464076e62456dd16eda.6bceb50fc6c8",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "Response",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 188,
        "y": 3511,
        "wires": [
            [
                "e364fd38a3a5f711aec0.09a588bca6e5"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f0429992f7510822",
        "breakpoints": [],
        "rules": [
            {
                "t": "nnull",
                "p": "messages"
            },
            {
                "t": "nnull",
                "p": "_end_dialogue"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "de8ac9c42530b2898d1f.3d31fc4f85a4",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "state",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1265,
        "y": 3504,
        "wires": [
            []
        ],
        "func": "\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042994b7e510823",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "38246833fe65b28fd365.5d4953f6404e",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "Req User Input",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 198,
        "y": 3571,
        "wires": [
            [
                "a1765449a7fb53b206fc.d4e38aaf3283"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299aea6510824",
        "breakpoints": [],
        "rules": [
            {
                "t": "false",
                "p": "_enter_end_dialogue"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "a1765449a7fb53b206fc.d4e38aaf3283",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "state",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 428,
        "y": 3571,
        "wires": [
            []
        ],
        "func": "msg._enter_end_dialogue = undefined;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429970c0510825",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": true
    },
    {
        "id": "2c2ec59f47503f037772.cadffbbabd48",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "End Dialogue",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 198,
        "y": 3631,
        "wires": [
            [
                "71936e87806d52ed08eb.3192f01366dd"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299fa1a510826",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_enter_end_dialogue"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "bb28c6f5cdaadb8a1872.89355c88cc0c",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "state",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 663,
        "y": 3631,
        "wires": [
            []
        ],
        "func": "msg._enter_end_dialogue = undefined;\n// msg.systalk.location = undefined;\n// msg.systalk.identity = undefined;\n// msg.systalk.pendingIntent = undefined;\n// msg.systalk.pendingEntities = undefined;\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042990d02510827",
        "breakpoints": [],
        "response": "",
        "finalstate": true,
        "requestUserInput": false
    },
    {
        "id": "ab794ba1219ac3944716.f5e69dc6d55d",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "統一處理回應。整理紀錄資訊",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "為紀錄額外資訊並清除多餘資訊   \n因此，需於主流程後，  \n`Router` output 前處理完成。  \n\n1. 將各子流程 state 節點，皆__不設定__ \n   `Request User Input` 或 `End Dialogue`。\n2. 由於 Router node 會__輪詢__ Enter node，\n   因此可__依序__設定與清理 Response ，\n   並決定是否需結束對話。",
        "in": [],
        "out": [],
        "x": 238,
        "y": 3471,
        "wires": [],
        "_id": "61c99430f0429973e6510828",
        "breakpoints": []
    },
    {
        "id": "b3d5132f79ab35f55489.3f5b202f6671",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Config",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 654,
        "y": 443,
        "wires": [
            [
                "567e8258940a56aa9d9b.da9ada5f1662"
            ],
            [
                "ea5f62aceda7cfb53cae.388ff27b0bd5"
            ]
        ],
        "func": "\nmsg.config = {\n    botType: 'firstBot',\n    /* 定義各子流程名稱與 Http-In Api */\n    apis: {\n        bots: { // 定義各子流程名稱與 Http-In Api\n            'firstBot': null,\n        },\n        nlu: { // 流程有使用到的 NLU\n            '總機': '',\n            '服務台': null,\n        },\n        faq: { // 流程有使用到的 FAQ\n            // 語音導航FAQ\n            'FAQ': '',\n        },\n        locales: null, // Optional\n        resources: {\n        },\n        gateWay: {\n            scene: 'http://10.20.30.225:8011/card/scene',\n            text: 'http://10.20.30.225:8011/card/text',\n        },\n    },\n    names: {\n        firstNLU: '總機',\n        firstFAQ: 'FAQ',\n        firstNLUSupport: '服務台'\n    },\n    /**\n     * 信心值門檻\n     * 需要依實際情形調整\n     */\n    threshold: {\n        nlu: {\n            '總機': 0.75,\n        },\n        faq: {\n            'FAQ': 0.65\n        }\n    },\n    secondThreshold: {\n        nlu: {\n            // '總機': 0,\n        },\n        faq: {\n            // 'FAQ': 0\n            // 'FAQ': 0.65\n        }\n    },\n    faqMaxResultSize: 10,\n    /**\n     * 設定 NLU 原點值（訓練語料完全沒有符合的字詞，表示機器真的聽不懂）\n     * 每次訓練、修改後，需確認是否變更，並更新\n     */\n    nluFallbackScore: { // 設定各 NLU 原點值\n        '總機': 0.6709504203251146,\n        // '服務台': 0,\n    },\n    intents: { // 用以辨識的 Intent 名稱\n        toAgent: ['轉真人服務', '真人服務', '轉真人', '真人', '客戶服務', '客服', '抱怨', '申訴', '客訴', '投訴', '主管'],\n        end: '結束對話',\n    },\n    entities: { // 使用到的 Entity 名稱\n    },\n    /**\n     * FAQ 所使用到的關鍵字詞\n     */\n    keywords: ['信用卡服務', '銀行服務'],\n    /**\n     * 提供服務台查找對應的三維意圖。\n     * 服務名稱為必須。\n     * 操作或項目為空，設為空陣列 `[]`\n     */\n    intentsMap: {\n        '<SERVICE_NAME>': {\n            '<OPERATION_NAME>': [ '<ITEM_NAME>' ]\n        }\n    },\n    /**\n     * Bot 預設設定值。\n     */\n    defaultConfig: {\n        botName: 'bot'\n    },\n    // 推薦選項(NLU/FAQ)數量限制\n    maxSuggestedNumber: 3,\n    // for GateWay used\n    headers:{\n        Authorization: 'B2CC430497B84006A3D3C53EABB10FDB'\n    },\n    role:'bot',\n    source: msg.reqMsg.source || 'MEGABANK',\n    channel: msg.reqMsg.channel || 'Voice',\n    /**\n     * 語音回應重聽次數上限\n     */\n    maxResendTimes: 3,\n    /**\n     * 語音對話時間上限，單位秒\n     */\n    sessionTimeLimitInSeconds: 300,\n    /**\n     * 院區名稱與院區代碼對應\n     */\n    ttsActions: {\n        music: '#music',\n        goto: '#goto',\n        ok: '#ok',\n        // transfer: '#transfer',\n        // overTimeTransfer: '#overTimeTransfer',\n        end: '#end',\n        sttOff: '#sttOff',\n        sttOn: '#sttOn',\n        noInput: `#noInputTimeout`, // stt 沒收到音超過 30 秒\n    },\n    ttsModels: {\n        id: '#id',\n        doctorName: '#doctorName',\n        general: '#general'\n    },\n    auxiliaryWords: ['嗯','唉','喔','啊','恩','摁','阿','哀','痾','哦','嗚','呃','欸'],\n    casualWords: ['都可以', '都好', '隨便'],\n    correctText: ['是','對','無誤','正確','沒錯','沒有錯','可以','要','有','沒問題','好'],\n    wrongText: ['否','不對','錯誤','不正確','有錯','錯','不可以','不要','沒有','有問題','不好','不是','有誤'],\n    defauleTextComparsionThreshold: 0.8,\n    higherFAQThreshold: 0.85,\n    higherNLUThreshold: 0.8\n};\n\n// 已有從 GateWay 參數 或 debug模式\n// if(msg.systalk.configParameters || msg.debug){\n//     return [msg, null];\n// }else{\n//     //由API取得參數\n//     return [null, msg];\n// }\n\nreturn [null, msg];\n",
        "outputs": 2,
        "noerr": 0,
        "_id": "61c99430f0429985ff510829",
        "breakpoints": []
    },
    {
        "id": "d5cd06f9a2d3cd24e1a2.b7b9b6013f46",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "Start",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 189,
        "y": 1813,
        "wires": [
            [
                "1b4d207969932bfa3f67.626312713434",
                "af563c87bf363c70ecf9.94e364436bac"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f042995c4b51082a",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_start_flow"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "1b4d207969932bfa3f67.626312713434",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "state",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 424,
        "y": 1813,
        "wires": [
            [
                "93c445c023b857d2d068.418bf17dd3cb",
                "eb792b5bee048cc93229.ecf49ebfaaf7",
                "fabae905278d55f56124.11a1fbf26b27",
                "2688231ba9b91a6f4c80.d49fbe04ba05",
                "28f46c0ec8000ca11ab6.9e1d497657a3",
                "a98d73251f6dfa44c0a0.ad92b292631d",
                "0df75e17e92b493310b5.d138f4753f39",
                "e9a9d9c7ccb7949f3191.ea98e0b21987",
                "b4d1596e217ce954acb5.c1d5cefa6e59",
                "d43ba89f8bd5351d02a9.080ab7d5e591",
                "19467c8d2213bae66eb3.a9cfafb33b0c",
                "a62b8d199fae6baf5447.bcb957ffc196",
                "0e06bf8226bf4c50d14c.5b2e3484f1f0",
                "c21968347b68c74373bd.ce400c0484b3",
                "e71c8552626168cd4cc9.ba942e3b9df4",
                "4a4893ea.30d10c",
                "b9a6e33d.8a392"
            ]
        ],
        "func": "msg._start_flow = false;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429908ee51082b",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "2a66e962406a896f4df9.ebebc86afc90",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "開始總機處理流程",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "",
        "in": [],
        "out": [],
        "x": 209,
        "y": 1773,
        "wires": [],
        "_id": "61c99430f0429911a351082c",
        "breakpoints": []
    },
    {
        "id": "9f4332f294d2dd658dc9.768ad81a3768",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "定義與設定",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "",
        "in": [],
        "out": [],
        "x": 191,
        "y": 404,
        "wires": [],
        "_id": "61c99430f0429963c851082d",
        "breakpoints": []
    },
    {
        "id": "7bf0c93dd516b3b62a9f.2464fc14f3e1",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "Debug config values",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1492,
        "y": 1492,
        "wires": [
            []
        ],
        "func": "// const ReqMsgCtrl = msg.systalk.utils.ReqMsgCtrl;\nconst ReplyMsgFactory = msg.systalk.utils.ReplyMsgFactory;\n\nlet configRes = '';\nfor (let key in msg.systalk.config) {\n    configRes += `\"${key}\": \"${msg.systalk.config[key]}\"\\n`;\n}\n\nmsg.messages = [ReplyMsgFactory.createText(configRes)];\n\nmsg._end_dialogue = false;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299b7fe51082e",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "339c33b704db92684b03.8825db7feb67",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "特殊指令",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "- `\"@configs\"`  \n  顯示  \n  `msg.systalk.config`  \n  紀錄的設定值",
        "in": [],
        "out": [],
        "x": 1204,
        "y": 1500,
        "wires": [],
        "_id": "61c99430f042992a1051082f",
        "breakpoints": []
    },
    {
        "id": "3407593ce2b689b0d7bb.71a6c9825cde",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "結束流程 (_from_end)",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 222,
        "y": 2283,
        "wires": [
            [
                "714273ebbc373a57f693.97f75c1a3e76"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299fde5510830",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_from_end"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "714273ebbc373a57f693.97f75c1a3e76",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "結束",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 980,
        "y": 2283,
        "wires": [
            []
        ],
        "func": "// 結束對話\nmsg._end_dialogue = true;\n\n// 設定結束行動\nmsg.ttsAction = msg.config.ttsActions.end;\n\n// 進入呼叫gateway api流程\nmsg._gateWay = true;\n\n// 設定api url\nmsg.url = msg.config.apis.gateWay.text;\n\n// 設定requset body\nmsg.reqBody = {\n    chatwebId: msg.reqMsg.chatwebId,\n    channel: msg.config.channel,\n    source: msg.config.source,\n    role: msg.config.role,\n    content: [\n        {\n            textCode: 'ST009'\n        }\n    ]\n};\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299074f510831",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "8bc8913e8d1ec86425a7.fbfe8f9523af",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "真人客服處理",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 196,
        "y": 2838,
        "wires": [
            [
                "1490d5b.b6c372a"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299e4c1510832",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_to_customer_service"
            },
            {
                "t": "null",
                "p": "_gateWay"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "7dc6626fec273e5b9085.27d758537f10",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "第一次觸發轉真人",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1125,
        "y": 2703,
        "wires": [
            []
        ],
        "func": "const BotUtils = msg.systalk.utils.BotUtils;\n\n// 取消服務流程\nmsg.systalk.service = null;\n\n// 不結束對話\nmsg._end_dialogue = false;\n\n// 進入呼叫gateway api流程\nmsg._gateWay = true;\n\n// 設定api url\nmsg.url = msg.config.apis.gateWay.text;\n\n// 設定request body\nmsg.reqBody = {\n    chatwebId: msg.reqMsg.chatwebId,\n    channel: msg.config.channel,\n    source: msg.config.source,\n    role: msg.config.role,\n    content: [{\n        textCode: 'ST004'\n    }]\n};\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042994dd6510833",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "2083c069edc6141b9ce2.7499631de4a1",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "待接客服",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "",
        "in": [],
        "out": [],
        "x": 527.6666870117188,
        "y": 3195.666597366333,
        "wires": [],
        "_id": "61c99430f042991064510834",
        "breakpoints": []
    },
    {
        "id": "4cc98f8d4794213f5741.7a8a103af56f",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "進入轉真人",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3662.333396911621,
        "y": 1471.6665668487549,
        "wires": [
            []
        ],
        "func": "msg.remark = '使用者要求轉真人';\n\n// 設定第三次轉真人服務並進入轉真人流程\n// msg.systalk.toAngentCounter = 3;\nmsg._to_customer_service = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429983fb510835",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "71936e87806d52ed08eb.3192f01366dd",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "change",
        "name": "刪除自訂紀錄資訊",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 448,
        "y": 3631,
        "wires": [
            [
                "bb28c6f5cdaadb8a1872.89355c88cc0c"
            ]
        ],
        "_id": "61c99430f04299b79f510836",
        "breakpoints": [],
        "rules": [
            {
                "t": "delete",
                "p": "systalk.pendingIntent",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "systalk.pendingEntities",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "systalk.identity",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "systalk.location",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "systalk.config",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "systalk.defaultConfig",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "systalk.sessionSalt",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "systalk.determinationMode",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false
    },
    {
        "id": "f6d90b6db6050ed6de28.5036317f7e4b",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "總機NLU結果",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 2727.9999465942383,
        "y": 1255.666672706604,
        "wires": [],
        "_id": "61c99430f04299fa9c510837",
        "breakpoints": []
    },
    {
        "id": "fa9dc40cdc69dfa604a1.6bb1ad0682d3",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "回應訊息",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 846,
        "y": 3550,
        "wires": [
            [
                "db5c59e771dad951aa1d.85e2d3c2e0c4"
            ]
        ],
        "func": "msg.payload = msg.messages;\n\n// if (msg.systalk.stored && msg.systalk.stored.userData) {\n//     msg.payload.tel = msg.systalk.stored.userData.tel;\n//     msg.payload.hostipalId = msg.systalk.stored.userData.hostipalId;\n// }\n\n// IVR 需要\nlet domain = msg.config.ttsModels.general;\n\nif (msg.useDoctorNameModel && domain !== msg.config.ttsModels.doctorName) {\n    domain = msg.config.ttsModels.doctorName;\n}\n\nif (msg.useIdModel && domain !== msg.config.ttsModels.id) {\n    domain = msg.config.ttsModels.id;\n}\n\nif ((msg.messages.domain || msg.ttsDomain) && domain !== msg.messages.domain && domain !== msg.ttsDomain) {\n    domain = msg.messages.domain || msg.ttsDomain;\n}\n\nmsg.payload.domain = domain;\nmsg.payload.action = msg.ttsAction || msg.messages.action || msg.config.ttsActions.sttOn;\nmsg.payload.errorCode = msg.errorCode || \"\";\nmsg.payload.sessionId = msg.systalk._session_id;\nmsg.payload.tel = msg.reqMsg.customerId;\n\n// 紀錄回應訊息\nmsg.systalk.previousResponse = msg.payload;\nmsg._enter_end_dialogue = msg._end_dialogue;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042995b0a510838",
        "breakpoints": []
    },
    {
        "id": "3daf1a61a46b4210e8d9.19c47910abf9",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "FAQ結果",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 2718,
        "y": 1378,
        "wires": [],
        "_id": "61c99430f042997344510839",
        "breakpoints": []
    },
    {
        "id": "646386c25b71733fad90.df34f4599a91",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "結束與滿意度調查流程",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "",
        "in": [],
        "out": [],
        "x": 211,
        "y": 2323,
        "wires": [],
        "_id": "61c99430f04299781851083a",
        "breakpoints": []
    },
    {
        "id": "9156a89422f8f910166c.4ae85a8594c7",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "FAQ Only",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1462,
        "y": 1572,
        "wires": [
            []
        ],
        "func": "msg.systalk.determinationMode = msg.config.determinationMode.faqOnly;\n\nmsg.messages = {\n    code: 0,\n    msg: \"成功\",\n    data: {\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: msg.config.role,\n        content: [\n            {\n                type: 1,\n                text: `Determination Mode: ${msg.systalk.determinationMode}`\n            }\n        ]\n    }\n};\n\nmsg._end_dialogue = false;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299030551083b",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "824ae64ee808cb0cda2d.5b3005857754",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "字串相似度比對",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1476,
        "y": 1324,
        "wires": [
            [
                "5af7d1b0f9e1ce6bc05e.fa6cff667f73"
            ]
        ],
        "func": "const StringUtils = msg.systalk.utils.StringUtils;\n\n// 若需要字串比對\nif (msg.systalk.textComparsion) {\n    for (let [query, comparedGroup] of Object.entries(msg.systalk.textComparsion)) {\n        // skip invalid\n        if (!Array.isArray(comparedGroup.values) ||\n            typeof comparedGroup.threshold !== 'number') {\n            // comparedGroup.matched = false;\n            continue;\n        }\n        const result =\n            comparedGroup.values.some(t => {\n                return StringUtils.stringSimilarity(msg.text, t) >= comparedGroup.threshold;\n            });\n        \n        // 若比對結果正確，則將使用者輸入文字取代成特定問句\n        // 並結束迴圈\n        if (result) {\n            msg.payload = query;\n            break;\n        }\n    }\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042991bfb51083c",
        "breakpoints": []
    },
    {
        "id": "df28fa613ebbd3210902.807fbf7830dc",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "switch",
        "name": "@functionCode",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1222,
        "y": 1552,
        "wires": [
            [
                "7bf0c93dd516b3b62a9f.2464fc14f3e1"
            ],
            [
                "279c35c045459854b75c.51410112b0bb"
            ],
            [
                "9156a89422f8f910166c.4ae85a8594c7"
            ],
            [
                "83daeffaf5436465fd78.de7721735b45"
            ]
        ],
        "outputs": 4,
        "_id": "61c99430f0429940c651083d",
        "breakpoints": [],
        "property": "text",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "config.tags.showConfig",
                "vt": "msg"
            },
            {
                "t": "eq",
                "v": "config.tags.renewClientDialogue",
                "vt": "msg"
            },
            {
                "t": "eq",
                "v": "config.tags.faqOnlyMode",
                "vt": "msg"
            },
            {
                "t": "eq",
                "v": "config.tags.defaultMode",
                "vt": "msg"
            }
        ],
        "checkall": "true"
    },
    {
        "id": "f6cf4bdfe1e4bb2a766b.59784c502ec6",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "滿意度 (_to_grading)",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 216,
        "y": 2951,
        "wires": [
            [
                "215e41dd1ed217c8c7af.7d2fbb1a1510"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299627251083e",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_to_grading"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "9ad7591e45e176a3f384.dca55ab8f5b5",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "結束對話 (_to_end)",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 216,
        "y": 3011,
        "wires": [
            [
                "52d1f4c889a318329373.223ac20967bc"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f0429972ec51083f",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_to_end"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "215e41dd1ed217c8c7af.7d2fbb1a1510",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "state",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 526,
        "y": 2951,
        "wires": [
            []
        ],
        "func": "// const ReplyActionTypes = msg.systalk.utils.ReplyActionTypes;\n// const ReplyMsgFactory = msg.systalk.utils.ReplyMsgFactory;\n\nmsg._end_dialogue = false;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299e708510840",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "52d1f4c889a318329373.223ac20967bc",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "state",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 526,
        "y": 3011,
        "wires": [
            []
        ],
        "func": "const ReplyMsgFactory = msg.systalk.utils.ReplyMsgFactory;\nconst ReqChannels = msg.systalk.utils.ReqChannels;\nconst BotUtils = msg.systalk.utils.BotUtils;\nconst ReplyActionTypes = msg.systalk.utils.ReplyActionTypes;\nconst ReplyMsgTypes = msg.systalk.utils.ReplyMsgTypes;\n\n// 結束對話\nmsg._end_dialogue = true;\n\n// 回覆使用者訊息\nmsg.messages = {\n    code: 0,\n    message: \"成功\",\n    data: {\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: msg.config.role,\n        content: [\n            {\n                type: 1,\n                text:'感謝您提供意見'\n            }\n        ]\n    },\n    action: msg.config.ttsActions.end,\n};\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299a69e510841",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "2f55c302136e179e0325.c0f786fa5b80",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "前端清除對話 (_renew_dialogue)",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 256,
        "y": 3071,
        "wires": [
            [
                "db794bcb8124a0ef5411.02fc89585ad7"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f0429970e4510842",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_renew_dialogue"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "db794bcb8124a0ef5411.02fc89585ad7",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "state",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 526,
        "y": 3071,
        "wires": [
            []
        ],
        "func": "const ReplyMsgFactory = msg.systalk.utils.ReplyMsgFactory;\nconst ReplyActionTypes = msg.systalk.utils.ReplyActionTypes;\nconst ReplyMsgTypes = msg.systalk.utils.ReplyMsgTypes;\n\n// 新增回覆訊息\nmsg.messages.push(ReplyMsgFactory.create({\n    type: ReplyMsgTypes.action,\n    action: ReplyActionTypes.renew,\n    botType: msg.botType\n}));\n\nmsg._end_dialogue = false;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299269f510843",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "279c35c045459854b75c.51410112b0bb",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "to Refresh Client",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1482,
        "y": 1532,
        "wires": [
            []
        ],
        "func": "msg._renew_dialogue = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299d251510844",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "83daeffaf5436465fd78.de7721735b45",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "Default 判別模式",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1482,
        "y": 1612,
        "wires": [
            []
        ],
        "func": "msg.systalk.determinationMode = msg.config.determinationMode.default;\n\nmsg.messages = {\n    code: 0,\n    msg: \"成功\",\n    data: {\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: msg.config.role,\n        content: [\n            {\n                type: 1,\n                text: `Determination Mode: ${msg.systalk.determinationMode}`\n            }\n        ]\n    }\n};\n\nmsg._end_dialogue = false;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429982de510845",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "fd0ebdbd88a02d33bfe0.44dda3ae6080",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "決定跳轉流程",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "流程判定優先順序：\n\n1. FAQ  \n   - 取得達到門檻值(threshold)的答案  \n   - 上次回覆使用者的語句是否為 FAQ Group 回答？  \n      - 是。  \n        判斷此答案是否為同一個 Group __接續__ 的回答？  \n        是，則回答；否，則取最高分非 Group 的回答或Group 的第一個回答\n      - 否。  \n        取最高分非 Group 的回答或Group 的第一個回答\n   - 若為非 Group 的回答或Group 的第一個回答，語句長度若低於設定值(default 3)，改看 NLU 結果決定。\n   - 若 FAQ 答案帶有類別為 `@NLU@服務@操作` 的格式，會決定跳轉至該服務流程\n\n2. 總機 NLU\n   - 若總機可辨識，根據 intent 導向至服務流程。\n\n3. 服務台 NLU\n   - 服務台可辨識，會得到辨識出的操作（與項目）\n   - 根據 config 中設定的三維意圖 map，查找狀態所屬流程，  \n     目前紀錄狀態，紀錄“上次”與“上上次”的服務流程是誰  \n     依序看兩者，是否包含此操作（與項目）  \n     - 沒有。紀錄操作（與項目），並反問。\n     - 否則，維持原流程。\n\n4. 建議 FAQ 或服務意圖選項\n       \n5. 上次的流程\n   - 若已進入到某個服務流程中，進入同一流程。\n\n6. Fallback\n   - 最後，才會聽不懂。\n\n",
        "in": [],
        "out": [],
        "x": 3466,
        "y": 1211,
        "wires": [],
        "_id": "61c99430f04299725d510846",
        "breakpoints": []
    },
    {
        "id": "db5c59e771dad951aa1d.85e2d3c2e0c4",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "清除 msg 下屬性",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1051,
        "y": 3504,
        "wires": [
            [
                "de8ac9c42530b2898d1f.3d31fc4f85a4"
            ]
        ],
        "func": "// 刪除單一訊息流程狀態\nmsg._start_flow = undefined;\nmsg._get_locales = undefined;\nmsg._start_setup = undefined;\nmsg._end_dialogue = undefined;\nmsg._from_end = undefined;\nmsg._to_grading = undefined;\nmsg._to_end = undefined;\nmsg._renew_dialogue = undefined;\nmsg._to_customer_service = undefined;\n\n// 刪除暫存訊息資訊\nmsg.messages = undefined;\nmsg.error = undefined;\nmsg.config = undefined;\nmsg.url = undefined;\nmsg.method = undefined;\nmsg.headers = undefined;\nmsg.botType = undefined;\nmsg.botIntent = undefined;\nmsg.botEntities = undefined;\nmsg.isSuggestedFAQ = undefined;\nmsg.isSUggestedNLU = undefined;\nmsg.suggestedNLUIntents = undefined;\nmsg.suggestedFAQQuestions = undefined;\nmsg.faqAns = undefined;\n\n\n// 刪除 NLU 與 FAQ 結果\nmsg.firstNLUSupport = undefined;\nmsg.firstNLU = undefined;\nmsg.firstFAQ = undefined;\nmsg.NLU = undefined;\nmsg.FAQ = undefined;\n\n// 刪除自訂紀錄資訊\nmsg.systalk.locales = undefined;\nmsg.systalk.utils = undefined;\n\n// IVR\nmsg.ttsAction = undefined;\nmsg.ttsDomain = undefined;\nmsg.errorCode = undefined;\nmsg.useDoctorNameModel = undefined;\nmsg.useIdModel = undefined;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042992a19510847",
        "breakpoints": []
    },
    {
        "id": "afdf06a2c0974d2c65b5.c47756d884eb",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "App Config",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1231,
        "y": 436,
        "wires": [
            [
                "fa7544e80ac0a7380147.ad7b1cb733cd"
            ]
        ],
        "func": "if (!msg.config) {\n    msg.config = {};\n}\n\n/**\n * 定義特殊指令標籤\n */\nmsg.config.tags = {\n    showConfigs: '@configs',\n    faqOnlyMode: '@usefaqonlymode',\n    defaultMode: '@usedefaultmode',\n    renewClientDialogue: '@renew_dialogue'\n};\n\n/**\n * 定義判別模式：\n * 1) 預設\n * 2) 僅使用 FAQ\n */\nmsg.config.determinationMode = {\n    faqOnly: 'faqonly',\n    default: 'default'\n};\n\n/**\n * 定義判別格式\n * `faqRedirectCategory`: FAQ 重新導向至 NLU 意圖流程的 Tag 定義格式\n * `faqGroupTag`: FAQ 定義群組答案的 Tag 格式\n * `faqDoubleQuotedAns`: FAQ 以雙引號區分回應訊息的答案格式\n * `faqDoubleQuitedAnsSplit`: 切分 FAQ 答案以雙引號區分回應訊息\n */\nmsg.config.regexes = {\n    faqRedirectCategory: /NLU(@([^@]+))(@([^@]+))?(@([^@]+))?/,\n    faqGroupTag: /^\\s*[^(@|＠)]+(@|＠)\\d+\\s*$/,\n    faqDoubleQuotedAns: /^\\s*(([\"]((\\\\\"|[^\"])+)[^\\\\]?[\"])?([^\\\\]?[\"]((\\\\\"|[^\"])+)[^\\\\]?[\"])*\\s*([^\\\\]?[\"]((\\\\\"|[^\"])+)[\"])?)$/,\n    faqDoubleQuitedAnsSplit: /[\"]((\\\\\"|[^\"])+)[\"]/gm\n};\n\nreturn msg;\n\n\n\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042991586510848",
        "breakpoints": []
    },
    {
        "id": "6acf70591486671c2b25.25c3cb53f8d1",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Setup Report Stats",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2018,
        "y": 436,
        "wires": [
            [
                "5c0bcf7672b8b7991858.7c64a99906bd"
            ]
        ],
        "func": "const ReportUtils = msg.systalk.utils.ReportUtils;\n\n// initialize\nif (!msg.report_stats) {\n    msg.report_stats = {\n        result: {\n            firstFAQ: null,\n            firstNLU: null,\n            secondNLU: null,\n            thirdNLU: null\n        },\n        requestDuration: {\n            firstFAQ: null,\n            firstNLU: null,\n            secondNLU: null,\n            thirdNLU: null\n        }\n    };\n}\n\nif (!msg.systalk.report_stats_session) {\n    msg.systalk.report_stats_session = {\n        userScore: 0,\n        userHasInputed: false,\n        toCustomerService: false,\n        // traceTag: msg.reqMsg.param.traceTag,\n        channel: msg.reqMsg.channel,\n        chatwebId: msg.reqMsg.chatwebId,\n        //預設滿意度null\n        agentUserScore: null, //轉真人滿意度\n        botUserScore: null, //轉真人滿意度\n        customerId: msg.reqMsg.tel\n    };\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299ff51510849",
        "breakpoints": []
    },
    {
        "id": "5c0bcf7672b8b7991858.7c64a99906bd",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "setup analysis",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2238,
        "y": 436,
        "wires": [
            [
                "5fc8fdd0a8082760cc6f.40342c007b7d"
            ]
        ],
        "func": "msg.overall_analysis = {\n    faq: [],\n    nlu: []\n};\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042992b0451084a",
        "breakpoints": []
    },
    {
        "id": "e364fd38a3a5f711aec0.09a588bca6e5",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Set Report Stats",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 446,
        "y": 3511,
        "wires": [
            [
                "768d2d21270caa1854d1.064369c7a13b"
            ]
        ],
        "func": "const ReportUtils = msg.systalk.utils.ReportUtils;\nconst AnalysisCtrl = msg.systalk.utils.AnalysisCtrl;\nconst ConfigCtrl = msg.systalk.utils.ConfigCtrl;\n\n\n// report stats per session\nReportUtils.setSessionChannel(msg.systalk.report_stats_session, msg.systalk.channel);\nReportUtils.setSessionToCustomerService(msg.systalk.report_stats_session, msg.systalk.toCustomerService);\n\n\nif (!!msg.text && !msg.systalk.report_stats_session.userHasInputed) {\n    ReportUtils.setSessionUserHasInputed(msg.systalk.report_stats_session, true);\n}\nif (!node._.isNil(msg.systalk.score)) {\n    if (!node._.isNil(msg.systalk.score.bot)) {\n        ReportUtils.setSessionScoreForBot(msg.systalk.report_stats_session, msg.systalk.score.bot);\n    }\n    if (!node._.isNil(msg.systalk.score.agent)) {\n        ReportUtils.setSessionScoreForAgent(msg.systalk.report_stats_session, msg.systalk.score.agent);\n    }\n}\n\n// report stats per message\nlet deciding = !!msg._undecided ? (msg.isSuggestedFAQ || msg.isSuggestedNLU ? 'Suggested' : 'Undecided') : 'Decided';\nReportUtils.setDeciding(msg.report_stats,  deciding);\n\n\nif (!!msg.overall_analysis) {\n    // 取實際 FAQ 使用答案\n    const thresholdFirstFAQ         = ConfigCtrl.getFAQThreshold(msg.config.names.firstFAQ);\n    const secondThresholdFirstFAQ   = ConfigCtrl.getFAQSecondThreshold(msg.config.names.firstFAQ);\n    \n    if (!!msg.FAQ) {\n        msg.overall_analysis.faq.push(AnalysisCtrl.mapFAQResult(node._.cloneDeep(msg.FAQ), {\n            isFirstFAQ          : true,\n            threshold           : thresholdFirstFAQ,\n            secondThreshold     : secondThresholdFirstFAQ,\n            name                : 'FAQ'\n        }));\n    }\n    \n    msg.report_stats.result.firstNLU = AnalysisCtrl.mapNLUResultForReport(AnalysisCtrl.getFirstNLU(msg.overall_analysis.nlu)) || null;\n    msg.report_stats.result.secondNLU = AnalysisCtrl.mapNLUResultForReport(AnalysisCtrl.getSecondNLU(msg.overall_analysis.nlu)) || null;\n    msg.report_stats.result.thirdNLU = AnalysisCtrl.mapNLUResultForReport(AnalysisCtrl.getThirdNLU(msg.overall_analysis.nlu)) || null;\n    \n    let firstFAQ = AnalysisCtrl.getFirstFAQ(msg.overall_analysis.faq);\n\n    if (!!firstFAQ) {\n        let parentChildCategory = firstFAQ.categories.find(x => /^\\s*\\S+_\\S*\\s*$/.test(x));\n        let parentCategory  = !!parentChildCategory && parentChildCategory.split('_')[0];\n        let childCategory   = !!parentChildCategory && parentChildCategory.split('_')[1];\n        \n        msg.report_stats.result.firstFAQ = AnalysisCtrl.mapFAQResultForReport(firstFAQ, {\n            parentCategory: !!parentCategory ? parentCategory : undefined,\n            childCategory: !!childCategory ? childCategory : undefined\n        });\n    }\n}\n\n// 紀錄判別結果類別\nconst hasFirstFAQ = !!msg.report_stats.result.firstFAQ;\nconst hasFirstNLU = !!msg.report_stats.result.firstNLU;\n\nconst faqDecided = (\n    hasFirstFAQ &&\n    node._.isBoolean(msg.report_stats.result.firstFAQ.undecided) &&\n    !msg.report_stats.result.firstFAQ.undecided\n);\nconst nluDecided = (\n    hasFirstNLU && \n    node._.isBoolean(msg.report_stats.result.firstNLU.undecided) &&\n    !msg.report_stats.result.firstNLU.undecided\n);\n\n// FAQ 聽不懂，且低於次門檻\nconst faqUndecided = (\n    !hasFirstFAQ || (\n        hasFirstFAQ &&\n        node._.isBoolean(msg.report_stats.result.firstFAQ.undecided) &&\n        msg.report_stats.result.firstFAQ.undecided &&\n        !msg.isSuggestedFAQ\n    )\n);\n\n// NLU 聽不懂，且低於次門檻\nconst nluUndecided = (\n    hasFirstNLU &&\n    node._.isBoolean(msg.report_stats.result.firstNLU.undecided) &&\n    msg.report_stats.result.firstNLU.undecided &&\n    !msg.isSuggestedNLU\n);\n\n\nif (faqDecided) {\n    msg.report_stats.decidingStatus = 'FAQ';\n}\nelse if (nluDecided) {\n    msg.report_stats.decidingStatus = 'NLU';\n}\n// FAQ & NLU 推薦\nelse if (!!msg.isSuggestedFAQ && !!msg.isSuggestedNLU) {\n    msg.report_stats.decidingStatus = 'NLU & FAQ';\n}\n// FAQ 推薦\nelse if (!!msg.isSuggestedFAQ) {\n    msg.report_stats.decidingStatus = 'FAQ';\n}\n// NLU 推薦\nelse if (!!msg.isSuggestedNLU) {\n    msg.report_stats.decidingStatus = 'NLU';\n}\nelse if (!!hasFirstNLU || !!hasFirstFAQ) {\n    msg.report_stats.decidingStatus = 'Flow';\n}\n// 無經過 NLU / FAQ\nelse {\n    msg.report_stats.decidingStatus = 'Report';\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429957af51084b",
        "breakpoints": []
    },
    {
        "id": "ae06cf5aff7435f2ef0b.8825b43e5d5f",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "http request",
        "name": "總機 FAQ",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2537,
        "y": 1338,
        "wires": [
            [
                "3daf1a61a46b4210e8d9.19c47910abf9",
                "b1a6902defaa6d6183b1.a7f6d8069639"
            ]
        ],
        "_id": "61c99430f0429937f851084c",
        "breakpoints": [],
        "method": "use",
        "ret": "obj",
        "url": ""
    },
    {
        "id": "e82c4dd8974e8d3909a6.1ee30f4531da",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "http request",
        "name": "總機 NLU",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2537,
        "y": 1298,
        "wires": [
            [
                "f6d90b6db6050ed6de28.5036317f7e4b",
                "83f64aaac3dfed2fecd1.437ca83fbed5"
            ]
        ],
        "_id": "61c99430f04299aca351084d",
        "breakpoints": [],
        "method": "use",
        "ret": "obj",
        "url": ""
    },
    {
        "id": "32278867f7f2b1784cb5.b338c1fd18b3",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Set analysis",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3283,
        "y": 1310,
        "wires": [
            [
                "fa8e792b7a4583a4a992.f04589abfc5d"
            ]
        ],
        "func": "const AnalysisCtrl = msg.systalk.utils.AnalysisCtrl;\nconst ConfigCtrl = msg.systalk.utils.ConfigCtrl;\n\nconst lang = msg.systalk.lang;\nconst thresholdFirstNLU             = ConfigCtrl.getNLUThreshold(msg.config.names.firstNLU);\n// const thresholdFirstNLUSupport      = ConfigCtrl.getNLUThreshold(msg.config.names.firstNLUSupport);\nconst thresholdFirstFAQ             = ConfigCtrl.getFAQThreshold(msg.config.names.firstFAQ);\nconst fallbackScoreFirstNLU         = ConfigCtrl.getFallbackScore(msg.config.names.firstNLU);\n// const fallbackScoreFirstNLUSupport  = ConfigCtrl.getFallbackScore(msg.config.names.firstNLUSupport);\n\n// 2nd threshold\nconst secondThresholdFirstNLU             = ConfigCtrl.getNLUSecondThreshold(msg.config.names.firstNLU);\n// const secondThresholdFirstNLUSupport      = ConfigCtrl.getNLUSecondThreshold(msg.config.names.firstNLUSupport);\nconst secondThresholdFirstFAQ             = ConfigCtrl.getFAQSecondThreshold(msg.config.names.firstFAQ);\n\n// Mapping for Analysis\n// 總機\nif (!!msg.firstNLU) {\n    msg.overall_analysis.nlu.push(AnalysisCtrl.mapNLUResult(node._.cloneDeep(msg.firstNLU), {\n        isFirstNLU          : true,\n        threshold           : thresholdFirstNLU,\n        secondThreshold     : secondThresholdFirstNLU,\n        fallbackScore       : fallbackScoreFirstNLU,\n        name: msg.config.names.firstNLU\n    }));\n}\n\n// 服務台\n// if (!!msg.firstNLUSupport) {\n//     msg.overall_analysis.nlu.push(AnalysisCtrl.mapNLUResult(node._.cloneDeep(msg.firstNLUSupport), {\n//         threshold           : thresholdFirstNLUSupport,\n//         secondThreshold     : secondThresholdFirstNLUSupport,\n//         fallbackScore       : fallbackScoreFirstNLUSupport,\n//         name: msg.config.names.firstNLUSupport\n//     }));\n// }\n\n// FAQ\nif (!!msg.firstFAQ && Array.isArray(msg.firstFAQ.results) && msg.firstFAQ.results.length) {\n    msg.overall_analysis.faq.push(AnalysisCtrl.mapFAQResult(node._.cloneDeep(msg.firstFAQ.results[0]), {\n        isFirstFAQ          : true,\n        threshold           : thresholdFirstFAQ,\n        secondThreshold     : secondThresholdFirstFAQ,\n        name: msg.config.names.firstFAQ\n    }));\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042992ab351084e",
        "breakpoints": []
    },
    {
        "id": "58a575424eb020920d2e.3a9dc9dafdd3",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "紀錄 NLU, FAQ 結果",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "為提供跑分分析與報表呈現  \n須將 NLU, FAQ 結果保存  \n轉換紀錄所需格式，使用 `msg.systalk.utils.AnalysisCtrl` 中的方法  \n\n- `mapNLUResult(nlu, extras)`\n- `mapFAQResult(faq, extras)`\n\n並可再使用方法轉換成 Report 呈現需要格式\n\n- `mapNLUResultForReport(nlyAnalysisResult)`\n- `mapFAQResultForReport(faqAnalysisResult, extras)`\n\n資料格式如下：\n\n## NLU Anslysis Result\n\n```typescript\n{\n    sentence: string;\n    intents: IntentResult[];\n    entities: EntityResult[];\n    isFirstNLU: boolean;\n    isSecondNLU: boolean;\n    isThirdNLU: boolean;\n    threshold: number;\n}\n```\n\n### Intent Analysis Result\n\n```typescript\n{\n    intent_id: number;\n    intent: string;\n    score: number;\n}\n```\n\n### Entity Analysis Result\n\n```typescript\n{\n    entity_id: number;\n    info?: string;\n    text: string;\n    key_user_phrase?: string;\n    entity: string;\n}\n```\n\n## FAQ Analysis Result\n\n```typescript\n{\n    qid: number;\n    answer: string;\n    multichannel_answers: MultiChannelFAQAnswer[];\n    categories: string[];\n    score: number;\n    threshold: number;\n    isFirstFAQ: boolean;\n}\n```\n\n### FAQ Multi Channel Answer\n\n```typescript\n{\n    channel: string;\n    answer: string;\n}\n```\n\n\n## NLU Report Stats\n\n```typescript\n{\n    intent: string;\n    undecided: boolean;\n}\n```\n\n## FAQ Report Stats\n\n```typescript\n{\n    qid: number;\n    score: number;\n    undecided: number;\n    parentCategory?: string;\n    childCategory?: string;\n}\n```\n",
        "in": [],
        "out": [],
        "x": 3273,
        "y": 1270,
        "wires": [],
        "_id": "61c99430f042994ad651084f",
        "breakpoints": []
    },
    {
        "id": "ee5ae8e00f89d3e19727.0022cbdf121e",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "建議選項",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3899.666742324829,
        "y": 1514.3333110809326,
        "wires": [
            []
        ],
        "func": "// const ReplyMsgFactory   = msg.systalk.utils.ReplyMsgFactory;\n// const ConfigCtrl        = msg.systalk.utils.ConfigCtrl;\n\n// 不結束對話\nmsg._end_dialogue = false;\n\nlet options = [];\n\nif (Array.isArray(msg.suggestedFAQQuestions) && msg.suggestedFAQQuestions.length) {\n    msg.suggestedFAQQuestions.slice(0, msg.config.maxSuggestdNumber)\n        .forEach(question => {\n            options.push({\n                action: 1,\n                data: question,\n                text: question\n            });\n        });\n}\nif (Array.isArray(msg.suggestedNLUIntents) && msg.suggestedNLUIntents.length) {\n    msg.suggestedNLUIntents.slice(0, msg.config.maxSuggestdNumber)\n        .forEach(intent => {\n            options.push({\n                action: 1,\n                data: intent,\n                text: intent\n            });\n        });\n}\n\n\nmsg.messages = {\n    code: 0,\n    msg: \"成功\",\n    data: {\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: msg.config.role,\n        content: [\n            {\n                type: 1,\n                text: \"我猜你想問的是：\"\n            }\n        ]\n    }\n};\n\nif (options.length) {\n    msg.messages.data.content.push({\n        type: 2,\n        cards:[{\n            width: 'segment secard rhetorical',\n            linkList: options\n        }]\n    });\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299db9e510850",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "ac95b1bb06d631edbd43.71e66204c29e",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "undecided",
        "name": "",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3663.666742324829,
        "y": 1514.3333110809326,
        "wires": [
            [
                "ee5ae8e00f89d3e19727.0022cbdf121e"
            ]
        ],
        "_id": "61c99430f042994cb2510851",
        "breakpoints": [],
        "msg_variable": "text"
    },
    {
        "id": "d185d59274f9fd505976.e026f97b9c59",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "標記聽不懂與SORT",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "當通過 __undecided__ 節點  \n會將 __message from__ 欄位指定的屬性值，紀錄在 `msg._undecided_msg`  \n並設定 `msg._undecided` 為 `true`\n\nSORT (分類帽) 的排程與 DB匯出會篩選出 `msg._undecided` 為 `true` 的 `msg._undecided_msg` \n",
        "in": [],
        "out": [],
        "x": 4246.333251953125,
        "y": 1147.333251953125,
        "wires": [],
        "_id": "61c99430f042992cf5510852",
        "breakpoints": []
    },
    {
        "id": "042f7c174f21edbab9bb.8006fa3a9c05",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "FAQ ans",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "systalk.faqState.answer",
        "x": 3903.666820526123,
        "y": 1330.3333463668823,
        "wires": [],
        "_id": "61c99430f042997773510853",
        "breakpoints": []
    },
    {
        "id": "83f64aaac3dfed2fecd1.437ca83fbed5",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Error/Success",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2728,
        "y": 1298,
        "wires": [
            [
                "e363b140da050403aa16.cca52d18ef61"
            ]
        ],
        "func": "// 清除http設定\nmsg.headers = undefined;\nmsg.method = undefined;\nmsg.url = undefined;\n\nmsg.payload._timeAfterResponse = new Date();\n\nif (!node._.isNumber(msg.statusCode) ||\n    msg.statusCode < 200 ||\n    msg.statusCode >= 300) {\n        \n    msg.error = `Request 總機 NLU 發生錯誤: ${JSON.stringify(msg.payload)}`;\n}\n\nmsg.statusCode = undefined;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299f9b6510854",
        "breakpoints": []
    },
    {
        "id": "b1a6902defaa6d6183b1.a7f6d8069639",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Error/Success",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2728,
        "y": 1338,
        "wires": [
            [
                "e363b140da050403aa16.cca52d18ef61"
            ]
        ],
        "func": "// 清除http設定\nmsg.headers = undefined;\nmsg.method = undefined;\nmsg.url = undefined;\n\nmsg.payload._timeAfterResponse = new Date();\n\nif (!node._.isNumber(msg.statusCode) ||\n    msg.statusCode < 200 ||\n    msg.statusCode >= 300) {\n        \n    msg.error = `Request 總機 FAQ 發生錯誤: ${JSON.stringify(msg.payload)}`;\n}\n\nmsg.statusCode = undefined;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299d1e7510855",
        "breakpoints": []
    },
    {
        "id": "58fef6c0421c3432440d.1d8d77e724a8",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "Flow 發生錯誤",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 198,
        "y": 3348,
        "wires": [
            [
                "aa18af26c15d8ee16ec3.135a59b9faf8"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299c734510856",
        "breakpoints": [],
        "rules": [
            {
                "t": "nnull",
                "p": "error"
            },
            {
                "t": "nnull",
                "p": "messages"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "aa18af26c15d8ee16ec3.135a59b9faf8",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "發生錯誤轉真人",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 436,
        "y": 3348,
        "wires": [
            [
                "d7e14385c3b6148483c9.d570bb38153a"
            ]
        ],
        "func": "const ChatWebUtils = msg.systalk.utils.ChatWebUtils;\n\n// 結束對話\nmsg._end_dialogue = true;\n\nmsg.messages = ChatWebUtils.createErrorResponse([\n    {\n        type: 1,\n        text: \"抱歉~小咩正在維護中。\"\n    }\n]);\n\n// msg.messages.data.content.push({\n//     type: 1,\n//     text: \"抱歉~小咩正在維護中，請您稍後再試！是否需為您轉接真人文字客服，由小咩學姊為您服務呢？\"\n// });\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429910dc510857",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "5f8774b70e88785f6c3f.e44aec7827e0",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "!!注意!! 需處理 HTTP 錯誤狀況",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "- HTTP Response 時，可透過 `msg.statusCode` 設定 flow 回應的 status  \n  但，HTTP Request 也會將回應的 status 寫入 `msg.statusCode`  \n  __請清除，若有需要，給予 status code__\n\n- 發生錯誤時，為避免影響後續流程，並告知使用者，可判斷 status  \n  再導向至產生錯誤訊息回應的流程",
        "in": [],
        "out": [],
        "x": 2778.381134033203,
        "y": 1212.3333702087402,
        "wires": [],
        "_id": "61c99430f0429965c2510858",
        "breakpoints": []
    },
    {
        "id": "8721a8ea0246a4db62f4.82fa39f88185",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "Error",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1897,
        "y": 1357,
        "wires": [
            []
        ],
        "func": "\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042997767510859",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "b9f6b3a9b2e521f09403.fbd6c7d187fa",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "!!注意!! 未設定 API 時 Error Handling",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "當缺少 FAQ / 總機 NLU API，送出錯誤訊息",
        "in": [],
        "out": [],
        "x": 1482,
        "y": 1452,
        "wires": [],
        "_id": "61c99430f04299984c51085a",
        "breakpoints": []
    },
    {
        "id": "f8b6a13cc6038fbcc5bd.88b510b65d06",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "!!注意!! Error Handling",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "在 Flow 中 function / state node 發生 Exception 會以該節點收到的 msg 再帶出  \n因此 Catch node 雖然在 Exception 發生時也會被觸發，但 __原有流程如無特別處理__ 仍會繼續\n\nCatch Error 僅透過 debug 列出，不等待合併帶出",
        "in": [],
        "out": [],
        "x": 227,
        "y": 3194,
        "wires": [],
        "_id": "61c99430f04299346e51085b",
        "breakpoints": []
    },
    {
        "id": "7b9966372a50501fede0.151268029f45",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "!!注意!! 空訊息處理",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "當流程發生錯誤時，`msg.messages` 容易為空  \n導致無合法的訊息可供 client 顯示  \n\n因此，需要針對 **空訊息** 處理  \n定義一個表示無任何回應的訊息顯示\n\n如：`{ type: 1, text: '<NO_REPLY>' }`",
        "in": [],
        "out": [],
        "x": 866,
        "y": 3590,
        "wires": [],
        "_id": "61c99430f042994a4251085c",
        "breakpoints": []
    },
    {
        "id": "675ef9a3276e2824604e.fafd359c1148",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "catch",
        "name": "",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 188,
        "y": 3388,
        "wires": [
            [
                "d7e14385c3b6148483c9.d570bb38153a",
                "aa18af26c15d8ee16ec3.135a59b9faf8"
            ]
        ],
        "_id": "61c99430f04299c5d551085d",
        "breakpoints": [],
        "scope": null
    },
    {
        "id": "d7e14385c3b6148483c9.d570bb38153a",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "Exception",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "error",
        "x": 658,
        "y": 3388,
        "wires": [],
        "_id": "61c99430f042990a4251085e",
        "breakpoints": []
    },
    {
        "id": "568986162ed2831bae0a.d104eddc3c21",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "公用 Utils 定義",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "\n\n",
        "in": [],
        "out": [],
        "x": 404,
        "y": 403,
        "wires": [],
        "_id": "61c99430f042995c8251085f",
        "breakpoints": []
    },
    {
        "id": "c5aa04c07a1bf1990454.d9711ee37624",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Shared Utils",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 404,
        "y": 443,
        "wires": [
            [
                "b3d5132f79ab35f55489.3f5b202f6671"
            ]
        ],
        "func": "/**\n * This file define utils for Demo Kit and template.\n * Could be copied into a function node or import as function library (current not working).\n * \n * Define in `msg.systalk.utils`\n * 定義在 `function node`，會使用到 `Lodash`（定義在 `node._`）\n */\n\n/**\n * Request message types\n * 總機與各 bot 的 Request 訊息類別\n */\nclass ReqMsgTypes {\n    constructor() {\n        this._text = 1;\n        this._textType = 'text';\n        this._speech = 2;\n        this._speechType = 'speech';\n        this._fromOnlineService = 3;\n        this._fromOnlineServiceType = 'from_online_service';\n        this._fromAuthorization = 4;\n        this._fromAuthorizationType = 'from_authorization';\n        this._fromLocation = 5;\n        this._fromLocationType = 'from_location';\n        this._signal = 6;\n        this._signalType = 'signal';\n        this._config = 7;\n        this._configType = 'config';\n        this._grade = 8;\n        this._gradeType = 'grade';\n        this._initSession = 9;\n        this._initSessionType = 'init_session';\n    }\n    get text() { return this._text; }\n    get textType() { return this._textType }\n    get speech() { return this._speech; }\n    get speechType() { return this._speechType; }\n    get fromOnlineService() { return this._fromOnlineService; }\n    get fromOnlineServiceType() { return this._fromOnlineServiceType; }\n    get fromAuthorization() { return this._fromAuthorization; }\n    get fromAuthorizationType() { return this._fromAuthorizationType; }\n    get fromLocation() { return this._fromLocation; }\n    get fromLocationType() { return this._fromLocationType; }\n    get signal() { return this._signal; }\n    get signalType() { return this._signalType; }\n    get config() { return this._config; }\n    get configType() { return this._configType; }\n    get grade() { return this._grade; }\n    get gradeType() { return this._gradeType; }\n    get initSession() { return this._initSession; }\n    get initSessionType() { return this._initSessionType; }\n\n    isText(val) {\n        return val === this.text || val === this.textType;\n    }\n    isSpeech(val) {\n        return val === this.speech || val === this.speechType;\n    }\n    isFromOnlineService(val) {\n        return val === this.fromOnlineService || val === this.fromOnlineServiceType;\n    }\n    isFromAuthorization(val) {\n        return val === this.fromAuthorization || val === this.fromAuthorizationType;\n    }\n    isFromLocation(val) {\n        return val === this.fromLocation || val === this.fromLocationType;\n    }\n    isSignal(val) {\n        return val === this.signal || val === this.signalType;\n    }\n    isConfig(val) {\n        return val === this.config || val === this.configType;\n    }\n    isGrade(val) {\n        return val === this.grade || val === this.gradeType;\n    }\n    isInitSession(val) {\n        return val === this.initSession || val === this.initSessionType;\n    }\n}\n\nconst reqMsgTypes = new ReqMsgTypes();\n\n/**\n* Reply message types\n*/\nclass ReplyMsgTypes {\n    constructor() {\n        this._text = 1;\n        this._textType = 'text';\n        this._speech = 2;\n        this._speechType = 'speech';\n        this._image = 3;\n        this._imageType = 'image';\n        this._sticker = 4;\n        this._stickerType = 'sticker';\n        this._link = 5;\n        this._linkType = 'link';\n        this._dataList = 6;\n        this._dataListType = 'data_list';\n        this._yesOrNo = 7;\n        this._yesOrNoType = 'yes_or_no';\n        this._toCustomerService = 8;\n        this._toCustomerServiceType = 'to_customer_service';\n        this._toOnlineService = 9;\n        this._toOnlineServiceType = 'to_online_service';\n        this._toAuthorization = 10;\n        this._toAuthorizationType = 'to_authorization';\n        this._toLocation = 11;\n        this._toLocationType = 'to_location';\n        this._redirectBot = 12;\n        this._redirectBotType = 'redirect_bot';\n        this._options = 13;\n        this._optionsType = 'options';\n        this._status = 14;\n        this._statusType = 'status';\n        this._action = 15;\n        this._actionType = 'action';\n        this._generalInfo = 16;\n        this._generalInfoType = 'info_general';\n    }\n\n    get text() { return this._text; }\n    get textType() { return this._textType; }\n    get speech() { return this._speech; }\n    get speechType() { return this._speechType; }\n    get image() { return this._image; }\n    get imageType() { return this._imageType; }\n    get sticker() { return this._sticker; }\n    get stickerType() { return this._stickerType; }\n    get link() { return this._link; }\n    get linkType() { return this._linkType; }\n    get dataList() { return this._dataList; }\n    get dataListType() { return this._dataListType; }\n    get yesOrNo() { return this._yesOrNo; }\n    get yesOrNoType() { return this._yesOrNoType; }\n    get toCustomerService() { return this._toCustomerService; }\n    get toCustomerServiceType() { return this._toCustomerServiceType; }\n    get toOnlineService() { return this._toOnlineService; }\n    get toOnlineServiceType() { return this._toOnlineServiceType; }\n    get toAuthorization() { return this._toAuthorization; }\n    get toAuthorizationType() { return this._toAuthorizationType; }\n    get toLocation() { return this._toLocation; }\n    get toLocationType() { return this._toLocationType; }\n    get redirectBot() { return this._redirectBot; }\n    get redirectBotType() { return this._redirectBotType; }\n    get options() { return this._options; }\n    get optionsType() { return this._optionsType; }\n    get status() { return this._status; }\n    get statusType() { return this._statusType; }\n    get action() { return this._action; }\n    get actionType() { return this._actionType; }\n    get generalInfo() { return this._generalInfo; }\n    get generalInfoType() { return this._generalInfoType; }\n\n    /**\n     * Check type value is 'text' type or not\n     */\n    isText(val) {\n        return val === this.text || val === this.textType;\n    }\n    isSpeech(val) {\n        return val === this.speech || val === this.speechType;\n    }\n    isImage(val) {\n        return val === this.image || val === this.imageType;\n    }\n    isSticker(val) {\n        return val === this.sticker || val === this.stickerType;\n    }\n    isLink(val) {\n        return val === this.link || val === this.linkType;\n    }\n    isDataList(val) {\n        return val === this.dataList || val === this.dataListType;\n    }\n    isYesOrNo(val) {\n        return val === this.yesOrNo || val === this.yesOrNoType;\n    }\n    isToCustomerService(val) {\n        return val === this.toCustomerService || val === this.toCustomerServiceType;\n    }\n    isToOnlineService(val) {\n        return val === this.toOnlineService || val === this.toOnlineServiceType;\n    }\n    isToAuthorization(val) {\n        return val === this.toAuthorization || val === this.toAuthorizationType;\n    }\n    isToLocation(val) {\n        return val === this.toLocation || val === this.toLocationType;\n    }\n    isRedirectBot(val) {\n        return val === this.redirectBot || val === this.redirectBotType;\n    }\n    isOptions(val) {\n        return val === this.options || val === this.optionsType;\n    }\n    isStatus(val) {\n        return val === this.status || val === this.statusType;\n    }\n    isAction(val) {\n        return val === this.action || val === this.actionType;\n    }\n    isGeneralInfo(val) {\n        return val === this.generalInfo || val === this.generalInfoType;\n    }\n}\n\nconst replyMsgTypes = new ReplyMsgTypes();\n\n/**\n* Signals\n*/\nclass ReqSignals {\n    constructor() {\n        this._start = 1;\n        this._startSignal = 'start';\n        this._continue = 2;\n        this._continueSignal = 'continue';\n        this._end = 3;\n        this._endSignal = 'end';\n        this._idle = 4;\n        this._idleSignal = 'idle';\n        this._quit = 5;\n        this._quitSignal = 'quit';\n        this._passedFromCustomerService = 6;\n        this._passedFromCustomerServiceSignal = 'passed_from_customer_service';\n    }\n\n    get start() { return this._start; }\n    get startSignal() { return this._startSignal; }\n    get continue() { return this._continue; }\n    get continueSignal() { return this._continueSignal; }\n    get end() { return this._end; }\n    get endSignal() { return this._endSignal; }\n    get idle() { return this._idle; }\n    get idleSignal() { return this._idleSignal; }\n    get quit() { return this._quit; }\n    get quitSignal() { return this._quitSignal; }\n    get passedFromCustomerService() { return this._passedFromCustomerService; }\n    get passedFromCustomerServiceSignal() { return this._passedFromCustomerServiceSignal; }\n\n\n    isStart(val) {\n        return val === this.start || (typeof val === 'string' && val.toLowerCase() === this.startSignal);\n    }\n    isEnd(val) {\n        return val === this.end || (typeof val === 'string' && val.toLowerCase() === this.endSignal);\n    }\n    isContinue(val) {\n        return val === this.continue || (typeof val === 'string' && val.toLowerCase() === this.continueSignal);\n    }\n    isIdle(val) {\n        return val === this.idle || (typeof val === 'string' && val.toLowerCase() === this.idleSignal);\n    }\n    isQuit(val) {\n        return val === this.quit || (typeof val === 'string' && val.toLowerCase() === this.quitSignal);\n    }\n    isPassedFromCustomerService(val) {\n        return val === this.passedFromCustomerService || (typeof val === 'string' && val.toLowerCase() === this.passedFromCustomerServiceSignal);\n    }\n}\n\nconst reqSignals = new ReqSignals();\n\n/**\n * Controller for request channels\n */\nclass ReqChannels {\n    constructor() {\n    }\n\n    /**\n     * Channel object with default name `text`\n     *\n     * @readonly\n     * @memberof ReqChannels\n     */\n    get text() {\n        return new Channel('文字', { isText: true, isSpeech: false });\n    }\n\n    /**\n     * Channel object of default name `speech`\n     *\n     * @readonly\n     * @memberof ReqChannels\n     */\n    get speech() {\n        return new Channel('語音', { isText: false, isSpeech: true });\n    }\n\n    /**\n     * If the chanel supports message type of `text`\n     * @param {Channel} val Channel object\n     */\n    isText(val) {\n        return !node._.isNil(val) && val.isText;\n    }\n\n    /**\n     * If the channel supports message type of `speech`\n     * @param {Channel} val Channel object\n     */\n    isSpeech(val) {\n        return !node._.isNil(val) && val.isSpeech;\n    }\n}\n\nconst reqChannels = new ReqChannels();\n\n/**\n * Channel object\n * @property {string} name\n * @property {boolean} isText if this channel supports text messages\n * @property {boolean} isSpeech if this channel \n */\nclass Channel {\n    constructor(nameOrChannel, configs) {\n        if (!node._.isNil(nameOrChannel) &&\n            node._.isString(nameOrChannel.name) &&\n            node._.isBoolean(nameOrChannel.isText) && node._.isBoolean(nameOrChannel.isSpeech)) {\n            this.name = nameOrChannel.name;\n            this.isText = nameOrChannel.isText;\n            this.isSpeech = nameOrChannel.isSpeech;\n        }\n        if (node._.isString(nameOrChannel)) {\n            this.name = nameOrChannel;\n        }\n        if (!node._.isNil(configs)) {\n            this.isText = configs.isText || false;\n            this.isSpeech = configs.isSpeech || false;\n        }\n    }\n\n    valueOf() {\n        return this.name;\n    }\n\n    toString() {\n        return this.name;\n    }\n}\n\nclass ReplyActionTypes {\n    constructor() {\n        this._grading = 'grading';\n        this._end = 'end';\n        this._renew = 'renew';\n    }\n\n    get grading() { return this._grading; }\n    get end() { return this._end; }\n    get renew() { return this._renew; }\n\n    isGrading(val) {\n        return val === this.grading;\n    }\n    isEnd(val) {\n        return val === this.end;\n    }\n    isRenew(val) {\n        return val === this._renew;\n    }\n}\n\nconst replyActionTypes = new ReplyActionTypes();\n\n/**\n* Reply message factory\n* recommand to use `create()`\n*/\nclass ReplyMsgFactory {\n    createText(text) {\n        if (node._.isString(text)) {\n            return {\n                type: replyMsgTypes.text,\n                text: text\n            };\n        }\n        return null;\n    }\n    createTextType(text) {\n        if (node._.isString(text)) {\n            return {\n                type: replyMsgTypes.textType,\n                text: text\n            };\n        }\n        return null;\n    }\n    createSpeech(speech) {\n        if (node._.isString(speech)) {\n            return {\n                type: replyMsgTypes.speech,\n                speech: speech\n            };\n        }\n        return null;\n    }\n    createSpeechType(speech) {\n        if (node._.isString(speech)) {\n            return {\n                type: replyMsgTypes.speechType,\n                speech: speech\n            };\n        }\n        return null;\n    }\n    createImage(title, alt, imgUrl) {\n        return {\n            type: replyMsgTypes.image,\n            title: title,\n            alt: alt,\n            imgUrl: imgUrl\n        };\n    }\n    /**\n     * 建立圖片類型訊息\n     * @param {*} params { title, alt, imgUrl }\n     */\n    createImageType(params) {\n        let msg = {\n            type: replyMsgTypes.imageType\n        };\n        if (params) {\n            if (params.title) {\n                msg.title = params.title;\n            }\n            if (params.alt) {\n                msg.alt = params.alt;\n            }\n            if (params.imgUrl) {\n                msg.imgUrl = params.imgUrl;\n            }\n        }\n        return msg;\n    }\n    createSticker(alt, stickerUrl) {\n        return {\n            type: replyMsgTypes.sticker,\n            alt: alt,\n            imgUrl: stickerUrl\n        };\n    }\n    /**\n     * 建立貼圖類型訊息\n     * @param {*} params { alt, imgUrl }\n     */\n    createStickerType(params) {\n        let msg = {\n            type: replyMsgTypes.stickerType\n        };\n        if (params) {\n            if (params.alt) {\n                msg.alt = params.alt;\n            }\n            if (params.imgUrl) {\n                msg.imgUrl = params.imgUrl;\n            }\n        }\n        return msg;\n    }\n    createLink(title, url, data) {\n        let reply = {\n            type: replyMsgTypes.link,\n            text: title, // TODO: deprecated\n            title: title,\n            url: url\n        };\n        reply = Object.assign(reply, data);\n        return reply;\n    }\n    /**\n     * 建立連結類型訊息\n     * @param {*} params { title, url }\n     */\n    createLinkType(params) {\n        let reply = {\n            type: replyMsgTypes.linkType\n        };\n        if (params) {\n            if (params.title) {\n                reply.title = params.title;\n            }\n            if (params.url) {\n                reply.url = params.url;\n            }\n        }\n        return reply;\n    }\n    createDataList(data, title) {\n        return {\n            type: replyMsgTypes.dataList,\n            title: title,\n            data: Array.isArray(data) ? data : [data]\n        };\n    }\n    /**\n     * 建立 data list 類型訊息\n     * @param {*} params { data, title, botType, intent }\n     */\n    createDataListType(params) {\n        let reply = {\n            type: replyMsgTypes.dataListType\n        };\n        if (params) {\n            if (Array.isArray(params.data) && params.data.length) {\n                reply.data = node._.cloneDeep(params.data);\n            }\n            if (params.title) {\n                reply.title = params.title;\n            }\n            if (params.botType) {\n                reply.botType = params.botType;\n            }\n            if (params.intent) {\n                reply.intent = params.intent;\n            }\n        }\n        return reply;\n    }\n    createYesOrNo(yesText, noText) {\n        return {\n            type: replyMsgTypes.yesOrNo,\n            yes: yesText,\n            no: noText\n        };\n    }\n    /**\n     * 建立 yes/no 選項訊息\n     * @param {*} params { yes, no }\n     */\n    createYesOrNoType(params) {\n        let reply = {\n            type: replyMsgTypes.yesOrNoType\n        };\n        if (params) {\n            if (params.yes) {\n                reply.yes = params.yes;\n            }\n            if (params.no) {\n                reply.no = params.no;\n            }\n        }\n        return reply;\n    }\n    createToCustomerService(options) {\n        let reply = {\n            type: replyMsgTypes.toCustomerService\n        };\n        if (node._.isObject(options)) {\n            for (let prop in options) {\n                reply[prop] = options[prop];\n            }\n        }\n        return reply;\n    }\n    createToCustomerServiceType(options) {\n        let reply = {\n            type: replyMsgTypes.toCustomerServiceType\n        };\n        if (node._.isObject(options)) {\n            for (let prop in options) {\n                reply[prop] = options[prop];\n            }\n        }\n        return reply;\n    }\n    createToOnlineService(options) {\n        let reply = {\n            type: replyMsgTypes.toOnlineService\n        };\n        if (node._.isObject(options)) {\n            for (let prop in options) {\n                reply[prop] = options[prop];\n            }\n        }\n        return reply;\n    }\n    createToOnlineServiceType(options) {\n        let reply = {\n            type: replyMsgTypes.toOnlineServiceType\n        };\n        if (node._.isObject(options)) {\n            for (let prop in options) {\n                reply[prop] = options[prop];\n            }\n        }\n        return reply;\n    }\n    createToAuthorization(options) {\n        let reply = {\n            type: replyMsgTypes.toAuthorization,\n        };\n        if (node._.isObject(options)) {\n            for (let prop in options) {\n                reply[prop] = options[prop];\n            }\n        }\n        return reply;\n    }\n    createToAuthorizationType(options) {\n        let reply = {\n            type: replyMsgTypes.toAuthorizationType\n        };\n        if (node._.isObject(options)) {\n            for (let prop in options) {\n                reply[prop] = options[prop];\n            }\n        }\n        return reply;\n    }\n    createToLocation(botType, entities, location) {\n        return {\n            type: replyMsgTypes.toLocation,\n            botType: botType,\n            location: location,\n            entities: entities\n        };\n    }\n    /**\n     * 建立需取得定位訊息\n     * @param {*} params { botType, intent }\n     */\n    createToLocationType(params) {\n        let reply = {\n            type: replyMsgTypes.toLocationType\n        };\n        if (params) {\n            if (params.botType) {\n                reply.botType = params.botType;\n            }\n            if (params.intent) {\n                reply.intent = params.intent;\n            }\n        }\n        return reply;\n    }\n    createRedirectBot(opts) {\n        return {\n            type: replyMsgTypes.redirectBot,\n            botType: opts && opts.botType,\n            intent: opts && opts.intent,\n            entities: opts && opts.entities,\n            data: opts && opts.data\n        };\n    }\n    /**\n     * 建立要求總機重新導向 second bot 類型訊息\n     * @param {*} params { botType, intent, entities, data }\n     */\n    createRedirectBotType(params) {\n        let reply = {\n            type: replyMsgTypes.redirectBotType\n        };\n        if (params) {\n            if (params.botType) {\n                reply.botType = params.botType;\n            }\n            if (params.intent) {\n                reply.intent = params.intent;\n            }\n            if (params.entities) {\n                reply.entities = node._.cloneDeep(params.entities);\n            }\n            if (params.data) {\n                reply.data = node._.cloneDeep(params.data);\n            }\n        }\n        return reply;\n    }\n    /**\n     * 建立 options 訊息物件\n     * data 陣列中僅允許包含 text, speech, image, sticker, link\n     * @param opts <Option_Item>[] Including properties : title, payload, url\n     * @param title string Title\n     */\n    createOptions(opts, title) {\n        const ctrl = new ReplyMsgCtrl();\n        let options = Array.isArray(opts) ? [].concat(opts) : [opts];\n        options = options.filter(opt => {\n            return !!opt && (opt.title && (opt.payload || opt.url));\n        });\n\n        let reply = {\n            type: replyMsgTypes.options\n        };\n        if (options) {\n            reply.data = options;\n        }\n        if (title) {\n            reply.title = title;\n        }\n        return reply;\n    }\n    /**\n     * 建立選項類型訊息\n     * @param {*} params { opts, title }\n     */\n    createOptionsType(params) {\n        let reply = {\n            type: replyMsgTypes.optionsType\n        };\n\n        if (params) {\n            let options = Array.isArray(params.opts) ? [].concat(opts) : [opts];\n            options = options.filter(opt => {\n                return !!opt && (opt.title && (opt.payload || opt.url));\n            });\n\n\n            if (options) {\n                reply.data = node._.cloneDeep(options);\n            }\n            if (title) {\n                reply.title = title;\n            }\n        }\n        return reply;\n    }\n    createStatus(code, msg) {\n        return {\n            type: replyMsgTypes.status,\n            status: {\n                code: code,\n                message: msg\n            }\n        };\n    }\n    /**\n     * 建立狀態訊息\n     * @param {*} params { status: { code, message } }\n     */\n    createStatusType(params) {\n        let reply = {\n            type: replyMsgTypes.statusType\n        };\n        if (params) {\n            if (params.status) {\n                reply.status = node._.cloneDeep(params.status);\n            }\n        }\n        return reply;\n    }\n    createAction(actionType) {\n        return {\n            type: replyMsgTypes.action,\n            action: actionType\n        };\n    }\n    /**\n     * 建立動作訊息\n     * @param {*} params { action }\n     */\n    createActionType(params) {\n        let reply = {\n            type: replyMsgTypes.actionType\n        };\n        if (params) {\n            if (params.action) {\n                reply.action = params.action;\n            }\n        }\n        return reply;\n    }\n    create(data) {\n        const reply = {};\n        if (data.type) { reply.type = data.type; }\n        if (data.text) { reply.text = data.text; }\n        if (data.speech) { reply.speech = data.speech; }\n        if (data.title) { reply.title = data.title; }\n        if (data.alt) { reply.alt = data.alt; }\n        if (data.imgUrl) { reply.imgUrl = data.imgUrl; }\n        if (data.url) { reply.url = data.url; }\n        if (data.data) { reply.data = node._.cloneDeep(data.data); }\n        if (data.yes) { reply.yes = data.yes; }\n        if (data.no) { reply.no = data.no; }\n        if (data.userId) { reply.userId = data.userId; }\n        if (data.botType) { reply.botType = data.botType; }\n        if (data.intent) { reply.intent = data.intent; }\n        if (data.entities) { reply.entities = node._.cloneDeep(data.entities); }\n        if (data.location) { reply.location = node._.cloneDeep(data.location); }\n        if (data.action) { reply.action = data.action; }\n        if (data.status) { reply.status = node._.cloneDeep(data.status); }\n        if (data.postbackReq) { reply.postbackReq = node._.cloneDeep(data.postbackReq); }\n        return reply;\n    }\n}\n\nclass ReqMsgCtrl {\n    isText(msg) {\n        return !!msg && msg.message ? reqMsgTypes.isText(msg.message.type) : reqMsgTypes.isText(msg.type);\n    }\n\n    isSpeech(msg) {\n        return !!msg && msg.message ? reqMsgTypes.isSpeech(msg.message.type) : reqMsgTypes.isSpeech(msg.type);\n    }\n\n    isFromOnlineService(msg) {\n        return !!msg && msg.message ? reqMsgTypes.isFromOnlineService(msg.message.type) : reqMsgTypes.isFromOnlineService(msg.type);\n    }\n\n    isFromAuthorization(msg) {\n        return !!msg && msg.message ? reqMsgTypes.isFromAuthorization(msg.message.type) : reqMsgTypes.isFromAuthorization(msg.type);\n    }\n\n    isFromLocation(msg) {\n        return !!msg && msg.message ? reqMsgTypes.isFromLocation(msg.message.type) : reqMsgTypes.isFromLocation(msg.type);\n    }\n\n    isSignal(msg) {\n        return !!msg && msg.message ? reqMsgTypes.isSignal(msg.message.type) : reqMsgTypes.isSignal(msg.type);\n    }\n\n    isStartSignal(msg) {\n        return this.isSignal(msg) && !!msg.message.signal && reqSignals.isStart(msg.message.signal);\n    }\n\n    isContinueSignal(msg) {\n        return this.isSignal(msg) && !!msg.message.signal && reqSignals.isContinue(msg.message.signal);\n    }\n\n    isEndSignal(msg) {\n        return this.isSignal(msg) && !!msg.message.signal && reqSignals.isEnd(msg.message.signal);\n    }\n\n    isIdleSignal(msg) {\n        return this.isSignal(msg) && !!msg.message.signal && reqSignals.isIdle(msg.message.signal);\n    }\n\n    isQuitSignal(msg) {\n        return this.isSignal(msg) && !!msg.message.signal && reqSignals.isQuit(msg.message.signal);\n    }\n\n    isPassedFromCustomerServiceSignal(msg) {\n        return this.isSignal(msg) && !!msg.message.signal && reqSignals.isPassedFromCustomerService(msg.message.signal);\n    }\n\n    isConfig(msg) {\n        return !!msg && msg.message ? reqMsgTypes.isConfig(msg.message.type) : reqMsgTypes.isConfig(msg.type);\n    }\n\n    isGrade(msg) {\n        return !!msg && msg.message ? reqMsgTypes.isGrade(msg.message.type) : reqMsgTypes.isGrade(msg.type);\n    }\n\n    isInitSession(msg) {\n        return !!msg && msg.message ? reqMsgTypes.isInitSession(msg.message.type) : reqMsgTypes.isInitSession(msg.type);\n    }\n\n    /**\n     * Normalize message's channel\n     * By default, channel would be a text channel\n     * @param {any} reqMsg request message object\n     */\n    normalize(reqMsg) {\n        if (!reqMsg || !reqMsg.message) {\n            return;\n        }\n        let channelObj = this._normalizeChannel(reqMsg.channel) || reqChannels.text;\n        if (!node._.isNil(channelObj)) {\n            reqMsg.channel = node._.clone(channelObj);\n        }\n    }\n\n\n    /**\n     * Normalize channel object\n     * @param {any} channel \n     */\n    _normalizeChannel(channel) {\n        let channelObj = null; // set the default channel\n        if (node._.isNumber(channel)) {\n            // If the channel is number, and > 0\n            // it would be deprecated channel type, convert it.\n            if (channel > 0) {\n                channelObj = new Channel(channel.toString(), {\n                    isText: channel & 1 === 1,\n                    isSpeech: channel & 2 === 2\n                });\n            }\n            else {\n                channelObj = new Channel(channel.toString(), {\n                    isText: true,\n                    isSpeech: false\n                });\n            }\n        }\n        else if (node._.isString(channel)) {\n            channelObj = new Channel(channel, {\n                isText: true,\n                isSpeech: false\n            });\n        }\n        else if (!node._.isNil(channel) &&\n            node._.isString(channel.name)) {\n            channelObj = new Channel(channel.name, {\n                isText: node._.isBoolean(channel.isText) ? channel.isText : !!channel.isText,\n                isSpeech: node._.isBoolean(channel.isSpeech) ? channel.isSpeech : !!channel.isSpeech\n            });\n        }\n        return channelObj;\n    }\n}\n\nclass ReplyMsgCtrl {\n    isText(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isText(msg.type);\n    }\n\n    isSpeech(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isSpeech(msg.type);\n    }\n\n    isImage(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isImage(msg.type);\n    }\n\n    isSticker(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isSticker(msg.type);\n    }\n\n    isLink(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isLink(msg.type);\n    }\n\n    isDataList(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isDataList(msg.type);\n    }\n\n    isYesOrNo(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isYesOrNo(msg.type);\n    }\n\n    isToCustomerService(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isToCustomerService(msg.type);\n    }\n\n    isToOnlineService(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isToOnlineService(msg.type);\n    }\n\n    isToAuthorization(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isToAuthorization(msg.type);\n    }\n\n    isToLocation(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isToLocation(msg.type);\n    }\n\n    isRedirectBot(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isRedirectBot(msg.type);\n    }\n\n    isOptions(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isOptions(msg.type);\n    }\n\n    isStatus(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isStatus(msg.type);\n    }\n\n    isAction(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isAction(msg.type);\n    }\n\n    isGeneralInfo(msg) {\n        return !!msg && !!msg.type && replyMsgTypes.isGeneralInfo(msg.type);\n    }\n\n    isValid(msg) {\n        return this.isText(msg) ||\n            this.isSpeech(msg) ||\n            this.isImage(msg) ||\n            this.isSticker(msg) ||\n            this.isLink(msg) ||\n            this.isDataList(msg) ||\n            this.isYesOrNo(msg) ||\n            this.isToCustomerService(msg) ||\n            this.isToOnlineService(msg) ||\n            this.isToAuthorization(msg) ||\n            this.isToLocation(msg) ||\n            this.isRedirectBot(msg) ||\n            this.isOptions(msg) ||\n            this.isStatus(msg) ||\n            this.isAction(msg) ||\n            this.isGeneralInfo(msg);\n    }\n}\n\n/**\n * 物件相關 utils\n */\nclass ObjUtils {\n\n    removeSpecialCharFromKeys(obj) {\n        for (let prop in obj) {\n            let testReg = /\\./g;\n            if (testReg.test(prop)) {\n                const newProp = prop.replace(testReg, '');\n                let propVal = obj[prop];\n                delete obj[prop];\n                obj[newProp] = propVal;\n            }\n        }\n        return obj;\n    }\n}\n\n/**\n * 訊息相關 utils\n */\nclass MsgUtils {\n    /**\n     * Create output array (index of total)\n     * @params msg msg obj\n     * @params index 1-based\n     * @params total num of outputs\n     */\n    output(msg, index, total) {\n        total = !isNaN(total) && total >= 1 ? total : 1;\n        index = !isNaN(index) && index >= 1 && index <= total ? index : 1;\n        let outputs = new Array(total);\n        outputs.fill(null);\n        outputs[index - 1] = msg;\n        return outputs;\n    }\n}\n\n/**\n * 結束動作選項\n */\nclass QuitOptions {\n    constructor() {\n        this._none = 0;\n        this._quitNone = 'quit_none';\n        this._current = 1;\n        this._quitCurrent = 'quit_current';\n        this._all = 2;\n        this._quitAll = 'quit_all';\n    }\n\n    get none() { return this._none; }\n    get quitNone() { return this._quitNone; }\n    get current() { return this._current; }\n    get quitCurrent() { return this._quitCurrent; }\n    get all() { return this._all; }\n    get quitAll() { return this._quitAll; }\n}\n\nconst quitOptions = new QuitOptions();\n\n\nclass LocalesUtils {\n\n    /**\n     * 取得 locales 對應語句或物件\n     * 若指定 channel 不存在 key 值，判斷 text 或 speech 是否有定義\n     * \n     * @param {Channel} channel Channel object\n     * @param {string | Array} key 以 dot ('.')分隔的字串，表示 property path\n     * @param {Object} replaceParams\n     */\n    get(locales, channel, key, replaceParams) {\n        if (!node._.isNil(locales)) {\n            let result = node._.get(locales[channel], key);\n            // 預設 Channel 與對應的語料\n            if (!result) {\n                if (reqChannels.isText(channel)) {\n                    result = node._.get(locales[reqChannels.text], key);\n                }\n                else if (reqChannels.isSpeech(channel)) {\n                    result = node._.get(locales[reqChannels.speech], key);\n                }\n            }\n            if (!!result && typeof result === 'string') {\n                result = this.replaceTextByParams(result, replaceParams);\n            }\n            return result;\n        }\n    }\n\n    /**\n     * 取代文字中指定參數，文字中須以 {{param}} 表示\n     * @param {*} text \n     * @param {*} params 取代參數值，會包含對應的參數，如 { param: \"new value\" }\n     */\n    replaceTextByParams(text, params) {\n        if (params) {\n            Object.keys(params).forEach(key => {\n                if (typeof params[key] === 'string') {\n                    const regex = new RegExp('{{\\\\s*' + key + '\\\\s*}}', 'gm');\n                    text = text.replace(regex, params[key]);\n                }\n            });\n        }\n        return text;\n    }\n}\n\n/**\n * 提供 First-In-First-Out 操作於指定的 array\n */\nclass QueueUtils {\n    /**\n     * 新增至 Queue 最後\n     */\n    push(queue, data) {\n        if (Array.isArray(queue) && !!data) {\n            if (!node._.isEqual(this.last(queue), data))\n                queue.push(data);\n        }\n    }\n    /**\n     * 從 Queue 最後取出\n     */\n    pop(queue) {\n        if (Array.isArray(queue)) {\n            let item = queue.pop();\n            return typeof item === 'object' ?\n                node._.cloneDeep(item) : item;\n        }\n        return null;\n    }\n    /**\n     * 從 Queue 第一個取出\n     */\n    shift(queue) {\n        if (Array.isArray(queue)) {\n            let item = queue.shift();\n            return typeof item === 'object' ?\n                node._.cloneDeep(item) : item;\n        }\n        return null;\n    }\n    /**\n     * 清除 Queue\n     */\n    clear(queue) {\n        if (Array.isArray(queue)) {\n            queue.splice(0, queue.length);\n        }\n    }\n    /**\n     * 刪除 Queue 中指定項目\n     */\n    remove(queue, index) {\n        if (Array.isArray(queue) &&\n            typeof index === 'number' && index >= 0 &&\n            queue.length && index < queue.length) {\n            queue.splice(index, 1);\n        }\n    }\n    /**\n     * 取得 Queue 的第一個項目\n     */\n    first(queue) {\n        if (Array.isArray(queue) && queue.length > 0) {\n            return typeof queue[0] === 'object' ?\n                Object.assign({}, queue[0]) : queue[0];\n        }\n        return null;\n    }\n    /**\n     * 取得 Queue 的最新的項目\n     */\n    last(queue) {\n        if (Array.isArray(queue) && queue.length > 0) {\n            return typeof queue[queue.length - 1] === 'object' ?\n                Object.assign({}, queue[queue.length - 1]) : queue[queue.length - 1];\n        }\n        return null;\n    }\n\n    /**\n     * 取得指定順位的項目\n     * @param {*} queue array of items as queue\n     * @param {*} index 0-based index\n     */\n    get(queue, index) {\n        if (Array.isArray(queue) &&\n            typeof index === 'number' && index >= 0 &&\n            queue.length && index < queue.length) {\n            return typeof queue[index] === 'object' ?\n                Object.assign({}, queue[index]) : queue[index];\n        }\n    }\n    /**\n     * 從最後一個倒數，取得指定順位的項目\n     * @param {*} queue array of items as queue\n     * @param {*} index 0-based index\n     */\n    getFromLast(queue, index) {\n        if (Array.isArray(queue) &&\n            typeof index === 'number' && index >= 0 &&\n            queue.length && index < queue.length) {\n            return typeof queue[queue.length - index - 1] === 'object' ?\n                Object.assign({}, queue[queue.length - index - 1]) : queue[queue.length - index - 1];\n        }\n    }\n}\n\n/**\n * 字串相關工具\n */\nclass StringUtils {\n    /**\n     * 計算字串最短距離\n     * @param {*} str1 \n     * @param {*} str2 \n     */\n    levenshteinDistance(str1, str2) {\n        str1 = str1 || '';\n        str2 = str2 || '';\n        let vectorPrevious = [];\n        let vectorCurrent = [];\n\n        for (let i = 0; i <= str2.length; ++i) {\n            vectorPrevious[i] = i;\n        }\n        for (let i = 0; i < str1.length; ++i) {\n            vectorCurrent[0] = i + 1;\n\n            for (let j = 0; j < str2.length; ++j) {\n                let deletionCost = vectorPrevious[j + 1] + 1;\n                let insertionCost = vectorCurrent[j] + 1;\n                let substitutionCost = 0;\n\n                if (str1[i] === str2[j]) {\n                    substitutionCost = vectorPrevious[j];\n                } else {\n                    substitutionCost = vectorPrevious[j] + 1;\n                }\n                vectorCurrent[j + 1] = node._.min([\n                    deletionCost,\n                    insertionCost,\n                    substitutionCost\n                ]);\n            }\n\n            vectorPrevious = [].concat(vectorCurrent);\n            vectorCurrent = [];\n        }\n        return vectorPrevious[str2.length];\n    }\n\n    /**\n     * 計算字串最短距離，並轉成相似度(0.0 ~ 1.0)\n     * @param {*} str1 \n     * @param {*} str2 \n     */\n    stringSimilarity(str1, str2) {\n        let distance = this.levenshteinDistance(str1, str2);\n        let maxLen = node._.max([str1.length, str2.length]);\n        return parseFloat((maxLen - distance) / maxLen);\n    }\n}\n\nconst stringUtils = new StringUtils();\n\n/**\n * Setup and update `msg.report_stats` and `msg.systalk.report_stats_session`\n */\nclass ReportUtils {\n\n    /**\n     * Get channel's description, then set to `msg.report_stats_session.channel`\n     * @param {Object} reportStatsSession report stats per session\n     * @param {Channel} channel Channel object\n     */\n    setSessionChannel(reportStatsSession, channel) {\n        if (!node._.isNil(reportStatsSession) && !node._.isNil(channel)) {\n            let stats = reportStatsSession;\n            stats.channel = channel.toString();\n        }\n    }\n\n    /**\n     * \n     * @param {Object} reportStatsSession report stats per session\n     * @param {number} hasInputed `true` if user has inputed\n     */\n    setSessionUserHasInputed(reportStatsSession, hasInputed) {\n        if (!node._.isNil(reportStatsSession)) {\n            reportStatsSession.userHasInputed = hasInputed || false;\n        }\n    }\n\n    /**\n     * Set `msg.systalk.report_stats_session.toCustomerService` to check if this session is transfered to customer service\n     * @param {Object} reportStatsSession report stats per session\n     * @param {boolean} isTransferedToCS is this session transfered to customer service\n     */\n    setSessionToCustomerService(reportStatsSession, isTransferedToCS) {\n        reportStatsSession.toCustomerService = node._.isNil(isTransferedToCS) ? false : isTransferedToCS;\n    }\n\n    /**\n     * 使用者對 Chat Bot 評分\n     * @param {*} reportStatsSession report stats per session\n     * @param {number} score 評分\n     */\n    setSessionScoreForBot(reportStatsSession, score) {\n        if (!node._.isNil(reportStatsSession)) {\n            let _score = parseInt(score);\n            reportStatsSession.botUserScore = !isNaN(_score) && _score >= 0 ? _score : 0;\n        }\n    }\n\n    /**\n     * 使用者對客服人員的評分\n     * @param {Object} reportStatsSession report stats per session\n     * @param {number} score 評分\n     */\n    setSessionScoreForAgent(reportStatsSession, score) {\n        if (!node._.isNil(reportStatsSession)) {\n            let _score = parseInt(score);\n            reportStatsSession.agentUserScore = !isNaN(_score) && _score >= 0 ? _score : 0;\n        }\n    }\n\n    /**\n     * 設定是否為 `undecided`\n     * @param {Object} reportStats report stats per message\n     * @param {string} deciding `Decided`, `Undecided` or `Suggested FAQ`\n     */\n    setDeciding(reportStats, deciding) {\n        if (!node._.isNil(reportStats) && !node._.isNil(deciding)) {\n            reportStats.deciding = deciding;\n        }\n    }\n}\n\nclass LangCtrl {\n    constructor() {\n    }\n\n    /**\n     * Normalize lang code: lower case & separated by `-`\n     * ex: `zh-tw`, `en-us`\n     * @param {string} langCode lang code\n     */\n    normalize(langCode) {\n        if (!!langCode) {\n            return langCode.toLowerCase().trim();\n        }\n    }\n\n    /**\n     * Return the `langCode`, if it's valid in `validLangs`, `defaultLang` otherwise \n     * @param {string[]} validLangs collection of valid lang codes\n     * @param {string} langCode lang code to be determined\n     * @param {string} defaultLang default as `langCode` not in `validLangs`\n     */\n    validOrDefault(validLangs, langCode, defaultLang) {\n        if (Array.isArray(validLangs)) {\n            return validLangs.some(x => this.normalize(x) === this.normalize(langCode)) ?\n                langCode : defaultLang;\n        }\n    }\n}\n\nclass AnalysisCtrl {\n    constructor() { }\n\n    /**\n     * Map NLU result for analysis\n     * \n     * @param {Object} nlu NLU result object\n     * @param {Object} extraConfigs Extra configs for NLU  \n     * ```typescript\n     * {\n     *   isFirstNLU: boolean;\n     *   isSecondNLU: boolean;\n     *   isThirdNLU: boolean;\n     *   threshold: number;\n     * }\n     * ```\n     * @returns NLU Result for analysis\n     * ```typescript\n     * {\n     *   sentence: string;\n     *   intents: IntentResult[];\n     *   entities: EntityResult[];\n     * \n     *   isFirstNLU: boolean;\n     *   isSecondNLU: boolean;\n     *   isThirdNLU: boolean;\n     *   threshold: number;\n     *   secondThreshold: number;\n     *   fallbackScore: number;\n     *   name: string;\n     * }\n     * ```\n     */\n    mapNLUResult(nlu, extraConfigs) {\n        let res = null;\n        if (!node._.isNil(nlu)) {\n            res = {};\n            res.sentence = nlu.sentence;\n            res.intents = Array.isArray(nlu.intents) ?\n                [].concat(nlu.intents.map(x => this.mapIntentResult(x)).filter(x => !!x)) :\n                [];\n            res.entities = Array.isArray(nlu.entities) ?\n                [].concat(nlu.entities.map(y => this.mapEntityResult(y)).filter(y => !!y)) :\n                [];\n\n            res.isFirstNLU = !!extraConfigs && extraConfigs.isFirstNLU || false;\n            res.isSecondNLU = !!extraConfigs && extraConfigs.isSecondNLU || false;\n            res.isThirdNLU = !!extraConfigs && extraConfigs.isThirdNLU || false;\n            res.threshold = !!extraConfigs && extraConfigs.threshold || 0;\n            res.secondThreshold = !!extraConfigs && extraConfigs.secondThreshold || 0;\n            res.fallbackScore = !!extraConfigs && extraConfigs.fallbackScore || 0;\n            res.name = !!extraConfigs && extraConfigs.name;\n        }\n        return res;\n    }\n\n    mapIntentResult(intent) {\n        let res = null;\n        if (!node._.isNil(intent)) {\n            res = {};\n            res.intent_id = intent.intent_id;\n            res.intent = intent.intent;\n            res.score = intent.score;\n        }\n        return res;\n    }\n\n    mapEntityResult(entity) {\n        let res = null;\n        if (!node._.isNil(entity)) {\n            res = {};\n            res.entity_id = entity.entity_id;\n            res.info = entity.info;\n            res.text = entity.text;\n            res.key_user_phrase = entity.key_user_phrase;\n            res.entity = entity.entity;\n        }\n        return res;\n    }\n\n    /**\n     * Map FAQ result for analysis\n     *\n     * @param {Object} faq FAQ Result object\n     * @param {Object} extraConfigs Extra configs for FAQ\n     * ```typescript\n     * {\n     *   isFirstFAQ: boolean;\n     *   threshold: number;\n     *   secondThreshold: number;\n     *   name: string;\n     * }\n     * ```\n     */\n    mapFAQResult(faq, extraConfigs) {\n        let res = null;\n        if (!node._.isNil(faq)) {\n            res = {};\n            res.qid = faq.id;\n            res.originalQuestion = faq.orig_question;\n            res.matchedQuestion = faq.question;\n            res.answer = faq.answer;\n\n            if (!node._.isNil(faq.multichannel_answers) && Array.isArray(faq.multichannel_answers)) {\n                res.multichannel_answers = [].concat(faq.multichannel_answers.map(x => this.mapMultiChannelFAQAnswers(x)));\n            }\n            res.categories = [].concat(node._.cloneDeep(faq.categories));\n            res.score = faq.score;\n\n            res.threshold = !!extraConfigs && extraConfigs.threshold || 0;\n            res.secondThreshold = !!extraConfigs && extraConfigs.secondThreshold || 0;\n            res.isFirstFAQ = !!extraConfigs && extraConfigs.isFirstFAQ || false;\n            res.name = !!extraConfigs && extraConfigs.name;\n        }\n        return res;\n    }\n\n    mapMultiChannelFAQAnswers(ans) {\n        let res = null;\n        if (!node._.isNil(ans)) {\n            res = {};\n            res.channel = ans.tab.name;\n            res.answer = ans.answer;\n        }\n        return res;\n    }\n\n    /**\n     * Map recored NLU result for Report used\n     * @param {Object} nluResult \n     */\n    mapNLUResultForReport(nluResult) {\n        if (!!nluResult &&\n            Array.isArray(nluResult.intents) && nluResult.intents.length) {\n\n            let isUndecided = false;\n            let isSuggested = false;\n            if (node._.isNumber(nluResult.threshold)) {\n                isUndecided = isUndecided || nluResult.intents[0].score < nluResult.threshold;\n            }\n            if (node._.isNumber(nluResult.fallbackScore)) {\n                isUndecided = isUndecided || nluResult.intents[0].score === nluResult.fallbackScore;\n            }\n            if (node._.isNumber(nluResult.secondThreshold)) {\n                isSuggested = isSuggested || nluResult.intents[0].score >= nluResult.secondThreshold;\n            }\n\n            return {\n                intent: nluResult.intents[0].intent,\n                undecided: isUndecided,\n                suggested: isSuggested\n            };\n        }\n        return null;\n    }\n\n    /**\n     * Map recored FAQ result for Report used\n     * @param {Object} faqResult \n     * @param {Object} extraConfigs Extra configs for `faqResult`\n     * ```typescript\n     * {\n     *   parentCategory: string;\n     *   childCategory: string;\n     * }\n     * ```\n     */\n    mapFAQResultForReport(faqResult, extraConfigs) {\n        let res = null;\n        if (!!faqResult) {\n            res = {};\n            res.qid = faqResult.qid;\n            res.originalQuestion = faqResult.originalQuestion;\n            res.matchedQuestion = faqResult.matchedQuestion;\n            res.score = faqResult.score;\n            res.undecided = node._.isNumber(faqResult.threshold) ? faqResult.score < faqResult.threshold : false;\n            res.suggested = node._.isNumber(faqResult.secondThreshold) ? faqResult.score >= faqResult.secondThreshold : false;\n            res.parentCategory = extraConfigs.parentCategory || undefined;\n            res.childCategory = extraConfigs.childCategory || undefined;\n            return res;\n        }\n        return null;\n    }\n\n    /**\n     * Get the NLU result marked as the first NLU\n     * @param {Object[]} list \n     */\n    getFirstNLU(list) {\n        if (Array.isArray(list) && list.length) {\n            return list.find(x => x.isFirstNLU) || null;\n        }\n    }\n\n    /**\n     * Get the NLU result marked as the second NLU\n     * @param {Object[]} list \n     */\n    getSecondNLU(list) {\n        if (Array.isArray(list) && list.length) {\n            return list.find(x => x.isSecondNLU) || null;\n        }\n    }\n\n    /**\n     * Get the NLU result marked as the third NLU\n     * @param {Object[]} list\n     */\n    getThirdNLU(list) {\n        if (Array.isArray(list) && list.length) {\n            return list.find(x => x.isThirdNLU) || null;\n        }\n    }\n\n    /**\n     * Get the FAQ result marked as the first FAQ\n     * @param {Object[]} list \n     */\n    getFirstFAQ(list) {\n        if (Array.isArray(list) && list.length) {\n            return list.find(x => x.isFirstFAQ) || null;\n        }\n    }\n}\n\n/**\n * 提供 `msg.config` 相關 Utility 方法\n */\nclass ConfigCtrl {\n\n    getBotApi(name) {\n        if (name && msg.config.apis.bots) {\n            return msg.config.apis.bots[name];\n        }\n    }\n\n    getNLUApi(name) {\n        if (name && msg.config.apis && msg.config.apis.nlu) {\n            return msg.config.apis.nlu[name];\n        }\n    }\n\n    getFAQApi(name) {\n        if (name && msg.config.apis && msg.config.apis.faq) {\n            return msg.config.apis.faq[name];\n        }\n    }\n\n    getLocalesApi() {\n        if (msg.config.apis && msg.config.apis.locales) {\n            return msg.config.apis.locales;\n        }\n    }\n\n    /**\n     * 取得 NLU 門檻值\n     * @param {string} name 設定的 NLU 名稱\n     */\n    getNLUThreshold(name) {\n        if (name && msg.config.threshold && msg.config.threshold.nlu) {\n            return msg.config.threshold.nlu[name];\n        }\n    }\n\n    /**\n     * 取得 NLU 次門檻值\n     * @param {string} name 設定的 NLU 名稱\n     */\n    getNLUSecondThreshold(name) {\n        return this.getNLUMinorThreshold(name);\n    }\n\n    /**\n     * 取得 NLU 次門檻值\n     * @param {string} name 設定的 NLU 名稱\n     */\n    getNLUMinorThreshold(name) {\n        if (name && msg.config.secondThreshold && msg.config.secondThreshold.nlu) {\n            return msg.config.secondThreshold.nlu[name];\n        }\n    }\n\n    /**\n     * 取得 FAQ 門檻值\n     * @param {string} name 設定 FAQ 的名稱\n     */\n    getFAQThreshold(name) {\n        if (name && msg.config.threshold && msg.config.threshold.faq) {\n            return msg.config.threshold.faq[name];\n        }\n    }\n\n    /**\n     * 取得 FAQ 次門檻值\n     * @param {string} name 設定的 FAQ 名稱\n     */\n    getFAQSecondThreshold(name) {\n        return this.getFAQMinorThreshold(name);\n    }\n\n    /**\n     * 取得 FAQ 次門檻值\n     * @param {string} name 設定的 FAQ 名稱\n     */\n    getFAQMinorThreshold(name) {\n        if (name && msg.config.secondThreshold && msg.config.secondThreshold.faq) {\n            return msg.config.secondThreshold.faq[name];\n        }\n    }\n\n    /**\n     * 取得原點值\n     * @param {string} name 設定 NLU 的名稱\n     */\n    getFallbackScore(name) {\n        return this.getOriginValue(name);\n    }\n\n    /**\n     * 取得原點值\n     * @param {string} name 設定 NLU 的名稱\n     */\n    getOriginValue(name) {\n        if (name && msg.config.nluFallbackScore) {\n            return msg.config.nluFallbackScore[name];\n        }\n    }\n\n    /**\n     * service 是否擁有指定的操作意圖（與項目意圖）\n     * @param { string } serviceName 服務意圖名稱\n     * @param { string } operationName 操作意圖名稱\n     * @param { item } itemName 項目意圖名稱\n     */\n    serviceHasOperationAndItem(serviceName, operationName, itemName) {\n        if (!msg.config.intentsMap || !serviceName) {\n            return false;\n        }\n\n        const operations = msg.config.intentsMap[serviceName] && Object.keys(msg.config.intentsMap[serviceName]) || [];\n        let items = [];\n        operations.forEach(op => {\n            items = items.concat(msg.config.intentsMap[serviceName][op] || []);\n        });\n\n        const hasOperation = operationName && operations.includes(operationName);\n        const hasItem = itemName && items.includes(itemName);\n        const itemsOfOperation = msg.config.intentsMap[serviceName] && Array.isArray(msg.config.intentsMap[serviceName][operationName]) ?\n            msg.config.intentsMap[serviceName][operationName] : [];\n        const hasItemOfOperation = operationName && itemName && hasOperation &&\n            itemsOfOperation.includes(itemName);\n\n        return hasOperation || hasItem || hasItemOfOperation;\n    }\n}\n\n\nmsg.systalk.utils = {\n    ReqMsgTypes: reqMsgTypes,\n    ReplyMsgTypes: replyMsgTypes,\n    ReqSignals: reqSignals,\n    ReqChannels: reqChannels,\n    Channel: Channel,\n    ReplyMsgFactory: new ReplyMsgFactory(),\n    ReqMsgCtrl: new ReqMsgCtrl(),\n    ReplyMsgCtrl: new ReplyMsgCtrl(),\n    ObjUtils: new ObjUtils(),\n    MsgUtils: new MsgUtils(),\n    QuitOptions: quitOptions,\n    LocalesUtils: new LocalesUtils(),\n    ReplyActionTypes: replyActionTypes,\n    QueueUtils: new QueueUtils(),\n    StringUtils: stringUtils,\n    ReportUtils: new ReportUtils(),\n    LangCtrl: new LangCtrl(),\n    AnalysisCtrl: new AnalysisCtrl(),\n    ConfigCtrl: new ConfigCtrl()\n};\n\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299afd8510860",
        "breakpoints": []
    },
    {
        "id": "028b6c0dd7f46288bec7.0a7c228fb042",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "JOIN 注意事項",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "需注意，各分支 `msg.payload` 中不可包含 \"circular reference\"\nJOIN 時 deep clone 會發生問題，導致 container crash.",
        "in": [],
        "out": [],
        "x": 2925.4285583496094,
        "y": 1357.0000114440918,
        "wires": [],
        "_id": "61c99430f042993642510861",
        "breakpoints": []
    },
    {
        "id": "ea5f62aceda7cfb53cae.388ff27b0bd5",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "取得 config 參數",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 672,
        "y": 488,
        "wires": [
            [
                "1ac3fe37e61e155db48a.1bdcf5247225",
                "1b0b243c8c1ae3ce4613.8f73fd8c92a7"
            ]
        ],
        "func": "msg.headers = msg.config.headers;\nmsg.method = 'POST';\nmsg.systalk.getParametersUrl = \"http://10.20.30.83:8011/config/parameters\";\nmsg.url = msg.systalk.getParametersUrl;\n\nmsg.payload = {\n    categoryKey: \"ChatFlow\",\n    chatwebId: msg.reqMsg.chatwebId\n};\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429938c9510862",
        "breakpoints": []
    },
    {
        "id": "f2c9e1e5b6e1cf960860.ee087849bc24",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Get parameters",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 670,
        "y": 583,
        "wires": [
            [
                "567e8258940a56aa9d9b.da9ada5f1662"
            ],
            [
                "b48f92a9ba63d29c4405.3809c84f5fa7"
            ]
        ],
        "func": "msg.headers = undefined;\nmsg.method = undefined;\nmsg.url = undefined;\n\n// msg.payload = JSON.parse(msg.payload);\n\nif(msg.payload.code === 0){//查詢成功\n    const configParameters = msg.payload.data;\n    // 存systalk\n    msg.systalk.configParameters = configParameters;\n} else{\n    node.log(\"取得參數失敗！\");\n    node.log(msg.payload);\n    return [null, msg];\n}\n\nreturn msg;\n",
        "outputs": 2,
        "noerr": 0,
        "_id": "61c99430f042995205510863",
        "breakpoints": []
    },
    {
        "id": "2009a094e9d68b58da81.f1e6d7769484",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "Get Config Result",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 986,
        "y": 535,
        "wires": [],
        "_id": "61c99430f042997c7d510864",
        "breakpoints": []
    },
    {
        "id": "567e8258940a56aa9d9b.da9ada5f1662",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Set parameters",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 986,
        "y": 436,
        "wires": [
            [
                "03223d1d3f632c77372d.41c4b78bde85",
                "2f704b229c7733bf4f7f.30719fcb7f81",
                "afdf06a2c0974d2c65b5.c47756d884eb",
                "3b99d83d2155a6b1157d.1fba095d820e"
            ]
        ],
        "func": "if(msg.systalk.configParameters){//有參數\n    //設定參數...\n    const configParameters = msg.systalk.configParameters;\n    \n    //BOT\n    // msg.config.apis.bots['檢診'] = configParameters['bot_examination'];\n    \n    //NLU、FAQ\n    msg.config.apis.nlu['總機'] = configParameters.nlu_firstNLU;\n    msg.config.apis.faq['FAQ'] = configParameters.nlu_firstFAQ;\n\n    //GATEWAY\n    msg.config.apis.gateWay.scene = configParameters.gw_addr+':'+configParameters.gw_port+'/card/scene';\n    msg.config.apis.gateWay.faqAnswer = configParameters.gw_addr+':'+configParameters.gw_port+'/card/faqAnswer';\n    msg.config.apis.gateWay.text = configParameters.gw_addr+':'+configParameters.gw_port+'/card/text';\n    \n    //門檻值\n    msg.config.threshold.nlu['總機'] = parseFloat(configParameters['thd_firstNLU']);\n    msg.config.threshold.faq['FAQ'] = parseFloat(configParameters['thd_firstFAQ']);\n    \n    //次門檻值\n    // msg.config.secondThreshold.nlu['總機'] = parseFloat(configParameters['thd_firstNLU_2']);\n    // msg.config.secondThreshold.faq['FAQ'] = parseFloat(configParameters['thd_firstFAQ_2']);\n    \n    //原點值\n    msg.config.nluFallbackScore['總機'] = parseFloat(configParameters['fall_firstNLU']);\n    \n    //FAQ最大回應筆數\n    msg.config.faqMaxResultSize = parseInt(configParameters['faqMaxResultSize']) || 3;\n    \n    // 語音重聽次數上限\n    let maxResendTimes = parseInt(configParameters['maxResendTimes']);\n    if (isNaN(maxResendTimes) || maxResendTimes < 0) {\n        maxResendTimes = 3;\n    }\n    msg.config.maxResendTimes = maxResendTimes;\n    \n    // 語音進線最長時間，單位秒\n    let sessionTimeLimitInSeconds = parseInt(configParameters['sessionTimeLimitInSeconds']);\n    if (isNaN(sessionTimeLimitInSeconds) || sessionTimeLimitInSeconds <= 0) {\n        sessionTimeLimitInSeconds = 300;\n    }\n    \n    msg.config.sessionTimeLimitInSeconds = sessionTimeLimitInSeconds;\n    \n    // 字串比對需先濾掉的語助詞\n    msg.config.auxiliaryWords = configParameters['auxiliaryWords'] ?\n        configParameters['auxiliaryWords'].split(/[,，]/).filter(x => !!x) : null;\n    \n    // 正確，字串比對選項\n    msg.config.correctText = configParameters['text_yes'] ?\n        configParameters['text_yes'].split(/[,，]/).filter(x => !!x) : null;\n    \n    // 錯誤，字串比對選項\n    msg.config.wrongText = configParameters['text_no'] ?\n        configParameters['text_no'].split(/[,，]/).filter(x => !!x) : null;\n    \n    // 當進入 SecondBot 後 FAQ 提高的門檻值\n    msg.config.higherFAQThreshold = configParameters['thd_firstFAQ_higher'] ?\n        parseFloat(configParameters['thd_firstFAQ_higher']) : msg.config.threshold.faq['FAQ'];\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042994199510865",
        "breakpoints": []
    },
    {
        "id": "03223d1d3f632c77372d.41c4b78bde85",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "次門檻值設定",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": false,
        "console": "false",
        "complete": "config.secondThreshold",
        "x": 1241,
        "y": 476,
        "wires": [],
        "_id": "61c99430f04299a116510866",
        "breakpoints": []
    },
    {
        "id": "2f704b229c7733bf4f7f.30719fcb7f81",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "門檻值設定",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": false,
        "console": "false",
        "complete": "config.threshold",
        "x": 1231,
        "y": 516,
        "wires": [],
        "_id": "61c99430f042990835510867",
        "breakpoints": []
    },
    {
        "id": "5fc8fdd0a8082760cc6f.40342c007b7d",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "state",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2428,
        "y": 436,
        "wires": [
            []
        ],
        "func": "// 結束 setup 流程\nmsg._start_setup = false;\n\n// 進入開始流程\nmsg._start_flow = true;\n\n// 進入檢查對話總時間流程\n// msg._check_time_diff = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299dbda510868",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "a46f22404af4fad8e4f1.d29de5dff3e1",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "組 Request Parameters",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 460,
        "y": 3239,
        "wires": [
            [
                "87e5951c7a6f514777d1.0738f322e1b1",
                "1450c5559e2a1b64b2de.5832303dc346"
            ]
        ],
        "func": "msg.headers = msg.config.headers;\nmsg.method = 'POST';\nmsg.payload = msg.reqBody;\n\nif (!msg.url) {\n    msg.error = 'Missing Request URL';\n    return [null, msg];\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042997528510869",
        "breakpoints": []
    },
    {
        "id": "419e80e90770de92890b.5d33869cc859",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "Gateway API",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 200.83334350585938,
        "y": 3238.6666259765625,
        "wires": [
            [
                "a46f22404af4fad8e4f1.d29de5dff3e1"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f0429956ec51086a",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_gateWay"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "87e5951c7a6f514777d1.0738f322e1b1",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "http request",
        "name": "gateway",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 701.8333435058594,
        "y": 3238.6666259765625,
        "wires": [
            [
                "4d26e7ff2ceef49d0aa6.046ae1996b1d",
                "faec9b16827e66a7b761.76f8f78040c2"
            ]
        ],
        "_id": "61c99430f0429987e151086b",
        "breakpoints": [],
        "method": "use",
        "ret": "obj",
        "url": ""
    },
    {
        "id": "1450c5559e2a1b64b2de.5832303dc346",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "Request Body",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 711.8333435058594,
        "y": 3178.6666259765625,
        "wires": [],
        "_id": "61c99430f0429907e251086c",
        "breakpoints": []
    },
    {
        "id": "4d26e7ff2ceef49d0aa6.046ae1996b1d",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "處理資料",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 923.8333435058594,
        "y": 3238.6666259765625,
        "wires": [
            [
                "35680efc942cc9d80a16.a6640d2e08e5"
            ],
            [
                "72ea40a2f938dd65fe0b.c80ee8268749"
            ]
        ],
        "func": "const MsgUtils = msg.systalk.utils.MsgUtils;\nconst numOfOuts = 2;\n\n// 刪除條件\nmsg._gateWay = undefined;\n\n// 刪除 http 資料\nmsg.headers = undefined;\nmsg.method = undefined;\nmsg.url = undefined;\n\n// Gateway 發生錯誤\nif (msg.payload.code !== 0) {\n    return MsgUtils.output(msg, 2, numOfOuts);\n}\n\n// 回覆訊息\nmsg.messages = msg.payload;\n\nreturn MsgUtils.output(msg, 1, numOfOuts);\n",
        "outputs": 2,
        "noerr": 0,
        "_id": "61c99430f04299812251086d",
        "breakpoints": []
    },
    {
        "id": "faec9b16827e66a7b761.76f8f78040c2",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "Response Data",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 943.8333435058594,
        "y": 3178.6666259765625,
        "wires": [],
        "_id": "61c99430f042995d2151086e",
        "breakpoints": []
    },
    {
        "id": "35680efc942cc9d80a16.a6640d2e08e5",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "回覆訊息",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1143.8333435058594,
        "y": 3219.6666259765625,
        "wires": [
            []
        ],
        "func": "// 若訊息內包含 # 進入設定 tts action 流程\nif (msg.messages.data.content[0].text.includes('#')) {\n    msg._set_tts_action = true;\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429983a751086f",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "cdfbf015d6843f1f9ea2.c75f0ae55790",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "複合式牌卡",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 4142.000152587891,
        "y": 1381.3334293365479,
        "wires": [
            []
        ],
        "func": "// 清除http設定\nmsg.headers = undefined;\nmsg.url = undefined;\nmsg.method = undefined;\n\n// 不結束對話\nmsg._end_dialogue = false;\n\n// 回復訊息\nmsg.messages = msg.payload;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042999dbd510870",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "6d97c8f46235cccceb21.8b69a69f9e36",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "純文字牌卡",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 4141.000228881836,
        "y": 1424.6667652130127,
        "wires": [
            [
                "c2973ff1.3dd4e",
                "d5760c60.736c9"
            ]
        ],
        "func": "// 若為特殊案例需做字串比對則不結束對話，反之結束對話\nmsg._end_dialogue = msg.systalk.textComparsion ? false : true;\n\n// 若訊息內包含 # 進入設定 tts action 流程\n// if (msg.faqAns[0].text.includes('#')) {\n//     msg._set_tts_action = true;\n// }\n\n// 刪除轉真人計數\nmsg.systalk.toAngentCounter = 0;\n\n// 設定 goto action\nmsg.ttsAction = msg.config.ttsActions.goto;\n\nconst date = new Date();\n\n// 回覆牌卡訊息\nmsg.messages = {\n    code: 0,\n    msg: \"成功\",\n    data: {\n        channel: 'ChatWeb',\n        source: msg.config.source,\n        role: msg.config.role,\n        content: msg.faqAns,\n        showtime: node.moment(date).tz(\"Asia/Taipei\").format(\"YYYY/MM/DD HH:mm:ss\")\n    }\n};\n    \nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299760b510871",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "1ac3fe37e61e155db48a.1bdcf5247225",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "http request",
        "name": "gateWay call chatManage",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 701,
        "y": 535,
        "wires": [
            [
                "f2c9e1e5b6e1cf960860.ee087849bc24",
                "2009a094e9d68b58da81.f1e6d7769484"
            ]
        ],
        "_id": "61c99430f042997369510872",
        "breakpoints": [],
        "method": "use",
        "ret": "obj",
        "url": "",
        "credentials": {
            "user": "",
            "password": ""
        }
    },
    {
        "id": "8b544df158bfadce4e52.76f0b94d1895",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Set payload",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3101,
        "y": 1317,
        "wires": [
            [
                "32278867f7f2b1784cb5.b338c1fd18b3"
            ],
            [
                "91ad0c9b658955f9d2cf.24238358c466"
            ]
        ],
        "func": "let firstNLU = msg.payload.firstNLU;\n// let firstNLUSupport = msg.payload.firstNLUSupport;\nlet firstFAQ = msg.payload.firstFAQ;\n\n// 計算時間\nif (firstNLU._timeAfterResponse) {\n    msg.report_stats.requestDuration.firstNLU = node.moment(firstNLU._timeAfterResponse).diff(msg._beforeRequest);\n    firstNLU._timeAfterResponse = undefined;\n}\n\nif (firstFAQ._timeAfterResponse) {\n    msg.report_stats.requestDuration.firstFAQ = node.moment(firstFAQ._timeAfterResponse).diff(msg._beforeRequest);\n    firstFAQ._timeAfterResponse = undefined;\n}\n\nmsg._beforeRequest = undefined;\n\nif (msg.error) {\n    return [null, msg];\n}\n\nmsg.firstNLU = firstNLU;\n// msg.firstNLUSupport = firstNLUSupport;\nmsg.firstFAQ = firstFAQ;\nmsg.payload = msg.text;\n\nreturn [msg, null];\n",
        "outputs": 2,
        "noerr": 0,
        "_id": "61c99430f042991e41510873",
        "breakpoints": []
    },
    {
        "id": "a9ce85d596870de63fb1.221a77b01c1f",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "channel, source, role",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "- `msg.config.channel`\n- `msg.config.source`\n- `msg.config.role`",
        "in": [],
        "out": [],
        "x": 744,
        "y": 403,
        "wires": [],
        "_id": "61c99430f04299176e510874",
        "breakpoints": []
    },
    {
        "id": "93c445c023b857d2d068.418bf17dd3cb",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "#start",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 717,
        "y": 2197,
        "wires": [
            [
                "753d94e80ac9bb22ebde.b9cf0e808007"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f0429909aa510875",
        "breakpoints": [],
        "rules": [
            {
                "t": "eq",
                "p": "reqMsg.action",
                "v": "#start"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "b48f92a9ba63d29c4405.3809c84f5fa7",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "On Error",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 967,
        "y": 589,
        "wires": [
            []
        ],
        "func": "msg.messages = {\n    code: 99,\n    msg: \"Chatbot error\",\n    data: {\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: 'bot',\n        content: [\n            {\n                type: 1,\n                text: \"抱歉~小咩正在維護中。\"\n            }\n        ]\n    }\n};\n\n// 結束對話\nmsg._end_dialogue = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299b4fb510876",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "865154a3e3daa68167da.388871e122d1",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "實際輸入",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 447,
        "y": 190,
        "wires": [],
        "_id": "61c99430f042996720510877",
        "breakpoints": []
    },
    {
        "id": "753d94e80ac9bb22ebde.b9cf0e808007",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Reset States",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 990,
        "y": 2197,
        "wires": [
            [
                "753309ae400e70dec35c.a1bf833b9664"
            ]
        ],
        "func": "const BotUtils = msg.systalk.utils.BotUtils;\n\nBotUtils.resetSessionStats();\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299d15d510878",
        "breakpoints": []
    },
    {
        "id": "af563c87bf363c70ecf9.94e364436bac",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "INPUT",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "reqMsg",
        "x": 425,
        "y": 1773,
        "wires": [],
        "_id": "61c99430f042999b3c510879",
        "breakpoints": []
    },
    {
        "id": "fabae905278d55f56124.11a1fbf26b27",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "#wait",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 722,
        "y": 2357,
        "wires": [
            [
                "7da5086db103b1a123f1.0ebdd9d974d9"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f042995ddb51087a",
        "breakpoints": [],
        "rules": [
            {
                "t": "eq",
                "p": "reqMsg.action",
                "v": "#wait"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "814d3cb2cdc64f3cc878.0774d7243b32",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "進入重聽流程",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3671.3333053588867,
        "y": 1556.6664457321167,
        "wires": [
            []
        ],
        "func": "// 進入重聽流程\nmsg._repeat_listen = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042992fa551087b",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "9f71644461072344d354.75fe48fb7715",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "On Init",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 191,
        "y": 271,
        "wires": [
            [
                "ec089b110edc340bbdf8.678e0258965b"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f042994abe51087c",
        "breakpoints": [],
        "rules": [],
        "directlink": false,
        "initialstate": true,
        "fallback": false
    },
    {
        "id": "ec089b110edc340bbdf8.678e0258965b",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "流程開始計時",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 401,
        "y": 271,
        "wires": [
            []
        ],
        "func": "if (!msg.systalk.session_start_time) {\n    msg.systalk.session_start_time = new Date();\n}\n\nmsg._start_setup = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429924de51087d",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "70be658022493353016e.bd286fe14caf",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "計算對話總時間",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 200,
        "y": 331,
        "wires": [
            [
                "4f55fe7f317b6495758a.124ff5e4df35"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299cd5451087e",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_check_time_diff"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "4f55fe7f317b6495758a.124ff5e4df35",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "確認對話時間是否在限制內",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 440,
        "y": 331,
        "wires": [
            []
        ],
        "func": "msg._check_time_diff = false;\n\n// 超時，轉真人\nif (msg.systalk.session_start_time &&\n    node.moment(new Date()).diff(msg.systalk.session_start_time, 'seconds') >= msg.config.sessionTimeLimitInSeconds) {\n        \n    msg.url = msg.config.apis.gateWay.text;\n    msg.reqBody = {\n        chatwebId: msg.reqMsg.chatwebId,\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: msg.config.role,\n        content: [\n            {\n                textCode: 'ST009'\n            }\n        ]\n    };\n    if (Array.isArray(msg.config.extensionNumberMap)) {\n        msg.ttsAction = `${msg.config.ttsActions.transfer}${(new Map(msg.config.extensionNumberMap)).get(msg.systalk.stored.userData.hospitalId)}`;\n    }\n    \n    msg._gateWay = true;\n    msg._end_dialogue = true;\n} else {\n    msg._start_flow = true;\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299ef2e51087f",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "2688231ba9b91a6f4c80.d49fbe04ba05",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "#mrcpError",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 719,
        "y": 2063,
        "wires": [
            [
                "c39f9805.bcbf68"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f042996952510880",
        "breakpoints": [],
        "rules": [
            {
                "t": "eq",
                "p": "reqMsg.action",
                "v": "#mrcpError"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "28ab7349204966c6227f.32debc0ada94",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "reqMsg",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "reqMsg",
        "x": 951,
        "y": 195,
        "wires": [],
        "_id": "61c99430f0429990c7510881",
        "breakpoints": []
    },
    {
        "id": "71426342f7448fccef3c.664d6d4c5c98",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "user data",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": false,
        "console": "false",
        "complete": "payload",
        "x": 1988,
        "y": 477,
        "wires": [],
        "_id": "61c99430f042996758510882",
        "breakpoints": []
    },
    {
        "id": "28f46c0ec8000ca11ab6.9e1d497657a3",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "[test]處理失敗回應",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 740,
        "y": 682,
        "wires": [
            [
                "4a5e01f7d32e358d340d.5aedd2a29512"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f042998b21510883",
        "breakpoints": [],
        "rules": [
            {
                "t": "nnull",
                "p": "botType"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Start"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Hangup"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Wait"
            },
            {
                "t": "eq",
                "p": "reqMsg.message",
                "v": "打系統測試"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "a98d73251f6dfa44c0a0.ad92b292631d",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "[test]當機測試",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 730,
        "y": 723,
        "wires": [
            [
                "df920f88c555e485ccc9.b5ef94023b8f"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f0429962f0510884",
        "breakpoints": [],
        "rules": [
            {
                "t": "nnull",
                "p": "botType"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Start"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Hangup"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Wait"
            },
            {
                "t": "eq",
                "p": "reqMsg.message",
                "v": "當機測試"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "df920f88c555e485ccc9.b5ef94023b8f",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "不送回應",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 1206,
        "y": 723,
        "wires": [],
        "_id": "61c99430f042991f6a510885",
        "breakpoints": []
    },
    {
        "id": "0df75e17e92b493310b5.d138f4753f39",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "[test]嘟嘟聲",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 721,
        "y": 764,
        "wires": [
            [
                "7fa8174507e54904573f.85c60f89a24a"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f042995681510886",
        "breakpoints": [],
        "rules": [
            {
                "t": "nnull",
                "p": "botType"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Start"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Hangup"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Wait"
            },
            {
                "t": "eq",
                "p": "reqMsg.message",
                "v": "嘟嘟聲測試"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "e264b11c0e1a50f6e7d6.2783e0bda8f3",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "等5秒回應",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1206,
        "y": 764,
        "wires": [
            []
        ],
        "func": "msg.messages = {\n    code: 0,\n    message: \"成功\",\n    data: {\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: msg.config.role,\n        content: [\n            {\n                type: 1,\n                text: \"嘟嘟聲測試成功\"\n            }\n        ]\n    },\n    action: msg.config.ttsActions.sttOff\n};\n\nmsg._end_dialogue = false;\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042997a2c510887",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "7fa8174507e54904573f.85c60f89a24a",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "delay",
        "name": "",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 964,
        "y": 764,
        "wires": [
            [
                "e264b11c0e1a50f6e7d6.2783e0bda8f3"
            ]
        ],
        "_id": "61c99430f042994419510888",
        "breakpoints": [],
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false
    },
    {
        "id": "f0c628f3213fad7ea4bd.3a9f543d17a5",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "#music",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1206,
        "y": 805,
        "wires": [
            []
        ],
        "func": "msg.messages = {\n    code: 0,\n    message: \"成功\",\n    data: {\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: msg.config.role,\n        content: [\n            {\n                type: 1,\n                text: '#music'\n            }\n        ]\n    },\n    action: msg.config.ttsActions.music,\n};\n\nmsg._end_dialogue = false;\nmsg.systalk.testMusic = true;\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042990845510889",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "e9a9d9c7ccb7949f3191.ea98e0b21987",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "[test]音樂測試",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 732,
        "y": 805,
        "wires": [
            [
                "f0c628f3213fad7ea4bd.3a9f543d17a5"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299caef51088a",
        "breakpoints": [],
        "rules": [
            {
                "t": "nnull",
                "p": "botType"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Start"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Hangup"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Wait"
            },
            {
                "t": "eq",
                "p": "reqMsg.message",
                "v": "音樂測試"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "962081990fdfae028440.edba48f317d1",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "#wait 回應",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1206,
        "y": 848,
        "wires": [
            []
        ],
        "func": "msg.messages = {\n    code: 0,\n    message: \"成功\",\n    data: {\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: msg.config.role,\n        content: [\n            {\n                type: 1,\n                text: '長庚API回傳的資訊。'\n            }\n        ]\n    },\n    action: msg.config.ttsActions.sttOff,\n};\n\nmsg._end_dialogue = false;\nmsg.systalk.testMusic = undefined;\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299a58451088b",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "b4d1596e217ce954acb5.c1d5cefa6e59",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "[test]音樂測試 #Wait",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 751,
        "y": 848,
        "wires": [
            [
                "962081990fdfae028440.edba48f317d1"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f042997d3451088c",
        "breakpoints": [],
        "rules": [
            {
                "t": "nnull",
                "p": "botType"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Start"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Hangup"
            },
            {
                "t": "true",
                "p": "systalk.testMusic"
            },
            {
                "t": "eq",
                "p": "reqMsg.action",
                "v": "#Wait"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "0143883df8d8e676f9aa.7b9bc9982fa0",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "轉真人",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1206,
        "y": 890,
        "wires": [
            []
        ],
        "func": "msg.messages = {\n    code: 0,\n    message: \"成功\",\n    data: {\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: msg.config.role,\n        content: [\n            {\n                type: 1,\n                text: '即將為您轉真人'\n            }\n        ]\n    },\n    action: `${msg.config.ttsActions.transfer}#98765`,\n};\n\nmsg._end_dialogue = true;\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042993a6451088d",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "d43ba89f8bd5351d02a9.080ab7d5e591",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "[test]轉分機測試",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 741,
        "y": 890,
        "wires": [
            [
                "0143883df8d8e676f9aa.7b9bc9982fa0"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299b68d51088e",
        "breakpoints": [],
        "rules": [
            {
                "t": "nnull",
                "p": "botType"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Start"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Hangup"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Wait"
            },
            {
                "t": "eq",
                "p": "reqMsg.message",
                "v": "轉分機測試"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "19467c8d2213bae66eb3.a9cfafb33b0c",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "[test]End測試",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 731,
        "y": 932,
        "wires": [
            [
                "890c309ac280e1374045.5dff76698dd0"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f042994a6351088f",
        "breakpoints": [],
        "rules": [
            {
                "t": "nnull",
                "p": "botType"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Start"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Hangup"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Wait"
            },
            {
                "t": "eq",
                "p": "reqMsg.message",
                "v": "再見"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "890c309ac280e1374045.5dff76698dd0",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "結束",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1206,
        "y": 932,
        "wires": [
            []
        ],
        "func": "msg.messages = {\n    code: 0,\n    message: \"成功\",\n    data: {\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: msg.config.role,\n        content: [\n            {\n                type: 1,\n                text: '謝謝您，祝您平安健康。'\n            }\n        ]\n    },\n    action: msg.config.ttsActions.end,\n};\n\nmsg._end_dialogue = true;\n\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042993e36510890",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "a62b8d199fae6baf5447.bcb957ffc196",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "[test]長文測試",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 731,
        "y": 975,
        "wires": [
            [
                "fbad862d40cf8d8ee95d.1e5e04d8b759"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299e1cf510891",
        "breakpoints": [],
        "rules": [
            {
                "t": "nnull",
                "p": "botType"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Start"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Hangup"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#Wait"
            },
            {
                "t": "eq",
                "p": "reqMsg.message",
                "v": "長文測試"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "fbad862d40cf8d8ee95d.1e5e04d8b759",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "長文回應",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1206,
        "y": 975,
        "wires": [
            []
        ],
        "func": "msg.messages = {\n    code: 0,\n    message: \"成功\",\n    data: {\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: msg.config.role,\n        content: [\n            {\n                type: 1,\n                text: `新冠疫苗何時來台引發關注。本報獲得獨家消息，指揮中心已透過在美外交途徑，取得十多萬劑輝瑞疫苗，預計二月四日由阿聯酋航空運送來台，民航局將於今天下午召開內部會議，討論冷鏈倉儲以及配送等技術問題。` +\n                        `民航局今針對冷鏈設備開會` +\n                        `對此，指揮中心發言人莊人祥說，「如果有就來」、「真的有的話，會盡快對外公布。」莊人祥指出，今天下午民航局確實針對冷鏈設備等議題，邀請專家舉辦內部會議，但這是早就排定好的議程。`+\n                        `全台醫護人員共六十五萬人`+\n                        `據了解，台灣首批新冠疫苗，數量不多，僅有十幾萬劑，為輝瑞疫苗。為了運送疫苗，機艙已設置特殊冷鏈設備。至於十幾萬劑疫苗，醫護人員將為優先施打對象，重點為桃園地區的醫護人員，醫護人員共有六十五萬餘人，目前取得疫苗數無法全面施打。`+\n                        `陳時中：疫苗交貨不如預期`+\n                        `歐盟針對英藥廠與牛津大學所合作之疫苗發布出口管制，恐將衝擊指揮中心原訂今年三月取得疫苗計畫，指揮官陳時中昨表示，尚未接獲歐盟限制疫苗出口的消息，但確實部分藥廠交貨情況不如預期，按照契約若未能履約，則不得出貨給其他國家，因此確實可能延遲出貨。他說，國外爭搶疫苗的情況嚴重，「不是大家在爭，我們就放棄」，將透過所有可能管道持續努力。共495字`\n\n            }\n        ]\n    },\n    action: msg.config.ttsActions.sttOff,\n};\n\nmsg._end_dialogue = false;\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299b7c9510892",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "4a5e01f7d32e358d340d.5aedd2a29512",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "失敗回應",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1206,
        "y": 682,
        "wires": [
            []
        ],
        "func": "msg.messages = {\n    code: 0,\n    message: \"成功\",\n    data: {\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: msg.config.role,\n        content: [\n            {\n                type: 1,\n                text: \"您好，目前系統維護中，請您稍後為您轉接真人客服\"\n            }\n        ]\n    },\n    action: `${msg.config.ttsActions.transfer}#12345`\n};\n\nmsg._end_dialogue = true;\nreturn msg;\n\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299152e510893",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "0e06bf8226bf4c50d14c.5b2e3484f1f0",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "#disconnect",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 728,
        "y": 2106,
        "wires": [
            [
                "c39f9805.bcbf68"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f042992b96510894",
        "breakpoints": [],
        "rules": [
            {
                "t": "eq",
                "p": "reqMsg.action",
                "v": "#disconnect"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "28b2055b18cd54668821.9447facdff81",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "http request",
        "name": "FAQ轉牌卡",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3902.0001525878906,
        "y": 1381.3334293365479,
        "wires": [
            [
                "cdfbf015d6843f1f9ea2.c75f0ae55790"
            ]
        ],
        "_id": "61c99430f04299081c510895",
        "breakpoints": [],
        "method": "use",
        "ret": "obj",
        "url": ""
    },
    {
        "id": "aadc0fc281efc8b30dca.ac8a6ce07c41",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "Input note",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "- session log 使用 `msg` 欄位，語音輸入，使用 `message` 欄位\n- 語音流程，`reqMsg.customerId` 使用 `reqMsg.tel` 帶入",
        "in": [],
        "out": [],
        "x": 731,
        "y": 115,
        "wires": [],
        "_id": "61c99430f042990c52510896",
        "breakpoints": []
    },
    {
        "id": "c21968347b68c74373bd.ce400c0484b3",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "#noInputTimeout",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 740,
        "y": 1943,
        "wires": [
            [
                "f0f31c03fa51384ba9b9.e693e1cdca66"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299c009510897",
        "breakpoints": [],
        "rules": [
            {
                "t": "eq",
                "p": "reqMsg.action",
                "v": "#noInputTimeout"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "5936cec1cf519c1eb83e.419015c823f3",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "是否警示切換服務",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 204,
        "y": 2587,
        "wires": [
            [
                "cca10a9336d8f13b0ed2.98cb989eb5ca"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f042992067510898",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "toConfirmChangeService"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "cca10a9336d8f13b0ed2.98cb989eb5ca",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "詢問是否切換服務",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 487,
        "y": 2587,
        "wires": [
            []
        ],
        "func": "msg.toConfirmChangeOperation = undefined;\nmsg.toConfirmChangeService = undefined;\n\n// 當確定切換，將此次的訊息拋給接續流程\nmsg.systalk.previousMsg = msg.reqMsg;\n\n// 保留詢問切換服務前，bot 的回應，當不切換時使用\nmsg.systalk.pendingPreviousResponse = msg.systalk.previousResponse;\n\n// 不結束對話\nmsg._end_dialogue = false;\n\n// 進入呼叫gateway api流程\nmsg._gateWay = true;\n\n// 設定API URL\nmsg.url = msg.config.apis.gateWay.text;\n\n// 設定http request body\nmsg.reqBody = {\n    chatwebId: msg.reqMsg.chatwebId,\n    channel: msg.config.channel,\n    source: msg.config.source,\n    role: msg.config.role,\n    content: [\n        {\n            textCode: 'CR002'\n        }\n    ]\n};\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042994156510899",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "04ebc3c2143ed8270b30.f1cf3b96247b",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "是否警示切換子服務",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 214,
        "y": 2627,
        "wires": [
            [
                "cca10a9336d8f13b0ed2.98cb989eb5ca"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299beef51089a",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "toConfirmChangeOperation"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "135849a2be645af5379e.7aa51c0a3767",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "是否需警示切換服務",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3689,
        "y": 1247,
        "wires": [
            [
                "a845e6a7f5ea3e6dd3f7.24cbfc960a95"
            ],
            [
                "aa99c6a73bd55cf48537.d26d03d98776"
            ]
        ],
        "func": "const QueueUtils = msg.systalk.utils.QueueUtils;\n\n// 清除聽不懂計數器\nmsg.systalk.cannotRecognizedCounter = 0;\n\n// 需要警示切換服務\nif (msg.systalk.pendingBotQueue && msg.systalk.pendingBotQueue.length > 2 &&\n    QueueUtils.last(msg.systalk.pendingBotQueue) !== QueueUtils.get(msg.systalk.pendingBotQueue, msg.systalk.pendingBotQueue.length - 2) &&\n    QueueUtils.last(msg.systalk.pendingBotQueue) !== msg.config.botType) {\n\n    return [msg, null];\n}\n\nreturn [null, msg];\n",
        "outputs": 2,
        "noerr": 0,
        "_id": "61c99430f042997c1b51089b",
        "breakpoints": []
    },
    {
        "id": "a845e6a7f5ea3e6dd3f7.24cbfc960a95",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "跳警示",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3900,
        "y": 1221,
        "wires": [
            []
        ],
        "func": "// 設定需要做字串比對條件\nmsg.systalk.toConfirmChangeService = true;\nmsg.toConfirmChangeService = true;\n\n// 設定字串資料比對\nmsg.systalk.textComparsion = Object.assign(msg.systalk.textComparsion || {}, {\n    'yes': {\n        values: msg.config.correctText,\n        threshold: msg.config.defauleTextComparsionThreshold\n    },\n    'no': {\n        values: msg.config.wrongText,\n        threshold: msg.config.defauleTextComparsionThreshold\n    }\n});\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299070951089c",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "19517a2555f9267b6874.601c016541a0",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "QUEUE",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "systalk.pendingBotQueue",
        "x": 3660.000244140625,
        "y": 1205,
        "wires": [],
        "_id": "61c99430f04299182351089d",
        "breakpoints": []
    },
    {
        "id": "3b99d83d2155a6b1157d.1fba095d820e",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "設定",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": false,
        "console": "false",
        "complete": "systalk.configParameters",
        "x": 1231,
        "y": 556,
        "wires": [],
        "_id": "61c99430f04299e33351089e",
        "breakpoints": []
    },
    {
        "id": "768d2d21270caa1854d1.064369c7a13b",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "判斷是否重聽",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 670,
        "y": 3511,
        "wires": [
            [
                "db5c59e771dad951aa1d.85e2d3c2e0c4"
            ],
            [
                "fa9dc40cdc69dfa604a1.6bb1ad0682d3"
            ]
        ],
        "func": "// 若需要重聽\nif (msg.toResend) {\n    msg.toResend = undefined;\n    msg.payload = msg.systalk.pendingPreviousResponse || msg.systalk.previousResponse;\n    msg.systalk.pendingPreviousResponse = undefined;\n    return [msg, null];\n} else {\n    return [null, msg];\n}\n",
        "outputs": 2,
        "noerr": 0,
        "_id": "61c99430f04299a08051089f",
        "breakpoints": []
    },
    {
        "id": "e71c8552626168cd4cc9.ba942e3b9df4",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "#music 後，非 #wait",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 749,
        "y": 2016,
        "wires": [
            [
                "881f58b70a9b3d29bf0d.c6ed468d6640"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299d0db5108a0",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "systalk.waitAfterMusic"
            },
            {
                "t": "neq",
                "p": "reqMsg.action",
                "v": "#wait"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "881f58b70a9b3d29bf0d.c6ed468d6640",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "#music",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 983,
        "y": 2016,
        "wires": [
            []
        ],
        "func": "// 不結束對話\nmsg._end_dialogue = false;\n\n// 設定回復使用者訊息\nmsg.messages = {\n    code: 0,\n    message: \"成功\",\n    data: {\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: msg.config.role,\n        content: [\n            {\n                type: 1,\n                text: msg.config.ttsActions.music\n            },\n        ]\n    },\n    action: msg.config.ttsActions.music,\n};\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429971f95108a1",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "7da5086db103b1a123f1.0ebdd9d974d9",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "clear status",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 982,
        "y": 2357,
        "wires": [
            [
                "2c57e4ff6c12c22b6cde.10e80cca1044"
            ]
        ],
        "func": "msg.systalk.waitAfterMusic = undefined;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042997dd45108a2",
        "breakpoints": []
    },
    {
        "id": "d267b80b39166b0f2c68.cded79ee7ebe",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "前兩次聽不懂",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 4437,
        "y": 1088,
        "wires": [
            []
        ],
        "func": "// 不結束對話\nmsg._end_dialogue = false;\n\n// 進入呼叫gateway api\nmsg._gateWay = true;\n\n// 設定url\nmsg.url = msg.config.apis.gateWay.text;\n\n// 設定request body\nmsg.reqBody = {\n    chatwebId: msg.reqMsg.chatwebId,\n    channel: msg.config.channel,\n    source: msg.config.source,\n    role: msg.config.role,\n    content: [{ textCode: 'ST002' }]\n};\n\n// 已將信用卡及銀行服務合併，下列功能取消\n// 判斷目前服務流程，提供不同台詞\n// switch (msg.systalk.service) {\n//     case 'bank':\n//         msg.reqBody.content.push({ textCode: 'ST011' });\n//         break;\n//     case 'creditCard':\n//         msg.reqBody.content.push({ textCode: 'ST010' });\n//         break;\n//     default:\n//         msg.reqBody.content.push({ textCode: 'ST002' });\n//         break;\n// }\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299eee55108a3",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "3d087abb1a792893e19b.59442443bff2",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "第三次聽不懂",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 4437,
        "y": 1128,
        "wires": [
            []
        ],
        "func": "// 不結束對話\nmsg._end_dialogue = false;\n\n// 設定第三次轉真人服務\nmsg.systalk.toAngentCounter = 3;\nmsg._to_customer_service = true;\n\n// 進入呼叫gateway api\nmsg._gateWay = true;\n\n// 設定url\nmsg.url = msg.config.apis.gateWay.text;\n\n// 設定request body\nmsg.reqBody = {\n    chatwebId: msg.reqMsg.chatwebId,\n    channel: msg.config.channel,\n    source: msg.config.source,\n    role: msg.config.role,\n    content: [{ textCode: 'ST003' }]\n};\n\n// 已將信用卡及銀行服務合併，下列功能取消\n// 判斷目前服務流程，提供不同台詞\n// switch (msg.systalk.service) {\n//     case 'bank':\n//         msg.reqBody.content.push({ textCode: 'ST016' });\n//         break;\n//     default:\n//     case 'creditCard':\n//         msg.reqBody.content.push({ textCode: 'ST003' });\n//         break;\n// }\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299f9a15108a4",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "7a3242423277ee10281c.4ea7b4903fe4",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Fallback",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 4227,
        "y": 1107,
        "wires": [
            [
                "d267b80b39166b0f2c68.cded79ee7ebe"
            ],
            [
                "3d087abb1a792893e19b.59442443bff2"
            ]
        ],
        "func": "const MsgUtils = msg.systalk.utils.MsgUtils;\nconst numOfOuts = 2;\n\n// 刪除進入條件\nmsg.doNotUnderstand = undefined;\n\n// 計算聽不懂次數\nmsg.systalk.cannotRecognizedCounter = ++msg.systalk.cannotRecognizedCounter || 1;\n\n// 判斷聽不懂次數\nswitch (msg.systalk.cannotRecognizedCounter) {\n    // 請求轉真人(聽不懂塞三次)\n    case 3:\n        msg.remark = '聽不懂使用者問題';\n        msg.systalk.cannotRecognizedCounter = 0;\n        return MsgUtils.output(msg, 2, numOfOuts);\n    // 回應聽不懂\n    default:\n        return MsgUtils.output(msg, 1, numOfOuts);\n}\n",
        "outputs": 2,
        "noerr": 0,
        "_id": "61c99430f04299c0305108a5",
        "breakpoints": []
    },
    {
        "id": "8e1284c0de3cd0ab9f68.8a51ec8a0b33",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "ChatWeb Utils",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1618,
        "y": 436,
        "wires": [
            [
                "2e51cd541c219af16275.68d5bc8951ea"
            ]
        ],
        "func": "class ChatWebUtils {\n    //由 flow 直接回答\n    createResponse(objectList) {\n        const date = new Date();\n        return {\n            code: 0,\n            msg: \"成功\",\n            data: {\n                channel: msg.reqMsg.channel,\n                source: msg.config.source,\n                role: msg.config.role,\n                content: objectList || [], // [{key: value}, {key: value}]\n                showtime: node.moment(date).tz(\"Asia/Taipei\").format(\"YYYY/MM/DD HH:mm:ss\")\n            }\n        }\n    }\n    //由 flow 直接回答錯誤\n    createErrorResponse(objectList) {\n        const date = new Date();\n        return {\n            code: 99,\n            msg: \"Chatbot error\",\n            data: {\n                channel: msg.reqMsg.channel,\n                source: msg.config.source,\n                role: msg.config.role,\n                content: objectList || [], // [{key: value}, {key: value}]\n                showtime: node.moment(date).tz(\"Asia/Taipei\").format(\"YYYY/MM/DD HH:mm:ss\")\n            }\n        }\n    }\n}\n\nmsg.systalk.utils.ChatWebUtils = new ChatWebUtils();\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429981405108a6",
        "breakpoints": []
    },
    {
        "id": "945801ff09e3ee5fd6bc.f7fc70f91e68",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "過濾語助詞",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1204,
        "y": 1067,
        "wires": [
            [
                "5bd5c998.46ccc8"
            ],
            [
                "824ae64ee808cb0cda2d.5b3005857754"
            ]
        ],
        "func": "const words = msg.reqMsg.msg.split('');\n\n// 將非語助詞的文字重新組成句子\nconst sentence = words.reduce((result, word) => {\n    return msg.config.auxiliaryWords.includes(word) ? result : result + word;\n}, '');\n\n// 設定 msg.text\nmsg.text = sentence;\n\n// 若句子長度為 0 (非句子)\nif (!sentence.length) {\n    return [msg, null];\n}\n\nmsg.payload = sentence;\n\nreturn [null, msg];\n",
        "outputs": 2,
        "noerr": 0,
        "_id": "61c99430f04299233a5108a7",
        "breakpoints": []
    },
    {
        "id": "fd41798fe637e51626fe.7d14d1c8fe7f",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "SecondBot流程",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 200.00000762939453,
        "y": 2411.333185195923,
        "wires": [
            [
                "ba2d29b61e71359065f0.705bf6405d4b"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f042991a075108a8",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_to_second_bot"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "2c57e4ff6c12c22b6cde.10e80cca1044",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Specify secBot API & Req",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1306.6666259765625,
        "y": 2410,
        "wires": [
            [
                "3f814f1476fd3bccd9c4.87e4ec3699d9"
            ],
            [
                "617878b9c567575deae1.65881ed36d60"
            ]
        ],
        "func": "// const ReqChannels = msg.systalk.utils.ReqChannels;\n// const BotUtils = msg.systalk.utils.BotUtils;\nconst ReqMsgTypes = msg.systalk.utils.ReqMsgTypes;\nconst ReqSignals = msg.systalk.utils.ReqSignals;\nconst ConfigCtrl = msg.systalk.utils.ConfigCtrl;\n\nconst MsgUtils = msg.systalk.utils.MsgUtils;\nconst outputNum = 2;\n\nlet reqMsg = msg.nextReqMsg || msg.reqMsg;\nmsg.nextReqMsg = undefined;\n\n// 若為結束流程(Quit)意圖\n// if (msg.reqQuit) { // Defined in \"Determine\" node\n//     reqMsg = {\n//         type: ReqMsgTypes.signal,\n//         signal: ReqSignals.quit\n//     };\n//     msg.reqQuit = null;\n// }\n\nlet secBotReq = {\n    message: reqMsg,\n    sessionId : msg.systalk._session_id,\n    intents: msg.botType ? [ msg.botType ] : [],\n    stored: msg.systalk.stored || null,\n    sessionSalt: msg.systalk.sessionSalt,\n    channel: msg.config.channel,\n    getParametersUrl: msg.systalk.getParametersUrl\n};\n\n// 若有指定 intent （服務台帶出或其他方式指定）\n// if ((msg.systalk.pendingIntent &&\n//         ConfigCtrl.serviceHasOperationAndItem(msg.botType, msg.systalk.pendingIntent.operation, msg.systalk.pendingIntent.item)) ||\n//     msg.botIntent) {\n//     secBotReq.intent = msg.systalk.pendingIntent || msg.botIntent;\n// }\n\n// 若有指定帶入 entity\nif (Array.isArray(msg.botEntities)) {\n    secBotReq.entities = msg.botEntities;\n}\n\n// // 若有核身資訊\n// if (msg.systalk.identity) {\n//     secBotReq.identity = node._.cloneDeep(msg.systalk.identity);\n// }\n// // 若有定位資訊\n// if (msg.systalk.location) {\n//     secBotReq.location = node._.cloneDeep(msg.systalk.location);\n// }\n// // 若有設定值\n// if (msg.systalk.config) {\n//     secBotReq.config = node._.cloneDeep(msg.systalk.config);\n// }\n\nmsg.systalk.location = null;\nmsg.systalk.pendingIntent = null;\nmsg.systalk.pendingEntities = null;\n\nmsg.url = ConfigCtrl.getBotApi(msg.botType);\nmsg.payload = secBotReq;\n\nif (!!msg.url) {\n    msg.method = 'POST';\n    msg.systalk.passToSecondBot = true;\n    return MsgUtils.output(msg, 1, outputNum);\n}\n\nreturn MsgUtils.output(msg, 2, outputNum);\n",
        "outputs": 2,
        "noerr": 0,
        "_id": "61c99430f0429904155108a9",
        "breakpoints": []
    },
    {
        "id": "7309e5547af5691a6e0c.05432dba4fc4",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "report stats",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2869.6666259765625,
        "y": 2366,
        "wires": [
            []
        ],
        "func": "\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429900755108aa",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "617878b9c567575deae1.65881ed36d60",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "缺少子流程的API",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1562.6666259765625,
        "y": 2433,
        "wires": [
            []
        ],
        "func": "msg.error = { status: 200, message: `缺少 botType = ${msg.botType} 的 API` };\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299154f5108ab",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "2b528cdc4cf423be1aa5.524a4e580020",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "unpack",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2659.6666259765625,
        "y": 2366,
        "wires": [
            [
                "69a23947dba5051b0237.33acc6329cd1"
            ],
            [
                "7309e5547af5691a6e0c.05432dba4fc4"
            ],
            [
                "739be4bdb7c73c43299f.6154fc191493"
            ]
        ],
        "func": "const ReplyMsgTypes = msg.systalk.utils.ReplyMsgTypes;\nconst QuitOptions = msg.systalk.utils.QuitOptions;\nconst ReplyMsgCtrl = msg.systalk.utils.ReplyMsgCtrl;\nconst QueueUtils = msg.systalk.utils.QueueUtils;\nconst BotUtils = msg.systalk.utils.BotUtils;\n\nconst numOfOuts = 3;\nconst MsgUtils = msg.systalk.utils.MsgUtils;\n\n// 表示要重新發送訊息\nif (msg.payload.resend) {\n    return MsgUtils.output(msg, 3, numOfOuts);\n}\n\nmsg.messages = msg.payload.messages;\nmsg.error = msg.payload.error;\nmsg.systalk.stored = msg.payload.stored || msg.systalk.stored || null;\n\n// 當為 true, 需要確認 sys.時間 為生日， sys.數字(3~8位數)為病歷號碼\nmsg.systalk.checkUserData = msg.payload.checkUserData || undefined;\n\n// 若為 true, 表示需要詢問是否切換服務(子服務)\nmsg.toConfirmChangeOperation = msg.payload.toConfirmChangeOperation || undefined;\nif (msg.toConfirmChangeOperation) {\n    msg.systalk.textComparsion = Object.assign(msg.systalk.textComparsion || {}, {\n        'yes': { values: msg.config.correctText, threshold: msg.config.defauleTextComparsionThreshold },\n        'no': { values: msg.config.wrongText, threshold: msg.config.defauleTextComparsionThreshold }\n    });\n}\n\n// 表示 STT 使用 ID model\nmsg.useIdModel = msg.payload.useIdModel || undefined;\n\n// 表示要求 STT 使用 Doctor model\nmsg.useDoctorNameModel = msg.payload.useDoctorNameModel || undefined;\n\nmsg.ttsAction = msg.payload.action || null;\nmsg.ttsDomain = msg.payload.domain || null;\nmsg.errorCode = msg.payload.errorCode || null;\n\nmsg._end_dialogue = false;\n\nif (msg.messages && msg.messages &&\n    msg.messages.data &&\n    Array.isArray(msg.messages.data.content) &&\n    Array.isArray(msg.previousMessagesContent)) {\n    msg.messages.data.content = msg.previousMessagesContent.concat(msg.messages.data.content);\n}\n\n// second bot 結束\nif (msg.payload.quit) {\n    // QueueUtils.clear(msg.systalk.pendingBotQueue);\n    QueueUtils.pop(msg.systalk.pendingBotQueue);\n    msg.systalk.passToSecondBot = undefined;\n}\n\n/**\n * 若有要求比對字串，紀錄，下一個 input 進行比對\n * second bot payload 帶有 textComparsion 屬性\n * \n * ```\n * {\n *   values: string[], // 比對的字串\n *   threshold: number // 相似度門檻值 0 ~ 1 之間的 float\n * }\n * ```\n */\nif (msg.payload.textComparsion) {\n    msg.systalk.textComparsion = node._.clone(msg.payload.textComparsion);\n}\n\n// 如果 second bot 傳 #music，需等待直到收到 #wait，否則再次送出 #music\nif (msg.ttsAction === msg.config.ttsActions.music) {\n    msg.systalk.waitAfterMusic = true;\n}\n\n// 若子流程有欲播放音檔\nif (msg.payload.wav) {\n    msg.wav = msg.payload.wav;\n}\n\n// 若是轉真人\nif (msg.ttsAction === msg.config.ttsActions.transfer) {\n    msg.transferNumber = msg.payload.transferNumber;\n    msg.ttsAction = BotUtils.concatTransferAction(msg.payload.transferNumber, msg.wav);\n    msg.systalk.toCustomerService = true; // Report 使用\n}\n\n// 當 second bot 第三次聽不懂（無 matched intent / entity / text )\nif (msg.payload.unknowUserMessage) {\n    return MsgUtils.output(msg, 1, numOfOuts);\n}\n\n// 由 second bot 決定更新 sessionSalt\nif (msg.payload.updateSessionsalt) {\n    msg.systalk.sessionSalt = msg.payload.updateSessionsalt;\n}\n\nreturn MsgUtils.output(msg, 2, numOfOuts);\n",
        "outputs": 3,
        "noerr": 0,
        "_id": "61c99430f042995d1d5108ac",
        "breakpoints": []
    },
    {
        "id": "a953cc2b9fdf234361c2.d76fa044aa76",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Get Analysis from Child",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2429.6666259765625,
        "y": 2367,
        "wires": [
            [
                "2b528cdc4cf423be1aa5.524a4e580020",
                "4ba13586166b469f462b.a4e0bc441af9"
            ]
        ],
        "func": "const analysis = msg.payload.analysis;\n\nif (!!analysis) {\n    if (Array.isArray(analysis.nlu) && analysis.nlu.length) {\n        msg.overall_analysis.nlu = msg.overall_analysis.nlu.concat(analysis.nlu);\n    }\n    if (Array.isArray(analysis.faq) && analysis.faq.length) {\n        msg.overall_analysis.faq = msg.overall_analysis.faq.concat(analysis.faq);\n    }\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042997f195108ad",
        "breakpoints": []
    },
    {
        "id": "8998708840ca471435aa.974c82a6d4ac",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Error/Success",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2182.6666259765625,
        "y": 2388,
        "wires": [
            [
                "a953cc2b9fdf234361c2.d76fa044aa76"
            ],
            [
                "254ea04a2042c1c72d60.b9ee0dadef17"
            ]
        ],
        "func": "// 清除http設定\nmsg.headers = undefined;\nmsg.method = undefined;\nmsg.url = undefined;\n\nif (!node._.isNumber(msg.statusCode) ||\n    msg.statusCode < 200 ||\n    msg.statusCode >= 300) {\n        \n    msg.error = `Request Flow 發生錯誤: ${JSON.stringify(msg.payload)}`\n    msg.statusCode = undefined;\n    return [null, msg];\n}\n\nmsg.statusCode = undefined;\n\nreturn [msg, null];\n",
        "outputs": 2,
        "noerr": 0,
        "_id": "61c99430f0429996195108ae",
        "breakpoints": []
    },
    {
        "id": "254ea04a2042c1c72d60.b9ee0dadef17",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "Error",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2389.6666259765625,
        "y": 2407,
        "wires": [
            []
        ],
        "func": "\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429973115108af",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "46ccf3bab96c4e6bd001.fab57ed113c1",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "!!注意!! 需處理 HTTP 錯誤狀況",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "- HTTP Response 時，可透過 `msg.statusCode` 設定 flow 回應的 status  \n  但，HTTP Request 也會將回應的 status 寫入 `msg.statusCode`  \n  __請清除，若有需要，給予 status code__\n\n- 發生錯誤時，為避免影響後續流程，並告知使用者，可判斷 status  \n  再導向至產生錯誤訊息回應的流程",
        "in": [],
        "out": [],
        "x": 1296.6666259765625,
        "y": 2450,
        "wires": [],
        "_id": "61c99430f04299257c5108b0",
        "breakpoints": []
    },
    {
        "id": "7cf9ffcb8a169b028c64.e6c251cf9d40",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "標記聽不懂與SORT",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "當通過 __undecided__ 節點  \n會將 __message from__ 欄位指定的屬性值，紀錄在 `msg._undecided_msg`  \n並設定 `msg._undecided` 為 `true`\n\nSORT (分類帽) 的排程與 DB匯出會篩選出 `msg._undecided` 為 `true` 的 `msg._undecided_msg` \n",
        "in": [],
        "out": [],
        "x": 2889.6666107177734,
        "y": 2285.6666412353516,
        "wires": [],
        "_id": "61c99430f04299b3625108b1",
        "breakpoints": []
    },
    {
        "id": "5742619b61a978624451.6174d4eee0a8",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "http request",
        "name": "Second Bot",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1943.6666259765625,
        "y": 2388,
        "wires": [
            [
                "8998708840ca471435aa.974c82a6d4ac",
                "31f8e7b92ea6a276a196.86a69e7c0a14"
            ]
        ],
        "_id": "61c99430f0429967235108b2",
        "breakpoints": [],
        "method": "use",
        "ret": "obj",
        "url": ""
    },
    {
        "id": "31f8e7b92ea6a276a196.86a69e7c0a14",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "SecondBot 回應",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 2194.333267211914,
        "y": 2343.999942779541,
        "wires": [],
        "_id": "61c99430f04299d0be5108b3",
        "breakpoints": []
    },
    {
        "id": "3f814f1476fd3bccd9c4.87e4ec3699d9",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "驗證實體",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1542.6666259765625,
        "y": 2388,
        "wires": [
            [
                "082df19983a81a2a1595.02098c396a16"
            ]
        ],
        "func": "// 驗證身分證號 / 居留證號\nconst id = Array.isArray(msg.botEntities) && msg.botEntities.find(x => x.entity === msg.config.entities.idNumber);\nconst datetime = Array.isArray(msg.botEntities) && msg.botEntities.find(x => x.entity === msg.config.entities.datetime);\nconst number = Array.isArray(msg.botEntities) && msg.botEntities.find(x => x.entity === msg.config.entities.number);\n\n// 是否將抓取到相關的實體，視為使用者資訊\nif (msg.systalk.checkUserData) {\n    msg.systalk.checkUserData = undefined;\n    if (id || residentId) {\n    const isValidId = checkID((id && id.text) || (residentId && residentId.text));\n    \n        msg.systalk.stored = msg.systalk.stored || {};\n        let idData = {};\n        if (isValidId) {\n            idData = residentId ? { residentIdNumber: residentId.text, idNumber: null, patNumber: null } : id ? { idNumber: id.text, residentIdNumber: null, patNumber: null } : {}\n        } else {\n            idData = residentId ? { invalidResidentIdNumber: residentId.text, residentIdNumber: false, idNumber: null, patNumber: null } : id ? { invalidIdNumber: id.text, idNumber: false, residentIdNumber: null, patNumber: null } : {}\n        }\n        \n        idData.isValidId = !!isValidId;\n        msg.systalk.stored.userData = node._.assign(msg.systalk.stored.userData || {}, idData);\n    }\n\n    if (!node._.isNil(datetime)) {\n        msg.systalk.stored.userData = node._.assign(msg.systalk.stored.userData || {}, { birth: datetime.info });\n    }\n    if (!node._.isNil(number)) {\n        node.log(parseInt(number.info));\n        const num = parseInt(number.info);\n        const numText = !isNaN(num) ? `${num}` : '';\n        // 病歷號碼為 3~8 位數的流水號\n        const isValidPatNumber = numText.length >= 3 && numText.length <= 8;\n        let patNumberData = { invalidPatNumber: numText, patNumber: numText, isValidId: isValidPatNumber, idNumber: null, residentIdNumber: null };\n        msg.systalk.stored.userData = node._.assign(msg.systalk.stored.userData || {}, patNumberData);\n    }\n}\n\nmsg.payload.stored = msg.systalk.stored;\nreturn msg;\n\n/**\n * 身分證字號驗證\n * \n * reference: https://web.fg.tp.edu.tw/~anny/idtest.htm\n * reference: \"我的E政府 - 檢查使用者身分證\" https://www.cp.gov.tw/portal/cpinit/CheckUID.html\n */\nfunction checkID(value) {\n    const id = value.toUpperCase();\n    const alphabet = \"ABCDEFGHJKLMNPQRSTUVXYWZIO\"; //按照轉換後權數的大小進行排序(A=10,B=11...)\n    // 身分證 & 居留證\n    if (id.match(/^[A-Z](1|2)\\d{8}$/i) === null &&\n        id.match(/^[A-Z][89A-D]\\d{8}$/i) === null) {\n        return false;\n    }\n    const chrarr = id.split(\"\");\n    let num;\n    if (id.match(/^[A-Z][A-D]\\d{8}$/i) !== null) { // 居留證號碼格式\n        num = alphabet.indexOf(chrarr[1]) % 10; //找出第2位英文字母的對應數值，取其個位數\n        chrarr[1] = num;\n    }\n    \n    num = alphabet.indexOf(chrarr[0]) + 10; //找出第1位英文字母的對應數值\n    const unitsDigit = num % 10; // 個位數\n    const tensDigit = ((num - unitsDigit) / 10); // 十位數\n    chrarr[0] = (unitsDigit * 9 + tensDigit); //對應數值之個位數值乘以9，再加上十位數之值\n    //開始進行身分證數字的相乘與累加，依照順序乘上1,87654321\n    let logicsum = chrarr[0];\n    for (let index = 1; index < 9; index++)\n        logicsum += chrarr[index] * (9 - index);\n    //10 - 總和/10之餘數若等於第九碼的檢查碼，則驗證成功\n    if ((10 - logicsum % 10) % 10 == chrarr[9]) {\n        return true;\n    }\n    else {\n        return false;\n    }\n}\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299e4df5108b4",
        "breakpoints": []
    },
    {
        "id": "082df19983a81a2a1595.02098c396a16",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "字串比對結果",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1739.6666259765625,
        "y": 2388,
        "wires": [
            [
                "5742619b61a978624451.6174d4eee0a8",
                "e5b8f58b4a7a11555981.bdd0267e66ac"
            ]
        ],
        "func": "// 如果有需要字串比對\nif (msg.systalk.textComparsion) {\n    msg.payload.textComparsion = msg.systalk.textComparsion;\n    msg.systalk.textComparsion = undefined;\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429988b55108b5",
        "breakpoints": []
    },
    {
        "id": "e5b8f58b4a7a11555981.bdd0267e66ac",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "SecondBot 請求",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 1964.000015258789,
        "y": 2344.333357334137,
        "wires": [],
        "_id": "61c99430f0429914e85108b6",
        "breakpoints": []
    },
    {
        "id": "4ba13586166b469f462b.a4e0bc441af9",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "overall_analysis",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": false,
        "console": "false",
        "complete": "overall_analysis",
        "x": 2680.6666259765625,
        "y": 2308,
        "wires": [],
        "_id": "61c99430f0429903d25108b7",
        "breakpoints": []
    },
    {
        "id": "69a23947dba5051b0237.33acc6329cd1",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "子流程第三次聽不懂",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2899.6666259765625,
        "y": 2325,
        "wires": [
            []
        ],
        "func": "const BotUtils = msg.systalk.utils.BotUtils;\n\nmsg.url = msg.config.apis.gateWay.text;\nmsg.reqBody = {\n    chatwebId: msg.reqMsg.chatwebId,\n    channel: msg.config.channel,\n    source: msg.config.source,\n    role: msg.config.role,\n    content: [\n    ]\n};\n\nif (BotUtils.isInOfficeHours()) {\n    msg.reqBody.content = [{\n        textCode: 'CR011'\n    }];\n    if (!msg.wav) {\n        msg.wav = 'CR011.wav';\n    }\n} else {\n    msg.reqBody.content = [{\n        textCode: 'CR024'\n    }];\n    if (!msg.wav) {\n        msg.wav = 'CR024.wav';\n    }\n}\n\nmsg._gateWay = true;\nmsg._to_customer_service = true;\nmsg._end_dialogue = false;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429965465108b8",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "739be4bdb7c73c43299f.6154fc191493",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "重聽",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2870.333251953125,
        "y": 2494,
        "wires": [
            []
        ],
        "func": "// 刪除重聽流程條件\nmsg._repeat_listen = undefined;\n\nif (msg.systalk.resendCounter === (msg.config.maxResendTimes - 1)) {\n    msg.systalk.resendCounter = 0;\n    msg._to_customer_service = true;\n} else {\n    msg.toResend = true;\n    ++msg.systalk.resendCounter;\n    msg._end_dialogue = false;\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299c2a45108b9",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "ba2d29b61e71359065f0.705bf6405d4b",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "刪除進入子流程條件",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1012,
        "y": 2410.6666666666665,
        "wires": [
            [
                "2c57e4ff6c12c22b6cde.10e80cca1044"
            ]
        ],
        "func": "// 刪除本流程條件\nmsg._to_second_bot = undefined;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042996dbe5108ba",
        "breakpoints": []
    },
    {
        "id": "5187dd84f760bc62b12c.7cd8b9c246aa",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "總機切換服務處理",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1001,
        "y": 2494,
        "wires": [
            [
                "2c57e4ff6c12c22b6cde.10e80cca1044"
            ],
            [
                "739be4bdb7c73c43299f.6154fc191493"
            ]
        ],
        "func": "const BotUtils = msg.systalk.utils.BotUtils;\nconst QueueUtils = msg.systalk.utils.QueueUtils;\n\n// 刪除本流程條件\nmsg._switchboard_change_flow = undefined;\n\nif (msg.systalk.toConfirmChangeService &&\n    msg.systalk.textComparsion) {\n        \n    let nextReqMsg = msg.systalk.previousMsg;\n    msg.systalk.toConfirmChangeService = undefined;\n    msg.systalk.previousMsg = undefined;\n        \n    // 切換，變更 session salt，以觸發子流程重設 session needInfo\n    if (msg.systalk.textComparsion.yes.matched) {\n        msg.nextReqMsg = nextReqMsg;\n        msg.systalk.sessionSalt = BotUtils.generateSalt();\n    }\n    // 當不切換，回上一個流程\n    else if (msg.systalk.textComparsion.no.matched) {\n        QueueUtils.pop(msg.systalk.pendingBotQueue);\n        const lastBot = QueueUtils.last(msg.systalk.pendingBotQueue);\n        msg.botType = lastBot;\n        return [null, msg];\n    }\n}\n\nreturn [msg, null];\n",
        "outputs": 2,
        "noerr": 0,
        "_id": "61c99430f0429951555108bb",
        "breakpoints": []
    },
    {
        "id": "1de6ebd1ba3126f3a2eb.051acab149ce",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "總機切換流程",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 192,
        "y": 2493,
        "wires": [
            [
                "5187dd84f760bc62b12c.7cd8b9c246aa"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f0429999575108bc",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_switchboard_change_flow"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "b4cbfdf4e5bc68fc1076.4b6fa1ab92bb",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "進入重聽",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2662,
        "y": 2564,
        "wires": [
            [
                "739be4bdb7c73c43299f.6154fc191493"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299f9a85108bd",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_repeat_listen"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "8cce897d4f5472518a36.ba65fc6de506",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "進入子流程",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1460.9999771118164,
        "y": 1885.9999513626099,
        "wires": [
            []
        ],
        "func": "// 進入子流程\nmsg._to_second_bot = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042999acf5108be",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "b8754113520b8880b314.237288ef1428",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "進入招呼",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1460.9999771118164,
        "y": 1764.3332805633545,
        "wires": [
            []
        ],
        "func": "// 進入招呼語流程\nmsg._from_start = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429998245108bf",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "40474c0ca03710e95541.94d14f7c0956",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "進入結束",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1461.3332748413086,
        "y": 1805.3331551551819,
        "wires": [
            []
        ],
        "func": "// 進入到結束流程\nmsg._from_end = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042998a585108c0",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "8b3169eeedf5b453fc37.20c17471fee6",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "進入轉真人",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1200.6666069030762,
        "y": 1705.3331565856934,
        "wires": [
            []
        ],
        "func": "msg.remark = '使用者要求轉真人';\n\n// 進入轉真人流程\nmsg._to_customer_service = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042996f235108c1",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "753309ae400e70dec35c.a1bf833b9664",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "招呼",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1200.333251953125,
        "y": 2230.6666259765625,
        "wires": [
            []
        ],
        "func": "// 取消招呼流程\nmsg._from_start = false;\n\n// 不結束對話\nmsg._end_dialogue = false;\n\n// 進入呼叫gateway api流程\nmsg._gateWay = true;\n\n// 設定api url\nmsg.url = msg.config.apis.gateWay.scene;\n\n// 設定request body\nmsg.reqBody = {\n    chatwebId: msg.reqMsg.chatwebId,\n    channel: msg.config.channel,\n    source: msg.config.source,\n    role: msg.config.role,\n    content: [\n        {\n            textCode: 'ST001'\n        }\n    ]\n};\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429929575108c2",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "1b0b243c8c1ae3ce4613.8f73fd8c92a7",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "Request",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 967.5000152587891,
        "y": 488.5000057220459,
        "wires": [],
        "_id": "61c99430f04299c3b25108c3",
        "breakpoints": []
    },
    {
        "id": "b2906c237f6c82281d5c.2779cb2f5411",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "Determine",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3467.333251953125,
        "y": 674,
        "wires": [
            [],
            [],
            [],
            [],
            [],
            [],
            [],
            [],
            [],
            []
        ],
        "func": "const MsgUtils = msg.systalk.utils.MsgUtils;\nconst BotUtils = msg.systalk.utils.BotUtils;\nconst QueueUtils = msg.systalk.utils.QueueUtils;\nconst ConfigCtrl = msg.systalk.utils.ConfigCtrl;\n\nconst lang = msg.systalk.lang;\n\n// 取得NLU, FAQ 結果\nconst faq = msg.firstFAQ;\nconst firstNLUSupport = msg.firstNLUSupport;\nconst firstNLU = msg.firstNLU;\n\n// 取得原點值(fallbackScore),\nconst firstNLUFallbackScore = ConfigCtrl.getFallbackScore(msg.config.names.firstNLU);\nconst firstNLUSupportFallbackScore = ConfigCtrl.getFallbackScore(msg.config.names.firstNLUSupport);\n\n// 取得 threshold\nconst nluThreshold = msg.systalk.passToSecondBot ? msg.config.higherNLUThreshold :ConfigCtrl.getNLUThreshold(msg.config.names.firstNLU);\nconst nluSecondThreshold = ConfigCtrl.getNLUSecondThreshold(msg.config.names.firstNLU);\nconst supportNLUThreshold = ConfigCtrl.getNLUThreshold(msg.config.names.firstNLUSupport);\nconst faqThreshold = msg.systalk.passToSecondBot ?\n    msg.config.higherFAQThreshold :\n    ConfigCtrl.getFAQThreshold(msg.config.names.firstFAQ);\nconst faqSecondThreshold = ConfigCtrl.getFAQSecondThreshold(msg.config.names.firstFAQ);\n\nmsg.botEntities = firstNLU && Array.isArray(firstNLU.entities) ? firstNLU.entities : [];\n\nconst numOfOuts = 10;\nconst faqRedirectCategoryRegex = msg.config.regexes.faqRedirectCategory || /NLU(@([^@]+))(@([^@]+))?(@([^@]+))?/;\n\nlet faqReturns = null;\nlet nluReturns = null;\nlet nextFaqState = null;\nlet isNextFaqRootOrNonLevel = false;\nlet redirectToSecondBot = false;\nlet isSuggestedFAQ = false; // FAQ 選擇答案是否為建議答案(達次門檻值)\nlet isSuggestedNLU = false; // 總機NLU 是否有建議的服務意圖(達次門檻值)\n\nmsg.isSuggestedFAQ = isSuggestedFAQ;\nmsg.isSuggestedNLU = isSuggestedNLU;\n\n// FAQ 處理\nif (faq && faq.results && faq.results.length) {\n    let validResults        = faq.results.filter(item => item.score >= faqThreshold);\n    let stateOfValidResults = validResults.map(item => BotUtils.getFaqAnsState(item, msg.systalk.faqState))\n        .filter(state => state.isValidState);\n    let candidates          = faq.results.filter(item => item.score < faqThreshold &&\n        (node._.isNumber(faqSecondThreshold) && item.score >= faqSecondThreshold));\n    let stateOfCandidates   = candidates.map(item => BotUtils.getFaqAnsState(item, msg.systalk.faqState))\n        .filter(state => state.isValidState);\n        \n    if (!stateOfValidResults.length && !stateOfCandidates.length)\n        msg.systalk.faqState = null;\n    if (!stateOfValidResults.length && !!stateOfCandidates.length) {\n        isSuggestedFAQ = true;\n    }\n    \n    // 若第一個明確對應到的 FAQ 結果，表示要導向 NLU\n    // 設定導向，並要將 FAQ 回答帶過去\n    // (second bot 僅回應 FAQ 回答，並擷取 entity)\n    if (stateOfValidResults.length && isFaqRedirectToNlu(stateOfValidResults[0].originalAns)) {\n        redirectToSecondBot = setFaqRedirectNlu(stateOfValidResults[0].originalAns);\n    }\n    if (!redirectToSecondBot) {\n        let lastFaqState = msg.systalk.faqState;\n        let statesOfResults = isSuggestedFAQ ? stateOfCandidates : stateOfValidResults;\n        \n        let nonLevelState = statesOfResults.find(someState => someState.isNonLevelState);\n        let rootState = statesOfResults.find(someState => someState.isRootState);\n        let descendantState = statesOfResults.find(someState => someState.isDescendantState);\n        let siblingState = statesOfResults.find(someState => someState.isSiblingState);\n        \n        if (lastFaqState) {\n            \n            nextFaqState = descendantState || siblingState ||\n                (rootState && nonLevelState ?\n                 rootState.score >= nonLevelState.score ? rootState : nonLevelState :\n                 rootState || nonLevelState);\n            isNextFaqRootOrNonLevel = !descendantState && !siblingState;\n        }\n        else {\n            // 若同時有 rootState（group） 或 nonLevelState，比分數，再以 rootState 優先\n            nextFaqState = rootState && nonLevelState ?\n                rootState.score >= nonLevelState.score ? rootState : nonLevelState :\n                rootState || nonLevelState;\n            isNextFaqRootOrNonLevel = true;\n        }\n        if (nextFaqState) {\n            msg.FAQ = node._.cloneDeep(nextFaqState.originalAns);\n            if (isSuggestedFAQ) {\n                msg.isSuggestedFAQ = true;\n                // 取得推薦 FAQ 問法\n                const rootOrNonLevels = statesOfResults.filter(someState => {\n                    return (someState.states.some(item => item.index === 1) ||\n                        (!someState.states || !someState.states.length));\n                });\n                msg.suggestedFAQQuestions = [].concat(rootOrNonLevels.map(x => x.originalAns.orig_question));\n            }\n            else {\n              faqReturns = MsgUtils.output(msg, 7, numOfOuts);  \n            }\n        }\n    }\n}\n\nconst faqDecided = faqReturns && !msg.systalk.requestNLU;\n\n// 總機有辨識到 \"重聽\" entity\nif (!redirectToSecondBot &&\n    !faqDecided &&\n    firstNLU &&\n    Array.isArray(firstNLU.entities) &&\n    firstNLU.entities.some(x => x.entity === msg.config.entities.resend)) {\n    \n    nluReturns = MsgUtils.output(msg, 10, numOfOuts);\n} else {\n    msg.systalk.resendCounter = 0;\n}\n\n// 總機可辨識業務\nif (!redirectToSecondBot &&\n    !faqDecided &&\n    firstNLU && firstNLU.intents && firstNLU.intents.length &&\n    firstNLU.intents[0].score !== firstNLUFallbackScore &&\n    !nluReturns) {\n\n    if (firstNLU.intents[0].score >= nluThreshold) {\n        // Quit\n        if (firstNLU.intents[0].intent === msg.config.intents.quit) {\n            \n            if (msg.botType === msg.config.botType) {\n                nluReturns = nluReturns || MsgUtils.output(msg, 4, numOfOuts);\n            }\n            \n            msg.reqQuit = true;\n            node.log(`=== To Quit (${msg.botType}) ===`);\n            nluReturns = nluReturns || MsgUtils.output(msg, 3, numOfOuts);\n        } else if (firstNLU.intents[0].intent === msg.config.intents.end) {\n            QueueUtils.clear(msg.systalk.pendingBotQueue);\n            nluReturns = nluReturns || MsgUtils.output(msg, 4, numOfOuts);\n        } else if (firstNLU.intents[0].intent === msg.config.intents.toAgent) {\n            nluReturns = nluReturns || MsgUtils.output(msg, 8, numOfOuts);\n        } else {\n            // 決定 second bot\n            const gotBotType = msg.firstNLU.intents[0].intent;\n            const gotBot = ConfigCtrl.getBotApi(gotBotType);\n            msg.botType = gotBotType;\n            \n            QueueUtils.push(msg.systalk.pendingBotQueue, gotBotType);\n            nluReturns = nluReturns || MsgUtils.output(msg, 2, numOfOuts);\n        }\n    } else if (node._.isNumber(nluSecondThreshold) && firstNLU.intents.some(x => x.score >= nluSecondThreshold)) {\n        isSuggestedNLU = true;\n        msg.isSuggestedNLU = true;\n        msg.suggestedNLUIntents = firstNLU.intents.filter(x => x.score >= nluSecondThreshold).map(x => x.intent);\n    }\n}\n\n// 總機不知道，服務台辨識出的操作（與項目），目前所在流程沒有，要反問\nif (!redirectToSecondBot &&\n    !faqDecided &&\n    !nluReturns) {\n    if (firstNLUSupport && firstNLUSupport.intents && firstNLUSupport.intents.length &&\n        firstNLUSupport.intents[0].score !== firstNLUSupportFallbackScore) {\n            \n        if (firstNLUSupport.intents[0].score >= supportNLUThreshold) {\n            let supportNLUIntent = firstNLUSupport.intents[0].intent;\n            let operationAndItem = supportNLUIntent.split('-');\n            let operation = operationAndItem[0];\n            let item = operationAndItem[1];\n            \n            let validForLastService = ConfigCtrl.serviceHasOperationAndItem(QueueUtils.last(msg.systalk.pendingBotQueue), operation, item);\n            let validForLastBeforeService = ConfigCtrl.serviceHasOperationAndItem(QueueUtils.getFromLast(msg.systalk.pendingBotQueue, 1), operation, item);\n            \n            // 帶出服務台辨識的操作（與項目）意圖\n            let pendingIntent = { operation: operationAndItem[0], item: operationAndItem[1] ? operationAndItem[1] : null };\n            msg.systalk.supportNLUIntent = supportNLUIntent;\n            msg.systalk.pendingIntent = node._.cloneDeep(pendingIntent);\n            \n            // 若上次與上上次的流程，沒有此操作，反問\n            if (!validForLastService && !validForLastBeforeService) {\n                nluReturns = nluReturns || MsgUtils.output(msg, 6, numOfOuts);\n            }\n            else if (validForLastService) { // 繼續進入上次的流程\n                msg.systalk.pendingIntent = node._.cloneDeep(pendingIntent);\n                nluReturns = nluReturns || MsgUtils.output(msg, 3, numOfOuts);\n            }\n            else if (validForLastBeforeService) { // 要切換到上上次的流程\n                msg.botType = QueueUtils.getFromLast(msg.systalk.pendingBotQueue, 1);\n                msg.systalk.pendingIntent = node._.cloneDeep(pendingIntent);\n                QueueUtils.push(msg.systalk.pendingBotQueue, msg.botType);\n            }\n        }\n    }\n}\n\n// 若總機聽不懂，服務台聽不懂，但有建議 FAQ 或建議的 NLU 意圖\nif (!faqDecided && !nluReturns && ((msg.isSuggestedFAQ && !!msg.FAQ) || (msg.isSuggestedNLU && !!msg.suggestedNLUIntent))) {\n    return MsgUtils.output(msg, 9, numOfOuts);\n}\n\n// 總機不知道，但流程上記錄著上次未結束的 bot\nif (!faqDecided && !nluReturns) {\n    if (msg.botType !== msg.config.botType) {\n        nluReturns = nluReturns || MsgUtils.output(msg, 3, numOfOuts);\n    }\n}\n\n// 即使 NLU 都不知道，需要 requestNLU != true，才能採用 FAQ\nif (faqDecided) {\n    msg.systalk.faqState = nextFaqState;\n    msg.systalk.requestNLU = null;\n    delete msg.systalk.requestNLU;\n    return faqReturns;\n}\n\nif (nluReturns) {\n    msg.systalk.requestNLU = null;\n    msg.systalk.faqState = null;\n    delete msg.systalk.requestNLU;\n    delete msg.systalk.faqState;\n    return nluReturns;\n}\n\n// 都不知道, Fallback\nif (msg.botType === msg.config.botType)\n    return MsgUtils.output(msg, 1, numOfOuts);\nelse\n    return MsgUtils.output(msg, 3, numOfOuts);\n\n/**\n * 該 FAQ 答案是否為指定導向到 NLU\n * @param result FAQ 單項結果\n */\nfunction isFaqRedirectToNlu(result) {\n    if (Array.isArray(result.categories) && result.categories.length) {\n        let found = result.categories.some(item => faqRedirectCategoryRegex.test(item));\n        return found;\n    }\n    return false;\n}\n\n/**\n * 設定 FAQ 需導向 NLU 情形\n * @param ans FAQ 結果\n */\nfunction setFaqRedirectNlu(result) {\n\n    let category = result.categories.find(item => faqRedirectCategoryRegex.test(item));\n    if (!category) {\n        return false;\n    }\n    \n    let ans = result.answer;\n    let prependingMsgs = BotUtils.faqAnsToMessages(ans);\n    if (Array.isArray(prependingMsgs) && prependingMsgs.length) {\n        msg.systalk.prependingMessages = [].concat(prependingMsgs);\n    }\n    \n    let nluIntentTokens = faqRedirectCategoryRegex.exec(category);\n    const serviceIntent = nluIntentTokens[2];\n    const operationIntent = nluIntentTokens[4] || undefined;\n    const itemIntent = nluIntentTokens[6] || undefined;\n    // node.log(operationIntent);\n    // service\n    let gotBot = ConfigCtrl.getBotApi(serviceIntent);\n    msg.botType = serviceIntent;\n    QueueUtils.push(msg.systalk.pendingBotQueue, serviceIntent);\n    // operation & item\n    if (operationIntent) {\n        msg.botIntent = {\n            operation: operationIntent\n        };\n        if (itemIntent) {\n            msg.botIntent.item = itemIntent;\n        }\n    }\n    return true;\n}\n",
        "outputs": 10,
        "noerr": 0,
        "_id": "61c99430f04299c3b25108c4",
        "breakpoints": []
    },
    {
        "id": "8d2b42c5b3ce192553db.e7a04281f19c",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "comment",
        "name": "決定跳轉流程",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "info": "流程判定優先順序：\n\n1. FAQ  \n   - 取得達到門檻值(threshold)的答案  \n   - 上次回覆使用者的語句是否為 FAQ Group 回答？  \n      - 是。  \n        判斷此答案是否為同一個 Group __接續__ 的回答？  \n        是，則回答；否，則取最高分非 Group 的回答或Group 的第一個回答\n      - 否。  \n        取最高分非 Group 的回答或Group 的第一個回答\n   - 若為非 Group 的回答或Group 的第一個回答，語句長度若低於設定值(default 3)，改看 NLU 結果決定。\n   - 若 FAQ 答案帶有類別為 `@NLU@服務@操作` 的格式，會決定跳轉至該服務流程\n\n2. 總機 NLU\n   - 若總機可辨識，根據 intent 導向至服務流程。\n\n3. 服務台 NLU\n   - 服務台可辨識，會得到辨識出的操作（與項目）\n   - 根據 config 中設定的三維意圖 map，查找狀態所屬流程，  \n     目前紀錄狀態，紀錄“上次”與“上上次”的服務流程是誰  \n     依序看兩者，是否包含此操作（與項目）  \n     - 沒有。紀錄操作（與項目），並反問。\n     - 否則，維持原流程。\n\n4. 建議 FAQ 或服務意圖選項\n       \n5. 上次的流程\n   - 若已進入到某個服務流程中，進入同一流程。\n\n6. Fallback\n   - 最後，才會聽不懂。\n\n",
        "in": [],
        "out": [],
        "x": 3467.333251953125,
        "y": 574,
        "wires": [],
        "_id": "61c99430f04299a9f05108c5",
        "breakpoints": []
    },
    {
        "id": "04f8e8512c6b349f980c.89a97bf3ef37",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "switch",
        "name": "parts.key",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 2093.7140922546387,
        "y": 1316.6190128326416,
        "wires": [
            [
                "778bbe1abc3a8c10af0f.663966397981"
            ],
            [
                "934d59e8feea58660d2f.b914e2ffb506"
            ]
        ],
        "outputs": 2,
        "_id": "61c99430f04299e6225108c6",
        "breakpoints": [],
        "property": "parts.key",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "firstNLU",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "firstFAQ",
                "vt": "str"
            }
        ],
        "checkall": "true"
    },
    {
        "id": "1c020491aa5c93c2f1b6.7f693796776d",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "招呼流程 (_from_start)",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 219.99998474121094,
        "y": 2233.333251953125,
        "wires": [
            [
                "753309ae400e70dec35c.a1bf833b9664"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299c6ef5108c7",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_from_start"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "a70c72c56defeb730b82.dbeb4edef7d2",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "undecided",
        "name": "",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 4009,
        "y": 1107,
        "wires": [
            [
                "7a3242423277ee10281c.4ea7b4903fe4"
            ]
        ],
        "_id": "61c99430f042997d4a5108c8",
        "breakpoints": [],
        "msg_variable": "text"
    },
    {
        "id": "fb16a770da459b523e3e.4d40b6697f6a",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "判斷轉真人次數",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 896.5713958740234,
        "y": 2837.1427364349365,
        "wires": [
            [
                "9ca9a106.5f85d"
            ],
            [
                "cbdb834c.2aa6b"
            ],
            [
                "6ba92f5d78a49cc3a556.4b19b96293a1"
            ]
        ],
        "func": "const MsgUtils = msg.systalk.utils.MsgUtils;\nconst numOfOuts = 3;\n\n// 計算轉真人次數\nmsg.systalk.toAngentCounter = ++msg.systalk.toAngentCounter || 1;\n\n// 判斷轉真人次數\nswitch (msg.systalk.toAngentCounter) {\n    case 1:\n        return MsgUtils.output(msg, 1, numOfOuts);\n    case 2:\n        return MsgUtils.output(msg, 2, numOfOuts);\n    default:\n    case 3:\n        return MsgUtils.output(msg, 3, numOfOuts);\n    // 回應聽不懂\n    // default:\n    //     return MsgUtils.output(msg, 1, numOfOuts);\n}\n",
        "outputs": 3,
        "noerr": 0,
        "_id": "61c99430f042995a8e5108c9",
        "breakpoints": []
    },
    {
        "id": "e9a2829ae9b1283640d5.ef83f1af3350",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "第二次觸發轉真人",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1124.7142944335938,
        "y": 2744.142822265625,
        "wires": [
            []
        ],
        "func": "const BotUtils = msg.systalk.utils.BotUtils;\n\n// 不結束對話\nmsg._end_dialogue = false;\n\n// 進入呼叫gateway api流程\nmsg._gateWay = true;\n\n// 設定api url\nmsg.url = msg.config.apis.gateWay.text;\n\n// 設定request body\nmsg.reqBody = {\n    chatwebId: msg.reqMsg.chatwebId,\n    channel: msg.config.channel,\n    source: msg.config.source,\n    role: msg.config.role,\n    content: [{\n        textCode: 'ST005'\n    }]\n};\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429954ee5108ca",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "6ba92f5d78a49cc3a556.4b19b96293a1",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "超過三次觸發轉真人，預設轉信用卡客服",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1194.2857055664062,
        "y": 2879,
        "wires": [
            []
        ],
        "func": "const entities = new Set(msg.payload.entities.map(e => e.key_user_phrase));\n\n// 結束對話\nmsg._end_dialogue = true;\n\n// 設定台詞代碼\nlet textCode = '';\nswitch (entities.size) {\n    // 抓到一個實體\n    case 1:\n        // 比對該實體的意圖\n        switch (entities.values().next().value) {\n            case '銀行':\n                textCode = 'ST015';\n                break;\n            // 預設轉信用卡\n            default:\n            case '信用卡':\n                textCode = 'ST014';\n                break;\n        }\n        break;\n    // 抓到兩個實體\n    case 2:\n        if (entities.has('信用卡')) {\n            textCode = 'ST014';\n        } else if (entities.has('銀行')) {\n            textCode = 'ST015';\n        }\n        break;\n    // 無抓到實體\n    case 0:\n    // 抓到三個實體\n    case 3:\n        // 預設轉信用卡客服\n        textCode = 'ST014';\n        break;\n}\n\n// 進入呼叫gateway api流程\nmsg._gateWay = true;\n\n// 設定api url\nmsg.url = msg.config.apis.gateWay.text;\n\n// 設定request body\nmsg.reqBody = {\n    chatwebId: msg.reqMsg.chatwebId,\n    channel: msg.config.channel,\n    source: msg.config.source,\n    role: msg.config.role,\n    content: [{\n        textCode: textCode\n    }]\n};\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299fa775108cb",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "7b34ab250d69a48a7528.28121dcb01f7",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "設定 stt action",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 193.75,
        "y": 2713,
        "wires": [
            [
                "f2145e22cbb74ea1e03c.57abc3758669"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f0429917f95108cc",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_set_stt_action"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "f2145e22cbb74ea1e03c.57abc3758669",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "state",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 466.75,
        "y": 2713,
        "wires": [
            []
        ],
        "func": "// 刪除條件\nmsg._set_tts_action = false;\n\nconst text = msg.messages.data.content[0].text;\n\n// 設定 ttsAction\nmsg.ttsAction = `#${text.split('#')[1]}`;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299c6645108cd",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "72ea40a2f938dd65fe0b.c80ee8268749",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "Gateway 發生錯誤",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1162.500015258789,
        "y": 3262.5000495910645,
        "wires": [
            []
        ],
        "func": "const ChatWebUtils = msg.systalk.utils.ChatWebUtils;\n\n// 結束對話\nmsg._end_dialogue = true;\n\nmsg.messages = ChatWebUtils.createErrorResponse([\n    {\n        type: 1,\n        text: \"抱歉~小咩正在維護中。\"\n    }\n]);\n\n// msg.messages.data.content.push({\n//     type: 1,\n//     text: \"抱歉~小咩正在維護中，請您稍後再試！是否需為您轉接真人文字客服，由小咩學姊為您服務呢？\"\n// });\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429912aa5108ce",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "b05ba274.41dd1",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "若結束對話",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1370.0000915527344,
        "y": 3218.6666316986084,
        "wires": [
            [
                "68be68d8.155fc8"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f0429954195108cf",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "_end_dialogue"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "68be68d8.155fc8",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "回應訊息新增結束參數",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1583.333333333333,
        "y": 3217.9999999999995,
        "wires": [
            []
        ],
        "func": "msg.messages.data.content[0].text += msg.config.ttsActions.end;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299ca695108d0",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "c39f9805.bcbf68",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "結束，回覆ＯＫ",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 990.0000381469727,
        "y": 2105.8571395874023,
        "wires": [
            []
        ],
        "func": "const ChatWebUtils = msg.systalk.utils.ChatWebUtils;\n\n// 結束對話\nmsg._end_dialogue = true;\n\nmsg.messages = ChatWebUtils.createResponse();\n\nmsg.messages.data.content.push({\n    type: 1,\n    text: \"#ok\"\n});\n\n// 設定 OK 行動\nmsg.ttsAction = msg.config.ttsActions.ok;\n\nreturn msg;\n    ",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299886a5108d1",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "4a4893ea.30d10c",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "#error",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 718,
        "y": 2150,
        "wires": [
            [
                "c39f9805.bcbf68"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f0429973e55108d2",
        "breakpoints": [],
        "rules": [
            {
                "t": "eq",
                "p": "reqMsg.action",
                "v": "#error"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "80fb41b4.22c87",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "發生錯誤轉真人（舊）",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 457.5,
        "y": 3307.5,
        "wires": [
            []
        ],
        "func": "msg.url = msg.config.apis.gateWay.text;\n\nmsg.reqBody = {\n    chatwebId: msg.reqMsg.chatwebId,\n    channel: msg.config.channel,\n    source: msg.config.source,\n    role: msg.config.role,\n    content: [\n        // {\n        //     textCode: 'CR023'\n        // },\n        // {\n        //     textCode: 'CR005'\n        // }\n        {\n            textCode: 'ST014'\n        }\n    ]\n};\n\n// if (Array.isArray(msg.config.extensionNumberMap)) {\n//     msg.ttsAction = `${msg.config.ttsActions.transfer}#${(new Map(msg.config.extensionNumberMap)).get(msg.systalk.stored.userData.hospitalId)}`;\n// }\n\nmsg._gateWay = true;\nmsg._end_dialogue = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299dfcd5108d3",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "426ecf4.36c353",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "ChatWeb Utils",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 407.5,
        "y": 502.5,
        "wires": [
            []
        ],
        "func": "class ChatWebUtils {\n    //由 flow 直接回答\n    createResponse(objectList) {\n        const date = new Date();\n        return {\n            code: 0,\n            msg: \"成功\",\n            data: {\n                channel: msg.reqMsg.channel,\n                source: msg.config.source,\n                role: msg.config.role,\n                content: objectList, // [{key: value}, {key: value}]\n                showtime: node.moment(date).tz(\"Asia/Taipei\").format(\"YYYY/MM/DD HH:mm:ss\")\n            }\n        }\n    }\n    //由 flow 直接回答錯誤\n    createErrorResponse(objectList) {\n        const date = new Date();\n        return {\n            code: 99,\n            msg: \"Chatbot error\",\n            data: {\n                channel: msg.reqMsg.channel,\n                source: msg.config.source,\n                role: msg.config.role,\n                content: objectList, // [{key: value}, {key: value}]\n                showtime: node.moment(date).tz(\"Asia/Taipei\").format(\"YYYY/MM/DD HH:mm:ss\")\n            }\n        }\n    }\n}\n\nmsg.systalk.utils.ChatWebUtils = new ChatWebUtils();\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299ef075108d4",
        "breakpoints": []
    },
    {
        "id": "1490d5b.b6c372a",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "過濾語助詞並設定NLU URL",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 454.66666666666663,
        "y": 2837.666666666666,
        "wires": [
            [
                "5700aa64.175f54"
            ]
        ],
        "func": "const words = msg.reqMsg.msg.split('');\n\n// 將非語助詞的文字重新組成句子\nconst sentence = words.reduce((result, word) => {\n    return msg.config.auxiliaryWords.includes(word) ? result : result + word;\n}, '');\n\nmsg.payload = sentence;\n\nconst ConfigCtrl = msg.systalk.utils.ConfigCtrl;\n\nmsg.method = 'GET';\nmsg.url = ConfigCtrl.getNLUApi(msg.config.names.firstNLU) + encodeURI(msg.payload);\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429901d35108d5",
        "breakpoints": []
    },
    {
        "id": "5700aa64.175f54",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "http request",
        "name": "總機 NLU",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 694,
        "y": 2837.333282470703,
        "wires": [
            [
                "fb16a770da459b523e3e.4d40b6697f6a",
                "52ae47a7.84aed8"
            ]
        ],
        "_id": "61c99430f042997b955108d6",
        "breakpoints": [],
        "method": "use",
        "ret": "obj",
        "url": "",
        "credentials": {
            "user": "",
            "password": ""
        }
    },
    {
        "id": "9ca9a106.5f85d",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "第一次觸發轉真人",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1126,
        "y": 2796,
        "wires": [
            []
        ],
        "func": "const entities = new Set(msg.payload.entities.map(e => e.key_user_phrase));\n\n// 暫存觸發的實體\nmsg.systalk.toAgentEntities = Array.from(entities);\n\n// 不結束對話\nmsg._end_dialogue = false;\n\n// 設定台詞代碼\nlet textCode = '';\nswitch (entities.size) {\n    // 無抓到實體\n    case 0:\n        switch (msg.systalk.service) {\n            case 'bank':\n                msg.systalk.toAgentEntities.push('銀行');\n                textCode = 'ST017';\n                break;\n            case 'creditCard':\n                msg.systalk.toAgentEntities.push('信用卡');\n                textCode = 'ST018';\n                break;\n            default:\n                textCode = 'ST004';\n                break;\n        }\n        break;\n    // 抓到一個實體\n    case 1:\n        // 比對該實體的意圖\n        switch (entities.values().next().value) {\n            case '銀行':\n                textCode = 'ST017';\n                break;\n            case '信用卡':\n                textCode = 'ST018';\n                break;\n            case '客訴':\n                // 判斷目前有無服務的項目\n                switch (msg.systalk.service) {\n                    case 'bank':\n                        // 結束對話\n                        msg._end_dialogue = true;\n                        textCode = 'ST015';\n                        break;\n                    case 'creditCard':\n                        // 結束對話\n                        msg._end_dialogue = true;\n                        textCode = 'ST014';\n                        break;\n                    default:\n                        // 設定轉真人次數2次，用於判斷轉真人意圖\n                        msg.systalk.toAngentCounter = 2;\n                        textCode = 'ST005';\n                        break;\n                }\n                break;\n        }\n        break;\n    // 抓到兩個實體\n    case 2:\n        // 若有包含申訴實體，則直接轉該服務客服\n        if (entities.has('客訴')) {\n            // 結束對話\n            msg._end_dialogue = true;\n            if (entities.has('銀行')) {\n                textCode = 'ST015';\n            } else if (entities.has('信用卡')) {\n                textCode = 'ST014';\n            }\n        // 若不包含申訴，則當作無實體判斷\n        } else {\n            textCode = 'ST004';\n        }\n        break;\n    // 抓到三個實體\n    case 3:\n        // 當作有申訴但無其他實體\n        textCode = 'ST005';\n        break;\n}\n\n// 進入呼叫gateway api流程\nmsg._gateWay = true;\n\n// 設定api url\nmsg.url = msg.config.apis.gateWay.text;\n\n// 設定request body\nmsg.reqBody = {\n    chatwebId: msg.reqMsg.chatwebId,\n    channel: msg.config.channel,\n    source: msg.config.source,\n    role: msg.config.role,\n    content: [{\n        textCode: textCode\n    }]\n};\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429958205108d7",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "cbdb834c.2aa6b",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "第二次觸發轉真人",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1125.7142944335938,
        "y": 2837.142822265625,
        "wires": [
            []
        ],
        "func": "const entities = new Set(msg.payload.entities.map(e => e.key_user_phrase));\n\n// 結束對話\nmsg._end_dialogue = true;\n\n// 設定台詞代碼\nlet textCode = '';\nswitch (entities.size) {\n    // 無抓到實體\n    case 0:\n        // 若第一次以抓到實體\n        if (msg.systalk.toAgentEntities.includes('銀行')) {\n            textCode = 'ST015';\n        } else if (msg.systalk.toAgentEntities.includes('信用卡')) {\n            textCode = 'ST014';\n        } else {\n            // 不結束對話\n            msg._end_dialogue = false;\n            textCode = 'ST005';\n        }\n        break;\n    // 抓到一個實體\n    case 1:\n        // 比對該實體的意圖\n        switch (entities.values().next().value) {\n            case '銀行':\n                textCode = 'ST015';\n                break;\n            // 預設轉信用卡\n            default:\n            case '信用卡':\n                textCode = 'ST014';\n                break;\n        }\n        break;\n    // 抓到兩個實體\n    case 2:\n        if (entities.has('信用卡')) {\n            textCode = 'ST014';\n        } else if (entities.has('銀行')) {\n            textCode = 'ST015';\n        }\n        break;\n    // 抓到三個實體\n    case 3:\n        // 預設轉信用卡客服\n        textCode = 'ST014';\n        break;\n}\n\n// 進入呼叫gateway api流程\nmsg._gateWay = true;\n\n// 設定api url\nmsg.url = msg.config.apis.gateWay.text;\n\n// 設定request body\nmsg.reqBody = {\n    chatwebId: msg.reqMsg.chatwebId,\n    channel: msg.config.channel,\n    source: msg.config.source,\n    role: msg.config.role,\n    content: [{\n        textCode: textCode\n    }]\n};\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299e6be5108d8",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "52ae47a7.84aed8",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "NLU Result",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "payload",
        "x": 884.9999847412109,
        "y": 2792.0000286102295,
        "wires": [],
        "_id": "61c99430f0429929a05108d9",
        "breakpoints": []
    },
    {
        "id": "ff43e276.6099",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "進入聽不懂流程",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3672.333240509033,
        "y": 1106.749921798706,
        "wires": [
            [
                "a70c72c56defeb730b82.dbeb4edef7d2"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f0429902765108da",
        "breakpoints": [],
        "rules": [
            {
                "t": "true",
                "p": "doNotUnderstand"
            }
        ],
        "directlink": false,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "5bd5c998.46ccc8",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "判斷是否有進入服務流程意圖",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3721.6665649414062,
        "y": 1054.6666297912598,
        "wires": [
            [
                "344e774b.b57a48"
            ],
            [
                "a70c72c56defeb730b82.dbeb4edef7d2"
            ],
            [
                "97833f58.378de"
            ]
        ],
        "func": "const MsgUtils = msg.systalk.utils.MsgUtils;\nconst numOfOuts = 3;\n\n// 若已有轉真人計次兩次\n// 且比對到使用者隨回答隨意，預設進入信用卡真人服務\nif (\n    msg.systalk.toAngentCounter === 2 &&\n    msg.config.casualWords.includes(msg.reqMsg.msg)\n) {\n    return MsgUtils.output(msg, 3, numOfOuts);\n}\n\nif (msg.reqMsg.msg.includes('ENGLISH')) {\n    return MsgUtils.output(msg, 1, numOfOuts);\n}\n// else if (msg.reqMsg.msg.includes('銀行')) {\n//     return MsgUtils.output(msg, 2, numOfOuts);\n// } else if (msg.reqMsg.msg.includes('信用卡')) {\n//     return MsgUtils.output(msg, 3, numOfOuts);\n// }\n\n// 若有轉真人計次\nif (msg.systalk.toAngentCounter > 1) {\n    return MsgUtils.output(msg, 3, numOfOuts);\n}\n\n// 預設進入聽不懂流程\nreturn MsgUtils.output(msg, 2, numOfOuts);\n",
        "outputs": 3,
        "noerr": 0,
        "_id": "61c99430f04299567d5108db",
        "breakpoints": []
    },
    {
        "id": "344e774b.b57a48",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "轉英文客服",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 4008.3331298828125,
        "y": 1041.333251953125,
        "wires": [
            []
        ],
        "func": "// 結束對話\nmsg._end_dialogue = true;\n\n// 進入呼叫gateway api流程\nmsg._gateWay = true;\n\n// 設定api url\nmsg.url = msg.config.apis.gateWay.text;\n\n// 設定request body\nmsg.reqBody = {\n    chatwebId: msg.reqMsg.chatwebId,\n    channel: msg.config.channel,\n    source: msg.config.source,\n    role: msg.config.role,\n    content: [\n        {\n            textCode: 'ST013'\n        }\n    ]\n};\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299394b5108dc",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "5032bcc8.440c54",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "debug",
        "name": "First NLU Enitites",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "active": true,
        "console": "false",
        "complete": "botEntities",
        "x": 3683.3333168029785,
        "y": 1004.3333148956299,
        "wires": [],
        "_id": "61c99430f0429903e15108dd",
        "breakpoints": []
    },
    {
        "id": "c2973ff1.3dd4e",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "若為信用卡服務的 ID",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 4371,
        "y": 1404,
        "wires": [
            [
                "233e35b2.b015ba"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299d8555108de",
        "breakpoints": [],
        "rules": [
            {
                "t": "eq",
                "p": "faqId",
                "v": "527"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "b9a6e33d.8a392",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "#noInputTimeout",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 740,
        "y": 1901,
        "wires": [
            [
                "f0f31c03fa51384ba9b9.e693e1cdca66"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f0429981e05108df",
        "breakpoints": [],
        "rules": [
            {
                "t": "eq",
                "p": "reqMsg.message",
                "v": "#noInputTimeout"
            },
            {
                "t": "eq",
                "p": "reqMsg.action",
                "v": ""
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "233e35b2.b015ba",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "信用卡流程處理",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 4613.333511352539,
        "y": 1404.3333892822266,
        "wires": [
            []
        ],
        "func": "// 若已經兩次轉真人\nif (msg.systalk.toAngentCounter === 2) {\n    // 結束對話\n    msg._end_dialogue = true;\n    \n    // 進入呼叫gateway api流程\n    msg._gateWay = true;\n    \n    // 設定api url\n    msg.url = msg.config.apis.gateWay.text;\n    \n    // 設定request body\n    msg.reqBody = {\n        chatwebId: msg.reqMsg.chatwebId,\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: msg.config.role,\n        content: [\n            {\n                textCode: 'ST014'\n            }\n        ]\n    };\n} else {\n    // 不結束對話\n    msg._end_dialogue = false;\n    \n    // 若已在同流程中\n    if (msg.systalk.service === 'creditCard') {\n        // 若已經一次轉真人\n        if (msg.systalk.toAngentCounter === 1) {\n            // 設定轉真人條件\n            msg._to_customer_service = true;\n        }\n    } else {\n        msg.systalk.service = 'creditCard';\n    }\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429901a95108e0",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "ba6879a1.7f1ed8",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "銀行流程處理",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 4613.66650390625,
        "y": 1448.333251953125,
        "wires": [
            []
        ],
        "func": "// 若已經兩次轉真人\nif (msg.systalk.toAngentCounter === 2) {\n    // 結束對話\n    msg._end_dialogue = true;\n    \n    // 進入呼叫gateway api流程\n    msg._gateWay = true;\n    \n    // 設定api url\n    msg.url = msg.config.apis.gateWay.text;\n    \n    // 設定request body\n    msg.reqBody = {\n        chatwebId: msg.reqMsg.chatwebId,\n        channel: msg.config.channel,\n        source: msg.config.source,\n        role: msg.config.role,\n        content: [\n            {\n                textCode: 'ST015'\n            }\n        ]\n    };\n} else {\n    // 不結束對話\n    msg._end_dialogue = false;\n    \n    // 若已在同流程中\n    if (msg.systalk.service === 'bank') {\n        // 若已經一次轉真人\n        if (msg.systalk.toAngentCounter === 1) {\n            // 設定轉真人條件\n            msg._to_customer_service = true;\n        }\n    } else {\n        msg.systalk.service = 'bank';\n    }\n}\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f04299478f5108e1",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "97833f58.378de",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "轉真人",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 4007,
        "y": 1154,
        "wires": [
            []
        ],
        "func": "// 設定轉真人條件\nmsg._to_customer_service = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429902a35108e2",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "d5760c60.736c9",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "enter",
        "name": "若為銀行服務的 ID",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 4360.66650390625,
        "y": 1447.6666259765625,
        "wires": [
            [
                "ba6879a1.7f1ed8"
            ]
        ],
        "outputs": 1,
        "_id": "61c99430f04299803a5108e3",
        "breakpoints": [],
        "rules": [
            {
                "t": "eq",
                "p": "faqId",
                "v": "528"
            }
        ],
        "directlink": true,
        "initialstate": false,
        "fallback": false
    },
    {
        "id": "938efa36.ee78c8",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "處理 FAQ 的特殊案例",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 3928.333240509033,
        "y": 1436.9999752044678,
        "wires": [
            [
                "6d97c8f46235cccceb21.8b69a69f9e36"
            ],
            [
                "112ba12d.65e79f"
            ],
            [
                "5dc03cd6.e845b4"
            ]
        ],
        "func": "const MsgUtils = msg.systalk.utils.MsgUtils;\nconst numOfOuts = 3;\n\n// 判斷不同的 ID 設定不同的字串比對功能\nswitch (msg.faqId) {\n    // 活動登錄\n    case 522:\n    case '522':\n        // 刪除詢問服務計次\n        msg.systalk.askServiceCounter = 0;\n        msg.systalk.textComparsion = {\n            \"線上登錄活動\": {\n                values: [\n                    '線上登錄活動',\n                    '線上登錄',\n                    '登錄活動',\n                    '登錄'\n                ],\n                threshold: 0.8\n            },\n            \"查詢已登錄\": {\n                values: [\n                    '查詢已登錄活動',\n                    '查詢已登錄',\n                    '已登錄',\n                    '查詢'\n                ],\n                threshold: 0.8\n            }\n        };\n        break;\n    // 未滿七歲未成年人開戶\n    case 524:\n    case '524':\n        // 刪除詢問服務計次\n        msg.systalk.askServiceCounter = 0;\n        msg.systalk.textComparsion = {\n            \"未滿七歲未成年人開立台幣帳戶\": {\n                values: [\n                    '未滿七歲未成年人開立台幣帳戶',\n                    '未成年人開立台幣帳戶',\n                    '開立台幣帳戶',\n                    '台幣帳戶',\n                    '台幣'\n                ],\n                threshold: 0.8\n            },\n            \"未滿七歲未成年人開立外幣帳戶\": {\n                values: [\n                    '未滿七歲未成年人開立外幣帳戶',\n                    '未成年人開立外幣帳戶',\n                    '開立外幣帳戶',\n                    '外幣帳戶',\n                    '外幣'\n                ],\n                threshold: 0.8\n            }\n        };\n        break;\n    // 掛失\n    case 525:\n    case '525':\n        // 刪除詢問服務計次\n        msg.systalk.askServiceCounter = 0;\n        msg.systalk.textComparsion = {\n            \"信用卡掛失\": {\n                values: [\n                    '信用卡掛失',\n                    '信用卡'\n                ],\n                threshold: 0.8\n            },\n            \"金融卡掛失\": {\n                values: [\n                    '銀行金融卡掛失',\n                    '銀行金融卡',\n                    '金融卡掛失',\n                    '金融卡'\n                ],\n                threshold: 0.8\n            }\n        };\n        break;\n    // 查詢餘額\n    case 526:\n    case '526':\n        // 刪除詢問服務計次\n        msg.systalk.askServiceCounter = 0;\n        msg.systalk.textComparsion = {\n            \"信用卡可用餘額\": {\n                values: [\n                    '查詢信用卡可用餘額', \n                    '信用卡可用餘額', \n                    '信用卡餘額', \n                    '信用卡查詢餘額', \n                    '查詢信用卡餘額', \n                    '查詢信用卡', \n                    '信用卡'\n                ],\n                threshold: 0.8\n            },\n            \"查詢存款餘額\": {\n                values: [\n                    '查詢存款可用餘額', \n                    '查詢存款餘額', \n                    '查詢存款', \n                    '存款可用餘額', \n                    '存款餘額', \n                    '存款',\n                    '查詢銀行可用餘額', \n                    '查詢銀行餘額', \n                    '查詢銀行', \n                    '銀行可用餘額', \n                    '銀行餘額', \n                    '銀行'\n                ],\n                threshold: 0.8\n            }\n        };\n        break;\n    // 交易查詢\n    case 646:\n    case '646':\n        // 刪除詢問服務計次\n        msg.systalk.askServiceCounter = 0;\n        msg.systalk.textComparsion = {\n            \"信用卡交易查詢\": {\n                values: [\n                    '信用卡交易查詢',\n                    '信用卡交易',\n                    '信用卡查詢',\n                    '信用卡'\n                ],\n                threshold: 0.8\n            },\n            \"存款交易查詢\": {\n                values: [\n                    '存款交易查詢',\n                    '存款交易',\n                    '存款查詢',\n                    '存款'\n                ],\n                threshold: 0.8\n            }\n        };\n        break;\n    case 527:\n    case '527':\n    case 528:\n    case '528':\n        msg.systalk.askServiceCounter = ++msg.systalk.askServiceCounter || 1;\n        \n        // 詢問服務超過三次轉真人或者已經有轉真人次數大於一次\n        if (msg.systalk.askServiceCounter > 3 || msg.systalk.toAngentCounter > 1) {\n            // 設定超過三次轉真人，直接導到信用卡真人\n            msg.systalk.toAngentCounter = 2;\n            return MsgUtils.output(msg, 3, numOfOuts);\n        }\n        \n        // 沒過門檻值轉聽不懂\n        if (msg.systalk.faqState.originalAns.score <= 0.85) {\n            return MsgUtils.output(msg, 2, numOfOuts);\n        }\n        break;\n}\n\nreturn MsgUtils.output(msg, 1, numOfOuts);\n",
        "outputs": 3,
        "noerr": 0,
        "_id": "61c99430f04299293b5108e4",
        "breakpoints": []
    },
    {
        "id": "5551386a.9c5338",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "function",
        "name": "(舊) 字串相似度比對",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 1495,
        "y": 1235,
        "wires": [
            [],
            []
        ],
        "func": "const StringUtils = msg.systalk.utils.StringUtils;\n\n// 若需要字串比對\nif (msg.systalk.textComparsion) {\n    let someMatched = false;\n\n    for (let group in msg.systalk.textComparsion) {\n        const comparedGroup = msg.systalk.textComparsion[group];\n        // skip invalid\n        if (!Array.isArray(comparedGroup.values) ||\n            typeof comparedGroup.threshold !== 'number') {\n            comparedGroup.matched = false;\n            continue;\n        }\n        comparedGroup.matched = \n            comparedGroup.values.some(t => {\n                return StringUtils.stringSimilarity(msg.text, t) >= comparedGroup.threshold;\n            });\n        someMatched = someMatched || comparedGroup.matched;\n    }\n    \n    if (someMatched) {\n        return [null, msg];\n    }\n}\n\nreturn [msg, null];\n",
        "outputs": 2,
        "noerr": 0,
        "_id": "61c99430f042995a735108e5",
        "breakpoints": []
    },
    {
        "id": "112ba12d.65e79f",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "進入聽不懂流程",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 4150.000061035156,
        "y": 1466.0000228881836,
        "wires": [
            []
        ],
        "func": "// 設定聽不懂\nmsg.doNotUnderstand = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f042990de15108e6",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    },
    {
        "id": "5dc03cd6.e845b4",
        "appId": "40ff4b411bf8bc6ae12a.d1f033bfaa30",
        "type": "state",
        "name": "轉真人",
        "z": "48554f44c5442a2f7260.950bc6e28b2e",
        "in": [],
        "out": [],
        "x": 4139.500061035156,
        "y": 1508.5000228881836,
        "wires": [
            []
        ],
        "func": "// 設定轉真人條件\nmsg._to_customer_service = true;\n\nreturn msg;\n",
        "outputs": 1,
        "noerr": 0,
        "_id": "61c99430f0429900835108e7",
        "breakpoints": [],
        "response": "",
        "finalstate": false,
        "requestUserInput": false
    }
]